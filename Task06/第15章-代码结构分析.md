# ç¬¬15ç«  - èµ›åšå°é•‡ä»£ç ç»“æ„åˆ†æ

**æ—¥æœŸ**: 2025-12-27  
**å­¦ä¹ è€…**: Franke Chen  
**é¡¹ç›®ä½ç½®**: `Task06\official-code\code\chapter15\Helloagents-AI-Town`

---

## ğŸ“¦ é¡¹ç›®æ•´ä½“ç»“æ„

```
Helloagents-AI-Town/
â”‚
â”œâ”€â”€ backend/                      # Python åç«¯æœåŠ¡ (FastAPI)
â”‚   â”œâ”€â”€ main.py                  # FastAPI ä¸»ç¨‹åº â­
â”‚   â”œâ”€â”€ agents.py                # NPC Agent ç³»ç»Ÿ â­â­â­
â”‚   â”œâ”€â”€ relationship_manager.py  # å¥½æ„Ÿåº¦ç®¡ç† â­â­
â”‚   â”œâ”€â”€ state_manager.py         # çŠ¶æ€ç®¡ç†å™¨ â­â­
â”‚   â”œâ”€â”€ batch_generator.py       # æ‰¹é‡å¯¹è¯ç”Ÿæˆ â­â­
â”‚   â”œâ”€â”€ logger.py                # æ—¥å¿—ç³»ç»Ÿ â­
â”‚   â”œâ”€â”€ config.py                # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ models.py                # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ requirements.txt         # Python ä¾èµ–
â”‚   â”œâ”€â”€ .env.example             # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚   â””â”€â”€ memory_data/             # è®°å¿†æ•°æ®å­˜å‚¨
â”‚
â”œâ”€â”€ helloagents-ai-town/         # Godot æ¸¸æˆå‰ç«¯
â”‚   â”œâ”€â”€ scenes/                  # æ¸¸æˆåœºæ™¯ â­â­â­
â”‚   â”‚   â”œâ”€â”€ main.tscn           # ä¸»åœºæ™¯
â”‚   â”‚   â”œâ”€â”€ player.tscn         # ç©å®¶åœºæ™¯
â”‚   â”‚   â”œâ”€â”€ npc.tscn            # NPC æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ dialogue_ui.tscn    # å¯¹è¯ç•Œé¢
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/                 # GDScript è„šæœ¬ â­â­â­
â”‚   â”‚   â”œâ”€â”€ config.gd           # å…¨å±€é…ç½®
â”‚   â”‚   â”œâ”€â”€ api_client.gd       # API å®¢æˆ·ç«¯ â­â­
â”‚   â”‚   â”œâ”€â”€ player.gd           # ç©å®¶æ§åˆ¶ â­â­
â”‚   â”‚   â”œâ”€â”€ npc.gd              # NPC è¡Œä¸º â­â­
â”‚   â”‚   â”œâ”€â”€ dialogue_ui.gd      # å¯¹è¯ UI â­â­
â”‚   â”‚   â”œâ”€â”€ main.gd             # ä¸»åœºæ™¯é€»è¾‘ â­
â”‚   â”‚   â””â”€â”€ README.md           # è„šæœ¬è¯´æ˜æ–‡æ¡£
â”‚   â”‚
â”‚   â”œâ”€â”€ assets/                  # æ¸¸æˆèµ„æº
â”‚   â”‚   â”œâ”€â”€ sprites/            # ç²¾çµå›¾
â”‚   â”‚   â”œâ”€â”€ sounds/             # éŸ³æ•ˆ
â”‚   â”‚   â””â”€â”€ fonts/              # å­—ä½“
â”‚   â”‚
â”‚   â””â”€â”€ project.godot            # Godot é¡¹ç›®é…ç½®
â”‚
â””â”€â”€ æ–‡æ¡£/
    â”œâ”€â”€ README.md                # é¡¹ç›®è¯´æ˜
    â”œâ”€â”€ SETUP_GUIDE.md          # å®‰è£…é…ç½®æŒ‡å—
    â”œâ”€â”€ DIALOGUE_LOG_GUIDE.md   # æ—¥å¿—ç³»ç»ŸæŒ‡å—
    â”œâ”€â”€ AFFINITY_SYSTEM_GUIDE.md # å¥½æ„Ÿåº¦ç³»ç»ŸæŒ‡å—
    â””â”€â”€ MEMORY_SYSTEM_GUIDE.md   # è®°å¿†ç³»ç»ŸæŒ‡å—
```

---

## ğŸ åç«¯ä»£ç ç»“æ„ï¼ˆPython + FastAPIï¼‰

### 1. main.py - FastAPI ä¸»ç¨‹åº â­
**æ ¸å¿ƒèŒè´£**: API æœåŠ¡å…¥å£ã€è·¯ç”±å®šä¹‰ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å…³é”®ä»£ç **:
```python
# FastAPI åº”ç”¨åˆ›å»º
app = FastAPI(
    title="èµ›åšå°é•‡ AI NPC ç³»ç»Ÿ",
    version="1.0.0",
    lifespan=lifespan  # ç”Ÿå‘½å‘¨æœŸç®¡ç†
)

# ä¸»è¦ API ç«¯ç‚¹
@app.get("/")                    # æœåŠ¡ä¿¡æ¯
@app.get("/health")              # å¥åº·æ£€æŸ¥
@app.get("/npcs")                # è·å– NPC åˆ—è¡¨
@app.post("/chat")               # ä¸ NPC å¯¹è¯ â­â­â­
@app.get("/npcs/status")         # è·å– NPC çŠ¶æ€ â­â­
@app.post("/npcs/status/refresh") # å¼ºåˆ¶åˆ·æ–°çŠ¶æ€
```

**é‡è¦ç‰¹æ€§**:
- CORS é…ç½®ï¼šæ”¯æŒè·¨åŸŸè®¿é—®
- ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šè‡ªåŠ¨å¯åŠ¨/åœæ­¢çŠ¶æ€æ›´æ–°
- å…¨å±€å•ä¾‹ï¼šNPC ç®¡ç†å™¨å’ŒçŠ¶æ€ç®¡ç†å™¨

---

### 2. agents.py - NPC Agent ç³»ç»Ÿ â­â­â­
**æ ¸å¿ƒèŒè´£**: åˆ›å»ºå’Œç®¡ç† NPC æ™ºèƒ½ä½“

**NPC è§’è‰²é…ç½®**:
```python
NPC_ROLES = {
    "å¼ ä¸‰": {
        "title": "Pythonå·¥ç¨‹å¸ˆ",
        "personality": "æŠ€æœ¯å®…ï¼Œå–œæ¬¢è®¨è®ºç®—æ³•å’Œæ¡†æ¶",
        "expertise": "å¤šæ™ºèƒ½ä½“ç³»ç»Ÿã€HelloAgentsæ¡†æ¶ã€Pythonå¼€å‘",
        "style": "ç®€æ´ä¸“ä¸šï¼Œå–œæ¬¢ç”¨æŠ€æœ¯æœ¯è¯­ï¼Œå¶å°”åæ§½bug"
    },
    "æå››": {
        "title": "äº§å“ç»ç†",
        "personality": "å¤–å‘å¥è°ˆï¼Œå–„äºæ²Ÿé€šåè°ƒ",
        "expertise": "éœ€æ±‚åˆ†æã€äº§å“è§„åˆ’ã€ç”¨æˆ·ä½“éªŒ",
        "style": "å‹å¥½çƒ­æƒ…ï¼Œå–„äºå¼•å¯¼å¯¹è¯ï¼Œå–œæ¬¢ç”¨æ¯”å–»"
    },
    "ç‹äº”": {
        "title": "UIè®¾è®¡å¸ˆ",
        "personality": "ç»†è…»æ•æ„Ÿï¼Œæ³¨é‡ç¾æ„Ÿ",
        "expertise": "ç•Œé¢è®¾è®¡ã€äº¤äº’è®¾è®¡ã€è§†è§‰å‘ˆç°",
        "style": "ä¼˜é›…ç®€æ´ï¼Œå–œæ¬¢ç”¨è‰ºæœ¯åŒ–çš„è¡¨è¾¾"
    }
}
```

**æ ¸å¿ƒç±»**:
```python
class NPCAgentManager:
    def __init__(self):
        # åˆå§‹åŒ– LLM
        self.llm = HelloAgentsLLM()
        
        # åˆå§‹åŒ–è®°å¿†ç®¡ç†å™¨
        self.memory_manager = MemoryManager(...)
        
        # åˆå§‹åŒ–å¥½æ„Ÿåº¦ç®¡ç†å™¨
        self.relationship_manager = RelationshipManager()
        
        # åˆ›å»ºæ¯ä¸ª NPC çš„ Agent
        self.agents = {}
        for name, role in NPC_ROLES.items():
            self.agents[name] = self._create_agent(name, role)
    
    def chat(self, npc_name, player_name, message):
        """ä¸ NPC å¯¹è¯"""
        # 1. æ£€ç´¢ç›¸å…³è®°å¿†
        # 2. è·å–å½“å‰å¥½æ„Ÿåº¦
        # 3. æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«è®°å¿†å’Œå¥½æ„Ÿåº¦ï¼‰
        # 4. è°ƒç”¨ Agent ç”Ÿæˆå›å¤
        # 5. åˆ†ææƒ…æ„Ÿï¼Œæ›´æ–°å¥½æ„Ÿåº¦
        # 6. ä¿å­˜åˆ°è®°å¿†ç³»ç»Ÿ
        pass
```

**è®¾è®¡äº®ç‚¹**:
- âœ… æ¯ä¸ª NPC ç‹¬ç«‹çš„ Agent
- âœ… è®°å¿†ç³»ç»Ÿé›†æˆï¼ˆçŸ­æœŸ + é•¿æœŸï¼‰
- âœ… å¥½æ„Ÿåº¦åŠ¨æ€å½±å“æç¤ºè¯
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•

---

### 3. relationship_manager.py - å¥½æ„Ÿåº¦ç®¡ç† â­â­
**æ ¸å¿ƒèŒè´£**: ç®¡ç†ç©å®¶ä¸ NPC çš„å¥½æ„Ÿåº¦

**äº”çº§å¥½æ„Ÿåº¦ç³»ç»Ÿ**:
```python
AFFINITY_LEVELS = {
    "é™Œç”Ÿ": (0, 20),    # ç¤¼è²Œç–è¿œ
    "ç†Ÿæ‚‰": (21, 40),   # è‡ªç„¶äº¤æµ
    "å‹å¥½": (41, 60),   # ä¸»åŠ¨å…³å¿ƒ
    "äº²å¯†": (61, 80),   # å……æ»¡ä¿¡ä»»
    "æŒšå‹": (81, 100)   # æ— è¯ä¸è°ˆ
}
```

**å¥½æ„Ÿåº¦è®¡ç®—**:
```python
def update_affinity(self, npc_name, player_name, attitude):
    """æ›´æ–°å¥½æ„Ÿåº¦"""
    change = {
        "friendly": +5,      # å‹å¥½æ€åº¦
        "neutral": +2,       # ä¸­ç«‹æ€åº¦
        "unfriendly": -3     # ä¸å‹å¥½æ€åº¦
    }[attitude]
    
    # æ›´æ–°åˆ†æ•°å¹¶ä¿å­˜
    current = self.get_affinity(npc_name, player_name)
    new_score = max(0, min(100, current + change))
    self.affinities[(npc_name, player_name)] = new_score
```

**è®¾è®¡äº®ç‚¹**:
- âœ… SQLite æŒä¹…åŒ–å­˜å‚¨
- âœ… LLM è‡ªåŠ¨åˆ†ææƒ…æ„Ÿ
- âœ… å¥½æ„Ÿåº¦ç­‰çº§åˆ’åˆ†
- âœ… å†å²è®°å½•æŸ¥è¯¢

---

### 4. state_manager.py - çŠ¶æ€ç®¡ç†å™¨ â­â­
**æ ¸å¿ƒèŒè´£**: å®šæ—¶æ›´æ–° NPC çŠ¶æ€ï¼Œæä¾›ç¼“å­˜

**å·¥ä½œåŸç†**:
```python
class StateManager:
    async def start(self):
        """å¯åŠ¨å®šæ—¶æ›´æ–°"""
        asyncio.create_task(self._update_loop())
    
    async def _update_loop(self):
        """æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡"""
        while self.running:
            # æ‰¹é‡ç”Ÿæˆæ‰€æœ‰ NPC çš„å¯¹è¯
            dialogues = batch_generator.generate_batch()
            
            # æ›´æ–°ç¼“å­˜
            self.cached_dialogues = dialogues
            self.last_update = datetime.now()
            
            # ç­‰å¾…ä¸‹æ¬¡æ›´æ–°
            await asyncio.sleep(self.update_interval)
```

**è®¾è®¡äº®ç‚¹**:
- âœ… å¼‚æ­¥å®šæ—¶æ›´æ–°
- âœ… æ‰¹é‡ç”Ÿæˆå¯¹è¯ï¼ˆé™ä½æˆæœ¬ 66%ï¼‰
- âœ… ç¼“å­˜æœºåˆ¶ï¼ˆå‡å°‘ API è°ƒç”¨ï¼‰
- âœ… ä¸‹æ¬¡æ›´æ–°å€’è®¡æ—¶

---

### 5. batch_generator.py - æ‰¹é‡å¯¹è¯ç”Ÿæˆ â­â­
**æ ¸å¿ƒèŒè´£**: ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰ NPC çš„è‡ªä¸»å¯¹è¯

**æ‰¹é‡ç”ŸæˆåŸç†**:
```python
def generate_batch():
    """æ‰¹é‡ç”Ÿæˆæ‰€æœ‰ NPC çš„å¯¹è¯"""
    prompt = f"""
    è¯·ä¸ºä»¥ä¸‹ 3 ä¸ª NPC åˆ†åˆ«ç”Ÿæˆä¸€å¥è‡ªä¸»å¯¹è¯ï¼š
    
    1. å¼ ä¸‰ï¼ˆPythonå·¥ç¨‹å¸ˆï¼‰- å½“å‰åœ¨å†™ä»£ç 
    2. æå››ï¼ˆäº§å“ç»ç†ï¼‰- å½“å‰åœ¨æ•´ç†éœ€æ±‚
    3. ç‹äº”ï¼ˆUIè®¾è®¡å¸ˆï¼‰- å½“å‰åœ¨å–å’–å•¡
    
    è¯·è¿”å› JSON æ ¼å¼ï¼š
    {{
        "å¼ ä¸‰": "...",
        "æå››": "...",
        "ç‹äº”": "..."
    }}
    """
    
    # ä¸€æ¬¡ LLM è°ƒç”¨ç”Ÿæˆæ‰€æœ‰å¯¹è¯
    response = llm.generate(prompt)
    dialogues = json.loads(response)
    return dialogues
```

**æˆæœ¬å¯¹æ¯”**:
```
ä¼ ç»Ÿæ–¹å¼: 3 ä¸ª NPC Ã— æ¯ 30 ç§’ = 360 æ¬¡è°ƒç”¨/å°æ—¶
æ‰¹é‡æ–¹å¼: 1 æ¬¡è°ƒç”¨ Ã— æ¯ 30 ç§’ = 120 æ¬¡è°ƒç”¨/å°æ—¶
æˆæœ¬é™ä½: 66% ğŸ‰
```

---

## ğŸ® å‰ç«¯ä»£ç ç»“æ„ï¼ˆGodot + GDScriptï¼‰

### 1. config.gd - å…¨å±€é…ç½® â­
**æ ¸å¿ƒèŒè´£**: å…¨å±€å¸¸é‡å’Œå·¥å…·å‡½æ•°

```gdscript
extends Node

# API é…ç½®
const API_BASE_URL = "http://localhost:8000"

# æ¸¸æˆé…ç½®
const PLAYER_SPEED = 200.0
const NPC_STATUS_UPDATE_INTERVAL = 30.0

# æ—¥å¿—å·¥å…·
func log_info(message: String):
    print("[INFO] " + message)
```

---

### 2. api_client.gd - API å®¢æˆ·ç«¯ â­â­
**æ ¸å¿ƒèŒè´£**: ä¸åç«¯ API é€šä¿¡

```gdscript
extends Node

# ä¿¡å·å®šä¹‰
signal chat_response_received(npc_name, message)
signal chat_error(error_message)
signal npc_status_received(dialogues)

# å‘é€å¯¹è¯
func send_chat(npc_name: String, message: String):
    var http = HTTPRequest.new()
    add_child(http)
    
    var body = JSON.stringify({
        "npc_name": npc_name,
        "message": message
    })
    
    http.request(
        API_BASE_URL + "/chat",
        ["Content-Type: application/json"],
        HTTPClient.METHOD_POST,
        body
    )
    
    http.request_completed.connect(_on_chat_completed)

# å¤„ç†å“åº”
func _on_chat_completed(result, response_code, headers, body):
    if response_code == 200:
        var json = JSON.parse_string(body.get_string_from_utf8())
        emit_signal("chat_response_received", 
                    json.npc_name, json.message)
    else:
        emit_signal("chat_error", "è¯·æ±‚å¤±è´¥")
```

**è®¾è®¡äº®ç‚¹**:
- âœ… ç‹¬ç«‹çš„ HTTPRequest èŠ‚ç‚¹
- âœ… ä¿¡å·æœºåˆ¶é€šçŸ¥å“åº”
- âœ… å¼‚æ­¥ä¸é˜»å¡æ¸¸æˆ
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶

---

### 3. player.gd - ç©å®¶æ§åˆ¶ â­â­
**æ ¸å¿ƒèŒè´£**: å¤„ç†ç©å®¶ç§»åŠ¨å’Œäº¤äº’

```gdscript
extends CharacterBody2D

@export var speed: float = 200.0
var nearby_npc: Node = null

func _physics_process(delta):
    # è·å–è¾“å…¥æ–¹å‘
    var direction = Input.get_vector("ui_left", "ui_right", 
                                     "ui_up", "ui_down")
    
    # ç§»åŠ¨ç©å®¶
    velocity = direction * speed
    move_and_slide()
    
    # æ›´æ–°åŠ¨ç”»
    update_animation(direction)
    
    # E é”®äº¤äº’
    if Input.is_action_just_pressed("interact") and nearby_npc:
        interact_with_npc()

func interact_with_npc():
    """ä¸ NPC äº¤äº’"""
    get_tree().call_group("dialogue_system", 
                          "start_dialogue", 
                          nearby_npc.npc_name)
```

**è®¾è®¡äº®ç‚¹**:
- âœ… WASD/æ–¹å‘é”®ç§»åŠ¨
- âœ… 4 æ–¹å‘åŠ¨ç”»
- âœ… äº¤äº’æ£€æµ‹
- âœ… éŸ³æ•ˆæ’­æ”¾

---

### 4. npc.gd - NPC è¡Œä¸º â­â­
**æ ¸å¿ƒèŒè´£**: NPC å·¡é€»å’Œäº¤äº’

```gdscript
extends Node2D

@export var npc_name: String = "å¼ ä¸‰"
@export var npc_title: String = "Pythonå·¥ç¨‹å¸ˆ"
@export var patrol_range: float = 100.0

var spawn_position: Vector2
var is_patrolling: bool = true

func _ready():
    spawn_position = global_position
    start_patrol()

func start_patrol():
    """å¼€å§‹å·¡é€»"""
    while is_patrolling:
        # éšæœºé€‰æ‹©ç›®æ ‡ç‚¹
        var target = spawn_position + Vector2(
            randf_range(-patrol_range, patrol_range),
            randf_range(-patrol_range, patrol_range)
        )
        
        # ç§»åŠ¨åˆ°ç›®æ ‡
        await move_to(target)
        
        # ç­‰å¾…éšæœºæ—¶é—´
        await get_tree().create_timer(randf_range(2, 5)).timeout

func update_dialogue(text: String):
    """æ›´æ–°å¯¹è¯æ°”æ³¡"""
    $DialogueLabel.text = text
    $DialogueLabel.visible = true
    
    # 5 ç§’åéšè—
    await get_tree().create_timer(5).timeout
    $DialogueLabel.visible = false
```

**è®¾è®¡äº®ç‚¹**:
- âœ… éšæœºå·¡é€»
- âœ… Area2D äº¤äº’æ£€æµ‹
- âœ… å¯¹è¯æ°”æ³¡æ˜¾ç¤º
- âœ… çŠ¶æ€ç®¡ç†

---

### 5. dialogue_ui.gd - å¯¹è¯ UI â­â­
**æ ¸å¿ƒèŒè´£**: å¯¹è¯ç•Œé¢ç®¡ç†

```gdscript
extends CanvasLayer

var current_npc: String = ""
var api: Node

func _ready():
    # è·å– API å®¢æˆ·ç«¯
    api = get_node("/root/APIClient")
    
    # è¿æ¥ä¿¡å·
    api.chat_response_received.connect(_on_response)
    
    # éšè—å¯¹è¯æ¡†
    hide()

func start_dialogue(npc_name: String):
    """å¼€å§‹å¯¹è¯"""
    current_npc = npc_name
    $Panel/NPCName.text = npc_name
    
    # æ˜¾ç¤ºå¯¹è¯æ¡†
    show()
    
    # ç¦ç”¨ç©å®¶ç§»åŠ¨
    get_tree().call_group("player", "disable_movement")

func send_message():
    """å‘é€æ¶ˆæ¯"""
    var message = $Panel/PlayerInput.text
    
    if message.length() > 0:
        # æ˜¾ç¤ºç©å®¶æ¶ˆæ¯
        append_dialogue("ç©å®¶", message)
        
        # å‘é€åˆ°åç«¯
        api.send_chat(current_npc, message)
        
        # æ¸…ç©ºè¾“å…¥æ¡†
        $Panel/PlayerInput.text = ""

func _on_response(npc_name: String, message: String):
    """æ”¶åˆ° NPC å›å¤"""
    append_dialogue(npc_name, message)

func append_dialogue(speaker: String, text: String):
    """æ·»åŠ å¯¹è¯å†å²"""
    var dialogue_text = $Panel/DialogueText
    dialogue_text.text += "[b]" + speaker + ":[/b] " + text + "\n\n"
```

**è®¾è®¡äº®ç‚¹**:
- âœ… å¯Œæ–‡æœ¬æ˜¾ç¤º
- âœ… å¯¹è¯å†å²è®°å½•
- âœ… å¼‚æ­¥å“åº”ç­‰å¾…
- âœ… è¾“å…¥éªŒè¯

---

### 6. main.gd - ä¸»åœºæ™¯é€»è¾‘ â­
**æ ¸å¿ƒèŒè´£**: æ•´åˆæ‰€æœ‰ç³»ç»Ÿ

```gdscript
extends Node2D

var api: Node

func _ready():
    # è·å– API å®¢æˆ·ç«¯
    api = get_node("/root/APIClient")
    
    # è¿æ¥ä¿¡å·
    api.npc_status_received.connect(_on_status_update)
    
    # å¯åŠ¨å®šæ—¶æ›´æ–°
    start_status_updates()

func start_status_updates():
    """å¯åŠ¨ NPC çŠ¶æ€æ›´æ–°"""
    while true:
        api.get_npc_status()
        await get_tree().create_timer(30).timeout

func _on_status_update(dialogues: Dictionary):
    """æ›´æ–°æ‰€æœ‰ NPC çš„å¯¹è¯æ°”æ³¡"""
    for npc_name in dialogues.keys():
        var npc_node = get_npc_node(npc_name)
        if npc_node:
            npc_node.update_dialogue(dialogues[npc_name])
```

---

## ğŸ”— å‰åç«¯é€šä¿¡æµç¨‹

### å®Œæ•´å¯¹è¯æµç¨‹
```
1. ç©å®¶èµ°åˆ° NPC é™„è¿‘
   â†“
2. npc.gd æ£€æµ‹åˆ°ç©å®¶è¿›å…¥ Area2D
   â†“
3. æ˜¾ç¤º "E to talk" æç¤º
   â†“
4. ç©å®¶æŒ‰ E é”®
   â†“
5. player.gd è°ƒç”¨ interact_with_npc()
   â†“
6. å‘é€ä¿¡å·åˆ° dialogue_system ç»„
   â†“
7. dialogue_ui.gd æ”¶åˆ°ä¿¡å·ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
   â†“
8. ç©å®¶è¾“å…¥æ¶ˆæ¯ï¼Œç‚¹å‡»å‘é€
   â†“
9. dialogue_ui.gd è°ƒç”¨ api_client.send_chat()
   â†“
10. api_client.gd åˆ›å»º HTTPRequest
    â†“
11. å‘é€ POST è¯·æ±‚åˆ° /chat æ¥å£
    â†“
12. FastAPI main.py æ”¶åˆ°è¯·æ±‚
    â†“
13. agents.py çš„ NPCAgentManager.chat() å¤„ç†
    â†“
14. æ£€ç´¢è®°å¿† â†’ è·å–å¥½æ„Ÿåº¦ â†’ æ„å»ºæç¤ºè¯
    â†“
15. è°ƒç”¨ LLM ç”Ÿæˆå›å¤
    â†“
16. åˆ†ææƒ…æ„Ÿ â†’ æ›´æ–°å¥½æ„Ÿåº¦ â†’ ä¿å­˜è®°å¿†
    â†“
17. è¿”å› JSON å“åº”
    â†“
18. api_client.gd æ”¶åˆ°å“åº”
    â†“
19. å‘å‡º chat_response_received ä¿¡å·
    â†“
20. dialogue_ui.gd æ”¶åˆ°ä¿¡å·ï¼Œæ˜¾ç¤º NPC å›å¤
    â†“
21. ç©å®¶å¯ä»¥ç»§ç»­å¯¹è¯æˆ–å…³é—­å¯¹è¯æ¡†
```

---

## ğŸ“ æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. å‰åç«¯åˆ†ç¦»
- **å‰ç«¯**: Godot è´Ÿè´£æ¸²æŸ“å’Œäº¤äº’
- **åç«¯**: FastAPI è´Ÿè´£ AI é€»è¾‘
- **é€šä¿¡**: RESTful API + JSON

### 2. æ‰¹é‡ä¼˜åŒ–
- **ä¼ ç»Ÿ**: æ¯ä¸ª NPC ç‹¬ç«‹è°ƒç”¨ LLM
- **æ‰¹é‡**: ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆæ‰€æœ‰ NPC
- **æ•ˆæœ**: æˆæœ¬é™ä½ 66%

### 3. ä¿¡å·é©±åŠ¨
- **Godot**: ä½¿ç”¨ä¿¡å·è§£è€¦ç»„ä»¶
- **ä¼˜ç‚¹**: æ¾è€¦åˆã€æ˜“æ‰©å±•
- **ç¤ºä¾‹**: å¯¹è¯å®Œæˆ â†’ ä¿¡å·é€šçŸ¥ â†’ UI æ›´æ–°

### 4. å•ä¾‹æ¨¡å¼
- **AutoLoad**: config.gd, api_client.gd
- **å…¨å±€è®¿é—®**: ä»»ä½•è„šæœ¬éƒ½å¯ä»¥ä½¿ç”¨
- **ç¤ºä¾‹**: `Config.log_info()`, `APIClient.send_chat()`

### 5. å¼‚æ­¥å¤„ç†
- **åç«¯**: FastAPI å¼‚æ­¥è·¯ç”±
- **å‰ç«¯**: HTTPRequest å¼‚æ­¥è¯·æ±‚
- **æ•ˆæœ**: ä¸é˜»å¡æ¸¸æˆä¸»å¾ªç¯

---

## ğŸ’¡ ä»£ç å­¦ä¹ é‡ç‚¹

### å¿…è¯»ä»£ç ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
1. â­â­â­ `agents.py` - ç†è§£ NPC Agent çš„æ ¸å¿ƒå®ç°
2. â­â­â­ `api_client.gd` - ç†è§£å‰åç«¯é€šä¿¡
3. â­â­ `relationship_manager.py` - ç†è§£å¥½æ„Ÿåº¦ç³»ç»Ÿ
4. â­â­ `player.gd` - ç†è§£ç©å®¶æ§åˆ¶
5. â­â­ `dialogue_ui.gd` - ç†è§£å¯¹è¯ UI

### å¯é€‰é˜…è¯»
- `batch_generator.py` - æ‰¹é‡ç”Ÿæˆä¼˜åŒ–
- `state_manager.py` - çŠ¶æ€ç®¡ç†
- `npc.gd` - NPC å·¡é€»é€»è¾‘
- `main.gd` - ä¸»åœºæ™¯æ•´åˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### 1. è¿è¡Œé¡¹ç›® âš¡
æŒ‰ç…§ `ç¬¬15ç« -å¿«é€Ÿå¼€å§‹.md` çš„æŒ‡å—è¿è¡Œé¡¹ç›®

### 2. è°ƒè¯•ä»£ç  ğŸ›
- åœ¨ `agents.py` ä¸­æ·»åŠ  print è¯­å¥
- åœ¨ Godot ä¸­æŸ¥çœ‹ Output é¢æ¿
- ç†è§£æ¯ä¸€æ­¥çš„æ•°æ®æµ

### 3. ä¿®æ”¹ä»£ç  âœï¸
- ä¿®æ”¹ NPC çš„æ€§æ ¼è®¾å®š
- è°ƒæ•´å¥½æ„Ÿåº¦è®¡ç®—å…¬å¼
- æ”¹å˜ UI æ ·å¼

### 4. æ‰©å±•åŠŸèƒ½ ğŸ¨
- æ·»åŠ ç¬¬ 4 ä¸ª NPC
- å¢åŠ ä»»åŠ¡ç³»ç»Ÿ
- å®ç° NPC äº’åŠ¨

---

**åˆ›å»ºæ—¶é—´**: 2025-12-27  
**æ–‡æ¡£çŠ¶æ€**: å®Œæ•´  
**æ¨èé˜…è¯»æ—¶é—´**: 30-60 åˆ†é’Ÿ

ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼ ğŸ‰
