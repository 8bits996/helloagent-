# 🔧 故障排查指南

## 问题已解�?�?
**问题**: API服务不可�? 
**原因**: FastAPI后端进程已停�? 
**解决**: 已重新启动FastAPI服务

**当前状�?*: 
- �?FastAPI后端: 运行�?(http://localhost:8000)
- �?Streamlit前端: 运行�?(http://localhost:8501)

---

## 🔄 请刷新浏览器

**立即操作**:
1. 在浏览器中刷新页面（按F5或Ctrl+R�?2. 侧边栏应该显示：�?API服务正常
3. 现在可以正常上传文件�?
---

## 常见问题和解决方�?
### 问题1: �?API服务不可�?
**症状**:
- Streamlit侧边栏显�?�?API服务不可�?
- 文件上传失败
- 错误信息：`Max retries exceeded with url: /health`

**原因**:
- FastAPI后端未启�?- FastAPI后端进程已停�?- 端口8000被占�?
**解决方案**:

#### 方法1: 检查FastAPI是否运行
```bash
# 测试API连接
curl http://localhost:8000/health
```

如果失败，重新启动FastAPI�?```bash
cd /path/to/contract-review-ai
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 方法2: 检查端口占�?```bash
# 查看端口8000是否被占�?netstat -ano | findstr :8000
```

如果被占用，可以�?- 关闭占用端口的进�?- 或使用其他端口启动FastAPI

---

### 问题2: 🟠 CodeBuddy未启�?
**症状**:
- Streamlit显示"⚠️ CodeBuddy未启�?
- 可以上传文件，但无法启动AI评审

**影响**:
- �?文件上传正常
- �?文件解析正常
- �?AI评审功能不可�?
**解决方案**:

启动CodeBuddy服务�?```bash
# 打开新终�?codebuddy --serve --port 3000
```

等待输出�?```
Service endpoint: http://127.0.0.1:3000
```

然后刷新浏览器，侧边栏应显示：✅ CodeBuddy

---

### 问题3: Streamlit无法访问

**症状**:
- 浏览器显�?无法访问此网�?
- �?连接被拒�?

**原因**:
- Streamlit未启�?- 端口8501被占�?- 防火墙阻�?
**解决方案**:

#### 方法1: 检查Streamlit是否运行
访问: http://localhost:8501

如果失败，重新启动Streamlit�?```bash
cd /path/to/contract-review-ai
python -m streamlit run app/frontend.py
```

#### 方法2: 检查端口占�?```bash
netstat -ano | findstr :8501
```

#### 方法3: 检查防火墙
确保Windows防火墙允许Python访问网络�?
---

### 问题4: 文件上传后无响应

**症状**:
- 文件上传后一直显�?处理�?
- 或长时间无反�?
**原因**:
- 后台任务出错
- 文件格式不支�?- MarkItDown解析失败

**解决方案**:

#### 方法1: 查看后端日志
在FastAPI运行的终端查看错误信息�?
#### 方法2: 查看日志文件
```bash
# 查看日志
type logs\app.log
```

#### 方法3: 测试文件格式
使用简单的PDF或DOCX文件测试�?
---

### 问题5: 进程意外停止

**症状**:
- FastAPI或Streamlit突然停止
- 终端窗口关闭

**原因**:
- 终端被意外关�?- Python进程崩溃
- 系统资源不足

**解决方案**:

#### 恢复所有服务：

**终端1 - FastAPI**:
```bash
cd /path/to/contract-review-ai
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**终端2 - Streamlit**:
```bash
cd /path/to/contract-review-ai
python -m streamlit run app/frontend.py
```

**终端3 - CodeBuddy (可�?**:
```bash
codebuddy --serve --port 3000
```

---

## 🔍 诊断命令

### 快速诊�?```bash
# 1. 测试FastAPI
curl http://localhost:8000/health

# 2. 测试Streamlit
# 浏览器访�? http://localhost:8501

# 3. 检查端口占�?netstat -ano | findstr :8000
netstat -ano | findstr :8501
netstat -ano | findstr :3000

# 4. 查看日志
type logs\app.log
```

### 完整健康检�?```bash
# 测试API健康状�?curl http://localhost:8000/health

# 预期输出:
# {
#   "status": "healthy",
#   "services": {
#     "fastapi": "ok",
#     "codebuddy": "ok",  // 如果CodeBuddy未启动则�?error"
#     "markitdown": "ok"
#   }
# }
```

---

## 📝 服务重启流程

### 完整重启步骤

#### 1. 停止所有服�?- 关闭所有终端窗�?- 或在每个终端�?`Ctrl+C`

#### 2. 清理（可选）
```bash
# 清理日志
del logs\*.log

# 清理临时文件
rmdir /s /q data\uploads
rmdir /s /q data\outputs
mkdir data\uploads
mkdir data\outputs
```

#### 3. 按顺序启动服�?
**步骤1**: 启动FastAPI
```bash
cd /path/to/contract-review-ai
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

等待看到�?```
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

**步骤2**: 测试FastAPI
```bash
# 新终�?curl http://localhost:8000/health
```

**步骤3**: 启动Streamlit
```bash
cd /path/to/contract-review-ai
python -m streamlit run app/frontend.py
```

等待看到�?```
You can now view your Streamlit app in your browser.
Local URL: http://localhost:8501
```

**步骤4**: 访问系统
浏览器打开: http://localhost:8501

**步骤5**: 验证状�?侧边栏应显示�?- �?API服务正常
- �?FastAPI
- �?MarkItDown

**步骤6（可选）**: 启动CodeBuddy
```bash
codebuddy --serve --port 3000
```

刷新浏览器，应显示：
- �?CodeBuddy

---

## 🎯 当前状态检�?
### 服务状�?- �?FastAPI: 已重新启�?- �?Streamlit: 运行�?- 🟠 CodeBuddy: 待启�?
### 下一�?1. **刷新浏览�?* (F5)
2. 检查侧边栏状�?3. 测试文件上传功能

---

## 💡 预防措施

### 避免服务停止

1. **不要关闭终端窗口**
   - 保持3个终端窗口打开
   - 分别运行FastAPI、Streamlit、CodeBuddy

2. **使用screen或tmux**（高级）
   - 保持进程在后台运�?   - 即使关闭终端也不会停�?
3. **监控资源使用**
   - 定期检查内存和CPU使用
   - 确保系统资源充足

4. **查看日志**
   - 定期检�?`logs/app.log`
   - 及时发现潜在问题

---

## 📞 获取帮助

### 收集问题信息

如果问题仍未解决，请收集以下信息�?
1. **错误截图**
2. **日志内容**:
   ```bash
   type logs\app.log
   ```
3. **服务状�?*:
   ```bash
   netstat -ano | findstr :8000
   netstat -ano | findstr :8501
   ```
4. **Python版本**:
   ```bash
   python --version
   ```

---

## �?问题已解�?
**当前状�?*: 系统正常运行

**请执�?*:
1. �?刷新浏览�?(F5)
2. �?检查侧边栏显示"�?API服务正常"
3. �?测试上传文件功能

**访问地址**:
- Streamlit: http://localhost:8501
- FastAPI: http://localhost:8000

**祝使用愉快！** 🎉
