# 第15章 - 赛博小镇 快速开始

**日期**: 2025-12-27  
**学习者**: Franke Chen  
**目标**: 30 分钟内运行赛博小镇游戏

---

## 🎯 快速启动步骤

### 第一步: 准备 Godot 游戏引擎 (5分钟)

#### 1. 下载 Godot
- 访问: https://godotengine.org/download
- 下载 **Godot 4.2+** 版本（推荐 4.3 Standard）
- **Windows 用户**: 下载 `.exe` 文件
- **注意**: 需要下载 Standard 版本，不是 .NET 版本

#### 2. 安装 Godot
- 解压下载的 ZIP 文件到任意目录（例如 `C:\Godot`）
- 运行 `Godot_v4.x_win64.exe`
- 无需安装，直接运行即可

---

### 第二步: 配置后端环境 (10分钟)

#### 1. 进入项目目录
```bash
cd C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\backend
```

#### 2. 创建虚拟环境（如果还没有）
```bash
python -m venv venv
```

#### 3. 激活虚拟环境
```bash
.\venv\Scripts\activate
```

#### 4. 安装依赖
```bash
pip install -r requirements.txt
```

**可能需要的额外包**:
```bash
pip install fastapi uvicorn python-dotenv
pip install chromadb  # 如果需要向量数据库
```

#### 5. 配置环境变量
```bash
# 如果没有 .env 文件，复制示例
copy .env.example .env
```

编辑 `.env` 文件:
```ini
# LLM API 配置（使用你现有的硅基流动）
LLM_API_KEY=你的硅基流动API密钥
LLM_BASE_URL=https://api.siliconflow.cn/v1
LLM_MODEL=Qwen/Qwen2.5-7B-Instruct

# API 服务配置
API_HOST=0.0.0.0
API_PORT=8000

# NPC 更新间隔（秒）
NPC_UPDATE_INTERVAL=30
```

---

### 第三步: 启动后端服务 (2分钟)

#### 1. 启动服务
```bash
# 确保在 backend 目录下
python main.py
```

#### 2. 验证服务启动
看到以下输出表示成功:
```
🎮 赛博小镇后端服务启动中...
============================================================
✅ 所有服务已启动!
📡 API地址: http://0.0.0.0:8000
📚 API文档: http://0.0.0.0:8000/docs
============================================================
```

#### 3. 测试 API（可选）
在浏览器访问: http://localhost:8000/docs
尝试调用 `/npcs/status` 接口查看 NPC 状态

---

### 第四步: 启动 Godot 游戏 (5分钟)

#### 1. 打开 Godot 项目
1. 运行 Godot 应用
2. 点击 **"导入"** 按钮
3. 浏览到:
   ```
   C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\helloagents-ai-town
   ```
4. 选择 `project.godot` 文件
5. 点击 **"导入并编辑"**

#### 2. 配置 API 地址（如果需要）
在 Godot 编辑器中:
1. 找到 `scripts/api_client.gd` 文件
2. 检查 `BASE_URL` 是否为 `http://localhost:8000`
3. 如果不是，修改为正确的地址

#### 3. 运行游戏
1. 点击右上角的 **"运行"** 按钮（或按 F5）
2. 如果是第一次运行，会要求选择主场景
3. 选择 `scenes/main.tscn`
4. 游戏窗口应该打开

---

### 第五步: 开始体验 (8分钟)

#### 游戏操作
- **WASD** - 移动玩家
- **E** - 与 NPC 交互（需要走到 NPC 附近）
- **Enter** - 发送消息
- **ESC** - 关闭对话框

#### 测试清单
- [ ] 移动玩家，探索小镇
- [ ] 找到 **张三**（Python 工程师）并对话
- [ ] 找到 **李四**（产品经理）并对话
- [ ] 找到 **王五**（UI 设计师）并对话
- [ ] 观察 NPC 的自主巡逻行为
- [ ] 测试不同的对话内容
- [ ] 查看后端日志输出

#### 对话测试示例
1. **技术对话**（与张三）:
   - "你好，请问你擅长什么编程语言？"
   - "Python 的异步编程你怎么看？"

2. **产品对话**（与李四）:
   - "你好，能介绍一下你的工作吗？"
   - "你认为好的产品应该具备什么特点？"

3. **设计对话**（与王五）:
   - "你好，你喜欢什么设计风格？"
   - "能分享一些设计灵感吗？"

4. **好感度测试**:
   - 多次夸奖 NPC，观察回复是否更友好
   - 说一些负面的话，观察好感度下降

5. **记忆测试**:
   - 在对话中提到某个话题
   - 关闭对话框
   - 重新对话，再次提到同一话题，看是否记得

---

## 🐛 故障排查

### 问题1: 后端启动失败
**症状**: 运行 `python main.py` 报错

**解决方案**:
```bash
# 检查 Python 版本
python --version  # 应该是 3.10+

# 检查是否激活了虚拟环境
# 应该看到 (venv) 前缀

# 重新安装依赖
pip install -r requirements.txt --force-reinstall

# 检查 .env 文件是否存在
ls .env

# 查看详细错误信息
python main.py
```

### 问题2: Godot 导入失败
**症状**: 无法导入项目或项目打开后报错

**解决方案**:
1. 确认 Godot 版本 >= 4.2
2. 确认选择了正确的 `project.godot` 文件
3. 尝试关闭 Godot，删除 `.godot` 文件夹（会自动重新生成）
4. 重新导入项目

### 问题3: 游戏运行但无法对话
**症状**: 点击 E 键没有反应或对话框打开但无响应

**解决方案**:
1. 确认后端服务正在运行（检查终端窗口）
2. 确认玩家走到了 NPC 附近（看到 "E to talk" 提示）
3. 检查 Godot 控制台的错误信息（底部面板）
4. 在后端终端查看是否有 API 请求记录

### 问题4: NPC 不移动
**症状**: NPC 站在原地不动

**解决方案**:
- 这可能是正常的巡逻间隔
- 等待几秒钟，NPC 会随机移动
- 检查 `scripts/npc.gd` 中的巡逻设置

### 问题5: API 连接超时
**症状**: 对话时长时间无响应

**解决方案**:
1. 检查 LLM API 密钥是否正确
2. 检查网络连接
3. 尝试使用其他 LLM 模型
4. 查看后端日志的详细错误信息

---

## 📝 日志位置

### 后端日志
```
位置: C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\backend\logs\

文件格式: dialogue_YYYY-MM-DD.log
示例: dialogue_2025-12-27.log
```

**查看最新日志**:
```bash
# 在 backend 目录下
cd logs
# 查看今天的日志
type dialogue_2025-12-27.log

# 或者实时监控（需要第三方工具）
# tail -f dialogue_2025-12-27.log
```

### Godot 控制台
- 在 Godot 编辑器底部的 "输出" 面板
- 显示游戏运行时的日志和错误信息

---

## 🎯 完成检查清单

启动成功后，确认以下内容:

- [ ] 后端服务成功启动（看到 "✅ 所有服务已启动"）
- [ ] Godot 项目成功导入（无错误提示）
- [ ] 游戏窗口成功打开（看到小镇场景）
- [ ] 玩家可以移动（WASD 键有效）
- [ ] 可以看到 3 个 NPC（张三、李四、王五）
- [ ] NPC 会自主移动巡逻
- [ ] 可以与 NPC 对话（按 E 键）
- [ ] NPC 回复正常（看到 LLM 生成的对话）
- [ ] 后端日志正常记录对话

**如果以上全部完成，恭喜你成功启动了赛博小镇！** 🎉

---

## 📚 下一步

现在你可以:

1. **深入学习**: 阅读 [第15章-构建赛博小镇-学习指南.md](./学习笔记/第15章-构建赛博小镇-学习指南.md)
2. **查看文档**: 阅读项目目录下的各种 GUIDE.md 文件
3. **修改代码**: 尝试修改 NPC 的性格和对话风格
4. **扩展功能**: 添加新的 NPC 或游戏机制
5. **调试优化**: 查看日志，优化对话质量

---

## 🔗 相关资源

- 📘 [第15章官方文档](https://github.com/datawhalechina/hello-agents/blob/main/docs/chapter15/第十五章%20构建赛博小镇.md)
- 🎮 [Godot 官方文档](https://docs.godotengine.org/)
- 🐍 [FastAPI 文档](https://fastapi.tiangolo.com/)
- 📄 [项目 README](./official-code/code/chapter15/Helloagents-AI-Town/README.md)

---

**创建时间**: 2025-12-27  
**预计用时**: 30 分钟  
**难度**: ⭐⭐⭐ (中等)

**祝你学习顺利！** 🚀
