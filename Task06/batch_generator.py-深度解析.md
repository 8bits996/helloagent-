# batch_generator.py - æ·±åº¦ä»£ç è§£æ

**æ–‡ä»¶ä½ç½®**: `backend/batch_generator.py`  
**ä»£ç è¡Œæ•°**: 212è¡Œ  
**æ ¸å¿ƒèŒè´£**: æ‰¹é‡NPCå¯¹è¯ç”Ÿæˆå™¨ï¼ˆæˆæœ¬ä¼˜åŒ–æ ¸å¿ƒï¼‰  
**å­¦ä¹ æ—¥æœŸ**: 2025-12-27

---

## ğŸ“š ç›®å½•

1. [æ ¸å¿ƒæ€æƒ³](#æ ¸å¿ƒæ€æƒ³)
2. [æˆæœ¬ä¼˜åŒ–åŸç†](#æˆæœ¬ä¼˜åŒ–åŸç†)
3. [ä»£ç ç»“æ„](#ä»£ç ç»“æ„)
4. [æ‰¹é‡ç”Ÿæˆæµç¨‹](#æ‰¹é‡ç”Ÿæˆæµç¨‹)
5. [è®¾è®¡äº®ç‚¹](#è®¾è®¡äº®ç‚¹)
6. [å®è·µåº”ç”¨](#å®è·µåº”ç”¨)

---

## æ ¸å¿ƒæ€æƒ³

### é—®é¢˜ï¼šä¼ ç»Ÿæ–¹å¼çš„æˆæœ¬é—®é¢˜

**ä¼ ç»Ÿæ–¹å¼**ï¼ˆæ¯ä¸ªNPCå•ç‹¬è°ƒç”¨ï¼‰:
```python
# ä¸º3ä¸ªNPCç”Ÿæˆå¯¹è¯ï¼Œéœ€è¦3æ¬¡LLMè°ƒç”¨
dialogue_å¼ ä¸‰ = llm.invoke("å¼ ä¸‰åœ¨åšä»€ä¹ˆï¼Ÿ")  # ç¬¬1æ¬¡è°ƒç”¨
dialogue_æå›› = llm.invoke("æå››åœ¨åšä»€ä¹ˆï¼Ÿ")  # ç¬¬2æ¬¡è°ƒç”¨
dialogue_ç‹äº” = llm.invoke("ç‹äº”åœ¨åšä»€ä¹ˆï¼Ÿ")  # ç¬¬3æ¬¡è°ƒç”¨

# æ€»æˆæœ¬ = 3 Ã— å•æ¬¡æˆæœ¬
# æ€»å»¶è¿Ÿ = 3 Ã— å•æ¬¡å»¶è¿Ÿ
```

**é—®é¢˜**:
- âŒ APIè°ƒç”¨æ¬¡æ•°å¤šï¼ˆ3æ¬¡ï¼‰
- âŒ æˆæœ¬é«˜ï¼ˆ3å€ï¼‰
- âŒ æ€»å»¶è¿Ÿé•¿ï¼ˆ3å€ï¼‰
- âŒ èµ„æºæµªè´¹

---

### è§£å†³æ–¹æ¡ˆï¼šæ‰¹é‡ç”Ÿæˆ

**æ‰¹é‡æ–¹å¼**ï¼ˆä¸€æ¬¡è°ƒç”¨ç”Ÿæˆæ‰€æœ‰NPCï¼‰:
```python
# ä¸€æ¬¡LLMè°ƒç”¨ç”Ÿæˆæ‰€æœ‰NPCå¯¹è¯
prompt = """
è¯·ä¸º3ä¸ªNPCç”Ÿæˆå¯¹è¯:
- å¼ ä¸‰(Pythonå·¥ç¨‹å¸ˆ)
- æå››(äº§å“ç»ç†)
- ç‹äº”(UIè®¾è®¡å¸ˆ)

è¿”å›JSON: {"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "..."}
"""

response = llm.invoke(prompt)  # åªè°ƒç”¨1æ¬¡ï¼
dialogues = json.loads(response)

# æ€»æˆæœ¬ = 1 Ã— å•æ¬¡æˆæœ¬
# æ€»å»¶è¿Ÿ = 1 Ã— å•æ¬¡å»¶è¿Ÿ
```

**ä¼˜åŠ¿**:
- âœ… APIè°ƒç”¨æ¬¡æ•°å°‘ï¼ˆ1æ¬¡ï¼‰
- âœ… æˆæœ¬é™ä½66%ï¼ˆ1/3ï¼‰
- âœ… å»¶è¿Ÿé™ä½66%ï¼ˆ1/3ï¼‰
- âœ… èµ„æºé«˜æ•ˆåˆ©ç”¨

---

## æˆæœ¬ä¼˜åŒ–åŸç†

### æˆæœ¬å¯¹æ¯”è®¡ç®—

å‡è®¾ï¼š
- å•æ¬¡LLMè°ƒç”¨æˆæœ¬ï¼š0.01å…ƒ
- å•æ¬¡è°ƒç”¨å»¶è¿Ÿï¼š2ç§’

**ä¼ ç»Ÿæ–¹å¼**:
```
å¼ ä¸‰å¯¹è¯ç”Ÿæˆ: 0.01å…ƒ + 2ç§’
æå››å¯¹è¯ç”Ÿæˆ: 0.01å…ƒ + 2ç§’
ç‹äº”å¯¹è¯ç”Ÿæˆ: 0.01å…ƒ + 2ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»æˆæœ¬: 0.03å…ƒ
æ€»å»¶è¿Ÿ: 6ç§’
```

**æ‰¹é‡æ–¹å¼**:
```
æ‰€æœ‰NPCå¯¹è¯ç”Ÿæˆ: 0.01å…ƒ + 2ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»æˆæœ¬: 0.01å…ƒ
æ€»å»¶è¿Ÿ: 2ç§’
```

**èŠ‚çœ**:
```
æˆæœ¬èŠ‚çœ: (0.03 - 0.01) / 0.03 = 66.7%
å»¶è¿ŸèŠ‚çœ: (6 - 2) / 6 = 66.7%
```

### ä¸ºä»€ä¹ˆèƒ½èŠ‚çœ66%ï¼Ÿ

**å…³é”®ç‚¹**: LLMçš„æˆæœ¬ä¸»è¦å–å†³äº**è°ƒç”¨æ¬¡æ•°**å’Œ**æ€»tokenæ•°**

**ä¼ ç»Ÿæ–¹å¼çš„tokenæ¶ˆè€—**:
```
è°ƒç”¨1: ç³»ç»Ÿæç¤ºè¯(100 tokens) + å¼ ä¸‰æè¿°(50) + ç”Ÿæˆ(30) = 180 tokens
è°ƒç”¨2: ç³»ç»Ÿæç¤ºè¯(100 tokens) + æå››æè¿°(50) + ç”Ÿæˆ(30) = 180 tokens
è°ƒç”¨3: ç³»ç»Ÿæç¤ºè¯(100 tokens) + ç‹äº”æè¿°(50) + ç”Ÿæˆ(30) = 180 tokens
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡: 540 tokens
```

**æ‰¹é‡æ–¹å¼çš„tokenæ¶ˆè€—**:
```
è°ƒç”¨1: ç³»ç»Ÿæç¤ºè¯(100 tokens) + æ‰€æœ‰NPCæè¿°(150) + ç”Ÿæˆ(90) = 340 tokens
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡: 340 tokens
```

**èŠ‚çœåˆ†æ**:
1. **ç³»ç»Ÿæç¤ºè¯å¤ç”¨** - åªå‘é€1æ¬¡ï¼ˆèŠ‚çœ200 tokensï¼‰
2. **ä¸Šä¸‹æ–‡å…±äº«** - NPCæè¿°é›†ä¸­ï¼ˆæ— é‡å¤ï¼‰
3. **æ‰¹é‡ç”Ÿæˆ** - ä¸€æ¬¡æ€§è¾“å‡ºæ‰€æœ‰ç»“æœ

---

## ä»£ç ç»“æ„

### æ•´ä½“æ¶æ„

```python
batch_generator.py (212è¡Œ)
â”‚
â”œâ”€â”€ å¯¼å…¥ä¾èµ– (1-13è¡Œ)
â”‚   â”œâ”€â”€ HelloAgentsLLM
â”‚   â””â”€â”€ NPC_ROLESé…ç½®
â”‚
â”œâ”€â”€ æ ¸å¿ƒç±»: NPCBatchGenerator (15-201è¡Œ)
â”‚   â”œâ”€â”€ __init__() - åˆå§‹åŒ– (21-59è¡Œ)
â”‚   â”œâ”€â”€ generate_batch_dialogues() - æ‰¹é‡ç”Ÿæˆ â­â­â­ (61-97è¡Œ)
â”‚   â”œâ”€â”€ _build_batch_prompt() - æ„å»ºæç¤ºè¯ â­â­â­ (99-136è¡Œ)
â”‚   â”œâ”€â”€ _parse_response() - è§£æå“åº” â­â­ (138-168è¡Œ)
â”‚   â”œâ”€â”€ _get_current_context() - è·å–åœºæ™¯ (170-185è¡Œ)
â”‚   â””â”€â”€ _get_preset_dialogues() - é¢„è®¾å¯¹è¯ (187-200è¡Œ)
â”‚
â””â”€â”€ å…¨å±€å•ä¾‹ (202-210è¡Œ)
    â””â”€â”€ get_batch_generator()
```

---

## æ ¸å¿ƒç±»è¯¦è§£

### 1. åˆå§‹åŒ– (__init__, 21-59è¡Œ)

```python
def __init__(self):
    # 1ï¸âƒ£ åˆå§‹åŒ–LLM
    try:
        self.llm = HelloAgentsLLM()
        self.enabled = True
    except:
        self.llm = None
        self.enabled = False  # é™çº§æ¨¡å¼
    
    # 2ï¸âƒ£ å¼•ç”¨NPCé…ç½®
    self.npc_configs = NPC_ROLES  # æ¥è‡ªagents.py
    
    # 3ï¸âƒ£ é¢„è®¾å¯¹è¯åº“ï¼ˆé™çº§æ—¶ä½¿ç”¨ï¼‰
    self.preset_dialogues = {
        "morning": {...},
        "noon": {...},
        "afternoon": {...},
        "evening": {...}
    }
```

**é¢„è®¾å¯¹è¯åº“çš„ä½œç”¨**:
- å½“LLMä¸å¯ç”¨æ—¶æä¾›é™çº§æ–¹æ¡ˆ
- ç¡®ä¿ç³»ç»Ÿå§‹ç»ˆèƒ½è¿”å›å¯¹è¯
- æä¾›åŸºæœ¬çš„æ—¶æ®µå˜åŒ–

**ç¤ºä¾‹**:
```python
preset_dialogues = {
    "morning": {
        "å¼ ä¸‰": "æ—©ä¸Šå¥½!ä»Šå¤©è¦ç»§ç»­ä¼˜åŒ–é‚£ä¸ªå¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„æ€§èƒ½ã€‚",
        "æå››": "æ–°çš„ä¸€å¤©å¼€å§‹äº†,å…ˆæ•´ç†ä¸€ä¸‹ä»Šå¤©çš„ä¼šè®®å®‰æ’ã€‚",
        "ç‹äº”": "æ—©!å…ˆæ¥æ¯å’–å•¡ææç¥,ç„¶åå¼€å§‹è®¾è®¡æ–°ç•Œé¢ã€‚"
    },
    # ...
}
```

---

### 2. æ‰¹é‡ç”Ÿæˆ (generate_batch_dialogues, 61-97è¡Œ) â­â­â­

è¿™æ˜¯æ•´ä¸ªæ–‡ä»¶æœ€é‡è¦çš„æ–¹æ³•ï¼

```python
def generate_batch_dialogues(self, context: Optional[str] = None) -> Dict[str, str]:
    """æ‰¹é‡ç”Ÿæˆæ‰€æœ‰NPCçš„å¯¹è¯"""
```

**å®Œæ•´æµç¨‹ï¼ˆ5æ­¥ï¼‰**:

```
æ­¥éª¤1: æ£€æŸ¥LLMå¯ç”¨æ€§ (70-72è¡Œ)
    â†“
if not self.enabled or self.llm is None:
    return self._get_preset_dialogues()  # ä½¿ç”¨é¢„è®¾
    â†“
æ­¥éª¤2: æ„å»ºæ‰¹é‡æç¤ºè¯ (76è¡Œ) â­â­â­
    â†“
prompt = self._build_batch_prompt(context)

ç¤ºä¾‹prompt:
"""
è¯·ä¸ºDatawhaleåŠå…¬å®¤çš„3ä¸ªNPCç”Ÿæˆå½“å‰çš„å¯¹è¯æˆ–è¡Œä¸ºæè¿°ã€‚

ã€åœºæ™¯ã€‘ä¸Šåˆå·¥ä½œæ—¶é—´,å¤§å®¶éƒ½åœ¨ä¸“æ³¨å·¥ä½œ

ã€NPCä¿¡æ¯ã€‘
- å¼ ä¸‰(Pythonå·¥ç¨‹å¸ˆ): åœ¨å·¥ä½åŒºå†™ä»£ç 
- æå››(äº§å“ç»ç†): åœ¨ä¼šè®®å®¤æ•´ç†éœ€æ±‚
- ç‹äº”(UIè®¾è®¡å¸ˆ): åœ¨ä¼‘æ¯åŒºå–å’–å•¡

ã€è¾“å‡ºæ ¼å¼ã€‘
{"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "..."}
"""
    â†“
æ­¥éª¤3: ä¸€æ¬¡LLMè°ƒç”¨ (80-83è¡Œ) â­â­â­â­â­
    â†“
response = self.llm.invoke([
    {"role": "system", "content": "ä½ æ˜¯æ¸¸æˆNPCå¯¹è¯ç”Ÿæˆå™¨"},
    {"role": "user", "content": prompt}
])

LLMè¿”å›JSON:
{
    "å¼ ä¸‰": "è¿™ä¸ªbugçœŸæ˜¯è§é¬¼äº†,å·²ç»è°ƒè¯•ä¸¤å°æ—¶äº†...",
    "æå››": "å—¯,è¿™ä¸ªåŠŸèƒ½çš„ä¼˜å…ˆçº§éœ€è¦é‡æ–°è¯„ä¼°ä¸€ä¸‹ã€‚",
    "ç‹äº”": "è¿™æ¯å’–å•¡çš„æ‹‰èŠ±çœŸä¸é”™,çµæ„Ÿæ¥äº†!"
}
    â†“
æ­¥éª¤4: è§£æJSONå“åº” (86è¡Œ) â­â­
    â†“
dialogues = self._parse_response(response)

éªŒè¯:
- æ˜¯å¦æ˜¯å­—å…¸ï¼Ÿ
- æ˜¯å¦åŒ…å«æ‰€æœ‰NPCï¼Ÿ
    â†“
æ­¥éª¤5: è¿”å›ç»“æœ (88-93è¡Œ)
    â†“
if dialogues:
    print(f"âœ… æ‰¹é‡ç”ŸæˆæˆåŠŸ: {len(dialogues)}ä¸ªNPCå¯¹è¯")
    return dialogues
else:
    return self._get_preset_dialogues()  # é™çº§
```

**å…³é”®ä»£ç **:

```python
# æ­¥éª¤3: ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆæ‰€æœ‰å¯¹è¯
response = self.llm.invoke([
    {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆNPCå¯¹è¯ç”Ÿæˆå™¨"},
    {"role": "user", "content": prompt}
])

# æ­¥éª¤4: è§£æJSON
dialogues = self._parse_response(response)
# è¿”å›: {"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "..."}
```

---

### 3. æ„å»ºæ‰¹é‡æç¤ºè¯ (_build_batch_prompt, 99-136è¡Œ) â­â­â­

è¿™æ˜¯æˆæœ¬ä¼˜åŒ–çš„æ ¸å¿ƒï¼è®¾è®¡å·§å¦™çš„æç¤ºè¯æ˜¯å…³é”®ã€‚

```python
def _build_batch_prompt(self, context: Optional[str] = None) -> str:
    """æ„å»ºæ‰¹é‡ç”Ÿæˆæç¤ºè¯"""
```

**æç¤ºè¯ç»“æ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€åœºæ™¯ã€‘ä¸Šåˆå·¥ä½œæ—¶é—´                 â”‚  â†’ æä¾›æ—¶é—´ä¸Šä¸‹æ–‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€NPCä¿¡æ¯ã€‘                         â”‚  â†’ æ‰€æœ‰NPCçš„æè¿°
â”‚   - å¼ ä¸‰(Pythonå·¥ç¨‹å¸ˆ): åœ¨å·¥ä½åŒº...  â”‚
â”‚   - æå››(äº§å“ç»ç†): åœ¨ä¼šè®®å®¤...      â”‚
â”‚   - ç‹äº”(UIè®¾è®¡å¸ˆ): åœ¨ä¼‘æ¯åŒº...      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€ç”Ÿæˆè¦æ±‚ã€‘                         â”‚  â†’ æ˜ç¡®è¦æ±‚
â”‚   1. æ¯ä¸ªNPCç”Ÿæˆ1å¥è¯(20-40å­—)      â”‚
â”‚   2. ç¬¦åˆè§’è‰²è®¾å®š                    â”‚
â”‚   3. è‡ªç„¶çœŸå®                        â”‚
â”‚   4. ä¸¥æ ¼JSONæ ¼å¼                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€è¾“å‡ºæ ¼å¼ã€‘                         â”‚  â†’ æ ¼å¼è¯´æ˜
â”‚   {"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "..."}
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€ç¤ºä¾‹è¾“å‡ºã€‘                         â”‚  â†’ æä¾›ç¤ºä¾‹
â”‚   {"å¼ ä¸‰": "è¿™ä¸ªbugçœŸæ˜¯è§é¬¼äº†...", ...}
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç å®ç°**:

```python
# 1ï¸âƒ£ è‡ªåŠ¨æ¨æ–­åœºæ™¯ï¼ˆå¦‚æœæœªæä¾›ï¼‰
if context is None:
    context = self._get_current_context()  # æ ¹æ®æ—¶é—´åˆ¤æ–­

# 2ï¸âƒ£ æ„å»ºNPCæè¿°
npc_descriptions = []
for name, cfg in self.npc_configs.items():
    desc = f"- {name}({cfg['title']}): åœ¨{cfg['location']}{cfg['activity']},æ€§æ ¼{cfg['personality']}"
    npc_descriptions.append(desc)

npc_desc_text = "\n".join(npc_descriptions)

# 3ï¸âƒ£ ç»„è£…å®Œæ•´æç¤ºè¯
prompt = f"""è¯·ä¸ºDatawhaleåŠå…¬å®¤çš„3ä¸ªNPCç”Ÿæˆå½“å‰çš„å¯¹è¯æˆ–è¡Œä¸ºæè¿°ã€‚

ã€åœºæ™¯ã€‘{context}

ã€NPCä¿¡æ¯ã€‘
{npc_desc_text}

ã€ç”Ÿæˆè¦æ±‚ã€‘
1. æ¯ä¸ªNPCç”Ÿæˆ1å¥è¯(20-40å­—)
2. å†…å®¹è¦ç¬¦åˆè§’è‰²è®¾å®šã€å½“å‰æ´»åŠ¨å’Œåœºæ™¯æ°›å›´
3. å¯ä»¥æ˜¯è‡ªè¨€è‡ªè¯­ã€å·¥ä½œçŠ¶æ€æè¿°ã€æˆ–ç®€å•çš„æ€è€ƒ
4. è¦è‡ªç„¶çœŸå®,åƒçœŸå®çš„åŠå…¬å®¤åŒäº‹
5. å¯ä»¥ä½“ç°ä¸€äº›ä¸ªæ€§åŒ–ç‰¹ç‚¹å’Œæƒ…ç»ª
6. **å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›**

ã€è¾“å‡ºæ ¼å¼ã€‘(ä¸¥æ ¼éµå®ˆ)
{{"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "..."}}

ã€ç¤ºä¾‹è¾“å‡ºã€‘
{{"å¼ ä¸‰": "è¿™ä¸ªbugçœŸæ˜¯è§é¬¼äº†,å·²ç»è°ƒè¯•ä¸¤å°æ—¶äº†...", "æå››": "å—¯,è¿™ä¸ªåŠŸèƒ½çš„ä¼˜å…ˆçº§éœ€è¦é‡æ–°è¯„ä¼°ä¸€ä¸‹ã€‚", "ç‹äº”": "è¿™æ¯å’–å•¡çš„æ‹‰èŠ±çœŸä¸é”™,çµæ„Ÿæ¥äº†!"}}

è¯·ç”Ÿæˆ(åªè¿”å›JSON,ä¸è¦å…¶ä»–å†…å®¹):
"""

return prompt
```

**è®¾è®¡äº®ç‚¹**:
1. âœ… **åœºæ™¯æ„Ÿ** - æ ¹æ®æ—¶é—´è‡ªåŠ¨è°ƒæ•´åœºæ™¯æè¿°
2. âœ… **æ‰¹é‡æè¿°** - æ‰€æœ‰NPCä¿¡æ¯é›†ä¸­æä¾›
3. âœ… **æ˜ç¡®æ ¼å¼** - å¼ºè°ƒJSONæ ¼å¼ï¼Œæä¾›ç¤ºä¾‹
4. âœ… **å­—æ•°é™åˆ¶** - 20-40å­—ï¼ˆæ§åˆ¶ç”Ÿæˆé•¿åº¦ï¼‰
5. âœ… **å¤šé‡å¼ºè°ƒ** - å¤šæ¬¡å¼ºè°ƒ"åªè¿”å›JSON"

---

### 4. è§£æJSONå“åº” (_parse_response, 138-168è¡Œ)

ä¸ `relationship_manager.py` ç±»ä¼¼çš„åŒå±‚è§£æã€‚

```python
def _parse_response(self, response: str) -> Optional[Dict[str, str]]:
    """è§£æLLMå“åº”"""
```

**åŒå±‚è§£æç­–ç•¥**:

```
ç­–ç•¥1: ç›´æ¥è§£æ (141-149è¡Œ)
    â†“
try:
    dialogues = json.loads(response)
    
    # â­ éªŒè¯æ ¼å¼
    if isinstance(dialogues, dict) and \
       all(name in dialogues for name in self.npc_configs.keys()):
        return dialogues
except:
    â†“ (å¤±è´¥)

ç­–ç•¥2: æå–JSONéƒ¨åˆ† (153-165è¡Œ)
    â†“
# æŸ¥æ‰¾ç¬¬ä¸€ä¸ª{å’Œæœ€åä¸€ä¸ª}
start = response.find('{')
end = response.rfind('}') + 1

if start != -1 and end > start:
    json_str = response[start:end]
    dialogues = json.loads(json_str)
    return dialogues
    â†“ (å¤±è´¥)

è¿”å›None (167-168è¡Œ)
```

**æ ¼å¼éªŒè¯** (145è¡Œ):
```python
# å¿…é¡»åŒæ—¶æ»¡è¶³ï¼š
# 1. æ˜¯å­—å…¸ç±»å‹
# 2. åŒ…å«æ‰€æœ‰NPCåç§°
if isinstance(dialogues, dict) and \
   all(name in dialogues for name in self.npc_configs.keys()):
    return dialogues
```

**ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ï¼Ÿ**
- LLMå¯èƒ½æ¼æ‰æŸä¸ªNPC
- LLMå¯èƒ½è¿”å›é”™è¯¯çš„key
- ç¡®ä¿è¿”å›æ•°æ®å®Œæ•´

---

### 5. åœºæ™¯æ¨æ–­ (_get_current_context, 170-185è¡Œ)

æ ¹æ®å½“å‰æ—¶é—´è‡ªåŠ¨æ¨æ–­åœºæ™¯ã€‚

```python
def _get_current_context(self) -> str:
    """æ ¹æ®å½“å‰æ—¶é—´æ¨æ–­åœºæ™¯ä¸Šä¸‹æ–‡"""
    hour = datetime.now().hour
    
    if 6 <= hour < 9:
        return "æ¸…æ™¨æ—¶åˆ†,å¤§å®¶é™†ç»­åˆ°è¾¾åŠå…¬å®¤,å‡†å¤‡å¼€å§‹æ–°çš„ä¸€å¤©"
    elif 9 <= hour < 12:
        return "ä¸Šåˆå·¥ä½œæ—¶é—´,å¤§å®¶éƒ½åœ¨ä¸“æ³¨å·¥ä½œ,åŠå…¬å®¤æ°›å›´ä¸“æ³¨è€Œå¿™ç¢Œ"
    elif 12 <= hour < 14:
        return "åˆé¤æ—¶é—´,å¤§å®¶åœ¨ä¼‘æ¯æ”¾æ¾,èŠèŠå¤©æˆ–è€…çœ‹çœ‹æ‰‹æœº"
    elif 14 <= hour < 17:
        return "ä¸‹åˆå·¥ä½œæ—¶é—´,ç»§ç»­æ¨è¿›é¡¹ç›®,å¶å°”éœ€è¦å–æ¯å’–å•¡æç¥"
    elif 17 <= hour < 19:
        return "å‚æ™šæ—¶åˆ†,å‡†å¤‡æ”¶å°¾ä»Šå¤©çš„å·¥ä½œ,æ•´ç†æ˜å¤©çš„è®¡åˆ’"
    else:
        return "å¤œæ™šæ—¶åˆ†,åŠå…¬å®¤å®‰é™ä¸‹æ¥,å¶å°”è¿˜æœ‰äººåœ¨åŠ ç­"
```

**æ—¶é—´æ®µåˆ’åˆ†**:
```
06:00-09:00 â†’ æ¸…æ™¨ï¼ˆåˆ°è¾¾åŠå…¬å®¤ï¼‰
09:00-12:00 â†’ ä¸Šåˆï¼ˆä¸“æ³¨å·¥ä½œï¼‰
12:00-14:00 â†’ åˆé¤ï¼ˆä¼‘æ¯æ”¾æ¾ï¼‰
14:00-17:00 â†’ ä¸‹åˆï¼ˆç»§ç»­å·¥ä½œï¼‰
17:00-19:00 â†’ å‚æ™šï¼ˆæ”¶å°¾å·¥ä½œï¼‰
19:00-06:00 â†’ å¤œæ™šï¼ˆå®‰é™/åŠ ç­ï¼‰
```

**åœºæ™¯æè¿°çš„ä»·å€¼**:
- âœ… è®©NPCå¯¹è¯ç¬¦åˆæ—¶é—´æ°›å›´
- âœ… å¢åŠ æ¸¸æˆçœŸå®æ„Ÿ
- âœ… è‡ªåŠ¨é€‚åº”æ—¶é—´å˜åŒ–

**ç¤ºä¾‹**:
```
ä¸Šåˆ9ç‚¹ç”Ÿæˆ:
- åœºæ™¯: "ä¸Šåˆå·¥ä½œæ—¶é—´,å¤§å®¶éƒ½åœ¨ä¸“æ³¨å·¥ä½œ"
- å¼ ä¸‰: "æ­£åœ¨è°ƒè¯•ä»£ç ,è¿™ä¸ªç®—æ³•éœ€è¦ä¼˜åŒ–..."
- æå››: "ä¸Šåˆæœ‰ä¸ªéœ€æ±‚è¯„å®¡ä¼š,å‡†å¤‡ä¸€ä¸‹èµ„æ–™ã€‚"

ä¸­åˆ12ç‚¹ç”Ÿæˆ:
- åœºæ™¯: "åˆé¤æ—¶é—´,å¤§å®¶åœ¨ä¼‘æ¯æ”¾æ¾"
- å¼ ä¸‰: "ç»ˆäºå¯ä»¥ä¼‘æ¯ä¸€ä¸‹äº†,å»åƒä¸ªé¥­ã€‚"
- æå››: "ä¸­åˆçº¦äº†å®¢æˆ·åƒé¥­,èŠèŠæ–°éœ€æ±‚ã€‚"
```

---

### 6. é¢„è®¾å¯¹è¯é™çº§ (_get_preset_dialogues, 187-200è¡Œ)

å½“LLMä¸å¯ç”¨æ—¶çš„é™çº§æ–¹æ¡ˆã€‚

```python
def _get_preset_dialogues(self) -> Dict[str, str]:
    """è·å–é¢„è®¾å¯¹è¯(æ ¹æ®æ—¶é—´)"""
    hour = datetime.now().hour
    
    if 6 <= hour < 12:
        period = "morning"
    elif 12 <= hour < 14:
        period = "noon"
    elif 14 <= hour < 18:
        period = "afternoon"
    else:
        period = "evening"
    
    return self.preset_dialogues.get(period, self.preset_dialogues["morning"])
```

**é¢„è®¾å¯¹è¯åº“** (38-59è¡Œ):
```python
self.preset_dialogues = {
    "morning": {
        "å¼ ä¸‰": "æ—©ä¸Šå¥½!ä»Šå¤©è¦ç»§ç»­ä¼˜åŒ–é‚£ä¸ªå¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„æ€§èƒ½ã€‚",
        "æå››": "æ–°çš„ä¸€å¤©å¼€å§‹äº†,å…ˆæ•´ç†ä¸€ä¸‹ä»Šå¤©çš„ä¼šè®®å®‰æ’ã€‚",
        "ç‹äº”": "æ—©!å…ˆæ¥æ¯å’–å•¡ææç¥,ç„¶åå¼€å§‹è®¾è®¡æ–°ç•Œé¢ã€‚"
    },
    "noon": {
        "å¼ ä¸‰": "å†™äº†ä¸€ä¸Šåˆä»£ç ,ç»ˆäºæŠŠé‚£ä¸ªbugä¿®å¤äº†!",
        "æå››": "ä¸Šåˆçš„éœ€æ±‚è¯„å®¡ä¼šå¾ˆé¡ºåˆ©,ä¸‹åˆç»§ç»­æ¨è¿›ã€‚",
        "ç‹äº”": "è¿™ä¸ªé…è‰²æ–¹æ¡ˆçœ‹èµ·æ¥ä¸é”™,å†è°ƒæ•´ä¸€ä¸‹ç»†èŠ‚ã€‚"
    },
    # ...
}
```

**é™çº§æ–¹æ¡ˆçš„é‡è¦æ€§**:
- âœ… ç¡®ä¿ç³»ç»Ÿå¥å£®æ€§
- âœ… APIå¤±è´¥æ—¶ä»å¯è¿è¡Œ
- âœ… å¼€å‘æµ‹è¯•æ—¶æ— éœ€API
- âœ… æä¾›åŸºæœ¬çš„æ¸¸æˆä½“éªŒ

---

## æ‰¹é‡ç”Ÿæˆæµç¨‹

### å®Œæ•´æ•°æ®æµ

```
å®šæ—¶è§¦å‘ï¼ˆæ¯30ç§’ï¼‰
    â†“
state_manager.py è°ƒç”¨
    â†“
batch_generator.generate_batch_dialogues()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·å–å½“å‰åœºæ™¯                  â”‚
â”‚    hour = 10 â†’ "ä¸Šåˆå·¥ä½œæ—¶é—´"    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. æ„å»ºæ‰¹é‡æç¤ºè¯                â”‚
â”‚    åŒ…å«:                         â”‚
â”‚    - åœºæ™¯æè¿°                    â”‚
â”‚    - æ‰€æœ‰NPCä¿¡æ¯                 â”‚
â”‚    - ç”Ÿæˆè¦æ±‚                    â”‚
â”‚    - JSONæ ¼å¼è¯´æ˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ä¸€æ¬¡LLMè°ƒç”¨ â­â­â­â­â­         â”‚
â”‚    llm.invoke(prompt)           â”‚
â”‚    â†“                            â”‚
â”‚    è¿”å›JSON:                    â”‚
â”‚    {                            â”‚
â”‚      "å¼ ä¸‰": "...",              â”‚
â”‚      "æå››": "...",              â”‚
â”‚      "ç‹äº”": "..."               â”‚
â”‚    }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è§£æJSON                     â”‚
â”‚    dialogues = json.loads()     â”‚
â”‚    éªŒè¯æ ¼å¼                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è¿”å›ç»“æœ                     â”‚
â”‚    {                            â”‚
â”‚      "å¼ ä¸‰": "æ­£åœ¨è°ƒè¯•ä»£ç ...",  â”‚
â”‚      "æå››": "æ•´ç†éœ€æ±‚æ–‡æ¡£...",  â”‚
â”‚      "ç‹äº”": "è®¾è®¡æ–°ç•Œé¢..."     â”‚
â”‚    }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ›´æ–°NPCçŠ¶æ€ï¼ˆåœ¨æ¸¸æˆä¸­æ˜¾ç¤ºï¼‰
```

---

## è®¾è®¡äº®ç‚¹

### 1. æˆæœ¬ä¼˜åŒ–æ ¸å¿ƒ â­â­â­â­â­

**ä»3æ¬¡è°ƒç”¨åˆ°1æ¬¡è°ƒç”¨**:
```python
# âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆ3æ¬¡è°ƒç”¨ï¼‰
for npc_name in ["å¼ ä¸‰", "æå››", "ç‹äº”"]:
    dialogue = llm.invoke(f"ç”Ÿæˆ{npc_name}çš„å¯¹è¯")
    # æˆæœ¬: 3x

# âœ… æ‰¹é‡æ–¹å¼ï¼ˆ1æ¬¡è°ƒç”¨ï¼‰
prompt = "ç”Ÿæˆæ‰€æœ‰NPCçš„å¯¹è¯: å¼ ä¸‰ã€æå››ã€ç‹äº”"
dialogues = llm.invoke(prompt)
# æˆæœ¬: 1x
```

**èŠ‚çœ66%æˆæœ¬å’Œå»¶è¿Ÿ**ï¼

---

### 2. JSONæ ¼å¼åŒ–è¾“å‡º â­â­â­â­â­

**ä¸ºä»€ä¹ˆç”¨JSONï¼Ÿ**
- âœ… ç»“æ„åŒ–æ•°æ®ï¼Œæ˜“è§£æ
- âœ… æ˜ç¡®æ˜ å°„ï¼ˆNPCåç§°â†’å¯¹è¯ï¼‰
- âœ… LLMæ“…é•¿ç”ŸæˆJSON
- âœ… éªŒè¯æ ¼å¼å®¹æ˜“

**å¤šé‡å¼ºè°ƒJSON**:
```python
# åœ¨æç¤ºè¯ä¸­å¤šæ¬¡å¼ºè°ƒ
"ã€è¾“å‡ºæ ¼å¼ã€‘(ä¸¥æ ¼éµå®ˆ)"
"{"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "..."}"

"ã€ç¤ºä¾‹è¾“å‡ºã€‘"
"{"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "..."}"

"è¯·ç”Ÿæˆ(åªè¿”å›JSON,ä¸è¦å…¶ä»–å†…å®¹):"
```

**ä¸ºä»€ä¹ˆè¦å¤šæ¬¡å¼ºè°ƒï¼Ÿ**
- LLMå¯èƒ½è¾“å‡ºé¢å¤–æ–‡å­—
- å¼ºè°ƒå¯æé«˜æ ¼å¼æ­£ç¡®ç‡
- ç¤ºä¾‹æä¾›æ˜ç¡®å‚è€ƒ

---

### 3. åœºæ™¯æ„Ÿæ—¶é—´ç³»ç»Ÿ â­â­â­â­

```python
# æ ¹æ®çœŸå®æ—¶é—´è‡ªåŠ¨è°ƒæ•´åœºæ™¯
hour = datetime.now().hour

if 9 <= hour < 12:
    context = "ä¸Šåˆå·¥ä½œæ—¶é—´,å¤§å®¶éƒ½åœ¨ä¸“æ³¨å·¥ä½œ"
    # â†’ NPCå¯¹è¯ä¼šæ›´ä¸“æ³¨ã€ä¸¥è‚ƒ
    
elif 12 <= hour < 14:
    context = "åˆé¤æ—¶é—´,å¤§å®¶åœ¨ä¼‘æ¯æ”¾æ¾"
    # â†’ NPCå¯¹è¯ä¼šæ›´è½»æ¾ã€ä¼‘é—²
```

**æ•ˆæœ**:
- âœ… æ¸¸æˆä¸–ç•Œä¸ç°å®åŒæ­¥
- âœ… NPCè¡Œä¸ºç¬¦åˆæ—¶é—´è§„å¾‹
- âœ… å¢åŠ æ²‰æµ¸æ„Ÿ

---

### 4. é™çº§æ–¹æ¡ˆè®¾è®¡ â­â­â­â­â­

```python
try:
    # å°è¯•LLMç”Ÿæˆ
    dialogues = self.llm.invoke(prompt)
except:
    # å¤±è´¥åˆ™ä½¿ç”¨é¢„è®¾
    dialogues = self._get_preset_dialogues()
```

**å¤šå±‚é™çº§**:
```
ä¼˜å…ˆçº§1: LLMæ‰¹é‡ç”Ÿæˆ â†’ æœ€ä½³æ•ˆæœ
    â†“ (å¤±è´¥)
ä¼˜å…ˆçº§2: JSONè§£æå¤±è´¥ â†’ é‡è¯•æå–
    â†“ (å¤±è´¥)
ä¼˜å…ˆçº§3: é¢„è®¾å¯¹è¯åº“ â†’ ä¿åº•æ–¹æ¡ˆ
```

**ä¿è¯ç³»ç»Ÿæ°¸ä¸å´©æºƒ**ï¼

---

### 5. å•ä¾‹æ¨¡å¼ â­â­â­â­

```python
_batch_generator = None

def get_batch_generator() -> NPCBatchGenerator:
    global _batch_generator
    if _batch_generator is None:
        _batch_generator = NPCBatchGenerator()
    return _batch_generator
```

**ä¼˜åŠ¿**:
- âœ… LLMè¿æ¥åªåˆå§‹åŒ–ä¸€æ¬¡
- âœ… é¢„è®¾å¯¹è¯åº“åªåŠ è½½ä¸€æ¬¡
- âœ… èŠ‚çœèµ„æº

---

## å®è·µåº”ç”¨

### åº”ç”¨åœºæ™¯1: å®šæ—¶æ›´æ–°NPCçŠ¶æ€

åœ¨ `state_manager.py` ä¸­ä½¿ç”¨ï¼š

```python
# æ¯30ç§’è‡ªåŠ¨è°ƒç”¨
async def update_npc_status():
    while True:
        # æ‰¹é‡ç”Ÿæˆæ‰€æœ‰NPCå¯¹è¯
        batch_gen = get_batch_generator()
        dialogues = batch_gen.generate_batch_dialogues()
        
        # æ›´æ–°æ¯ä¸ªNPCçš„çŠ¶æ€
        for npc_name, dialogue in dialogues.items():
            npc_status[npc_name] = dialogue
        
        await asyncio.sleep(30)  # ç­‰å¾…30ç§’
```

**æ•ˆæœ**:
- NPCæ¯30ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
- ç©å®¶çœ‹åˆ°NPCåœ¨"æ´»åŠ¨"ï¼ˆè‡ªè¨€è‡ªè¯­ã€å·¥ä½œï¼‰
- å¢åŠ æ¸¸æˆçœŸå®æ„Ÿ

---

### åº”ç”¨åœºæ™¯2: ä¸åŒæ—¶æ®µçš„NPCè¡Œä¸º

**ä¸Šåˆ9ç‚¹**:
```json
{
  "å¼ ä¸‰": "å¼€å§‹æ–°çš„ä¸€å¤©,å…ˆæ•´ç†ä¸€ä¸‹æ˜¨å¤©çš„ä»£ç ã€‚",
  "æå››": "ä¸Šåˆæœ‰ä¸ªéœ€æ±‚è¯„å®¡ä¼š,å‡†å¤‡èµ„æ–™ä¸­...",
  "ç‹äº”": "æŸ¥çœ‹æ˜¨å¤©çš„è®¾è®¡åé¦ˆ,å‡†å¤‡ä¿®æ”¹ã€‚"
}
```

**ä¸­åˆ12ç‚¹**:
```json
{
  "å¼ ä¸‰": "ç»ˆäºå¯ä»¥ä¼‘æ¯ä¸€ä¸‹äº†,å»é£Ÿå ‚åƒé¥­!",
  "æå››": "åˆé¥­æ—¶é—´,çº¦äº†å®¢æˆ·èŠèŠæ–°é¡¹ç›®ã€‚",
  "ç‹äº”": "å»æ¥¼ä¸‹å’–å•¡å…ä¹°æ¯å’–å•¡,é¡ºä¾¿æ”¾æ¾ä¸€ä¸‹ã€‚"
}
```

**ä¸‹åˆ3ç‚¹**:
```json
{
  "å¼ ä¸‰": "ä¸‹åˆç»§ç»­å†™ä»£ç ,è¿™ä¸ªåŠŸèƒ½å¿«å®Œæˆäº†ã€‚",
  "æå››": "åœ¨æ•´ç†äº§å“è·¯çº¿å›¾,ä¸‹å‘¨è¦ç”¨ã€‚",
  "ç‹äº”": "è®¾è®¡è¿›å…¥æ”¶å°¾é˜¶æ®µ,æ£€æŸ¥ç»†èŠ‚ä¸­..."
}
```

---

### æˆæœ¬èŠ‚çœå®ä¾‹

å‡è®¾æ¸¸æˆè¿è¡Œ8å°æ—¶ï¼ŒNPCæ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼š

**æ›´æ–°æ¬¡æ•°**:
```
8å°æ—¶ Ã— 60åˆ†é’Ÿ Ã— 2æ¬¡/åˆ†é’Ÿ = 960æ¬¡æ›´æ–°
```

**ä¼ ç»Ÿæ–¹å¼**:
```
960æ¬¡æ›´æ–° Ã— 3ä¸ªNPC = 2880æ¬¡LLMè°ƒç”¨
æˆæœ¬: 2880 Ã— 0.01å…ƒ = 28.8å…ƒ/å¤©
```

**æ‰¹é‡æ–¹å¼**:
```
960æ¬¡æ›´æ–° Ã— 1æ¬¡æ‰¹é‡è°ƒç”¨ = 960æ¬¡LLMè°ƒç”¨
æˆæœ¬: 960 Ã— 0.01å…ƒ = 9.6å…ƒ/å¤©
```

**èŠ‚çœ**:
```
æ¯å¤©èŠ‚çœ: 28.8 - 9.6 = 19.2å…ƒ (66.7%)
æ¯æœˆèŠ‚çœ: 19.2 Ã— 30 = 576å…ƒ
æ¯å¹´èŠ‚çœ: 576 Ã— 12 = 6912å…ƒ
```

**å¯¹äºå¤§è§„æ¨¡åº”ç”¨ï¼ŒèŠ‚çœæ›´æ˜æ˜¾ï¼**

---

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### â­â­â­â­â­ å¿…é¡»æŒæ¡

1. **æ‰¹é‡ä¼˜åŒ–åŸç†**
   - ä¸ºä»€ä¹ˆèƒ½èŠ‚çœ66%æˆæœ¬
   - ä»3æ¬¡è°ƒç”¨åˆ°1æ¬¡è°ƒç”¨
   - Tokenæ¶ˆè€—åˆ†æ

2. **æ‰¹é‡æç¤ºè¯è®¾è®¡**
   - å¦‚ä½•åœ¨ä¸€ä¸ªpromptä¸­åŒ…å«å¤šä¸ªNPC
   - JSONæ ¼å¼çš„é‡è¦æ€§
   - åœºæ™¯æè¿°çš„ä½œç”¨

3. **generate_batch_dialogues()æµç¨‹**
   - 5æ­¥å®Œæ•´æµç¨‹
   - LLMè°ƒç”¨æ–¹å¼
   - JSONè§£æéªŒè¯

### â­â­â­â­ é‡ç‚¹ç†è§£

4. **åœºæ™¯æ—¶é—´ç³»ç»Ÿ**
   - 6ä¸ªæ—¶é—´æ®µåˆ’åˆ†
   - åœºæ™¯æè¿°å¦‚ä½•å½±å“ç”Ÿæˆ
   - çœŸå®æ—¶é—´åŒæ­¥

5. **é™çº§æ–¹æ¡ˆè®¾è®¡**
   - é¢„è®¾å¯¹è¯åº“
   - å¤šå±‚å®¹é”™
   - å¥å£®æ€§ä¿è¯

### â­â­â­ å»ºè®®äº†è§£

6. **JSONæ ¼å¼éªŒè¯**
7. **å•ä¾‹æ¨¡å¼åº”ç”¨**
8. **é¢„è®¾å¯¹è¯è®¾è®¡**

---

## ğŸ¯ å®è·µç»ƒä¹ 

### ç»ƒä¹ 1: å¢åŠ ç¬¬4ä¸ªNPC

åœ¨ `agents.py` æ·»åŠ èµµå…­åï¼Œæ‰¹é‡ç”Ÿæˆè‡ªåŠ¨æ”¯æŒï¼š

```python
# NPC_ROLESæ·»åŠ èµµå…­
NPC_ROLES["èµµå…­"] = {...}

# æ‰¹é‡ç”Ÿæˆå™¨è‡ªåŠ¨åŒ…å«
# æ— éœ€ä¿®æ”¹batch_generator.pyä»£ç ï¼
dialogues = batch_gen.generate_batch_dialogues()
# è¿”å›: {"å¼ ä¸‰": "...", "æå››": "...", "ç‹äº”": "...", "èµµå…­": "..."}
```

**æ•°æ®é©±åŠ¨çš„å¨åŠ›**ï¼

---

### ç»ƒä¹ 2: è°ƒæ•´æ›´æ–°é¢‘ç‡

```python
# åŸå§‹: 30ç§’æ›´æ–°ä¸€æ¬¡
await asyncio.sleep(30)

# ä¿®æ”¹ä¸º: 60ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆæ›´çœæˆæœ¬ï¼‰
await asyncio.sleep(60)

# ä¿®æ”¹ä¸º: 15ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆæ›´æ–°æ›´é¢‘ç¹ï¼‰
await asyncio.sleep(15)
```

**æ€è€ƒ**: é¢‘ç‡å¦‚ä½•å½±å“æˆæœ¬å’Œä½“éªŒï¼Ÿ

---

### ç»ƒä¹ 3: æ·»åŠ æ–°çš„æ—¶é—´æ®µ

```python
def _get_current_context(self) -> str:
    hour = datetime.now().hour
    
    # æ–°å¢: æ·±å¤œæ—¶æ®µ
    if 0 <= hour < 6:
        return "æ·±å¤œæ—¶åˆ†,åŠå…¬å®¤ç©ºæ— ä¸€äºº,åªæœ‰æœåŠ¡å™¨åœ¨è¿è¡Œ"
    
    # æ–°å¢: åˆåæ—¶æ®µ
    elif 15 <= hour < 16:
        return "åˆåæ—¶å…‰,ä¸‹åˆèŒ¶æ—¶é—´,å¤§å®¶åœ¨èŠå¤©æ”¾æ¾"
    
    # ... å…¶ä»–æ—¶æ®µ
```

---

## ğŸ“Š ä»£ç è´¨é‡è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| åˆ›æ–°æ€§ | â­â­â­â­â­ | æ‰¹é‡ä¼˜åŒ–æ€æƒ³å·§å¦™ |
| æˆæœ¬æ•ˆç›Š | â­â­â­â­â­ | èŠ‚çœ66%æˆæœ¬ |
| å¥å£®æ€§ | â­â­â­â­â­ | å¤šå±‚é™çº§æ–¹æ¡ˆ |
| å¯æ‰©å±•æ€§ | â­â­â­â­â­ | æ•°æ®é©±åŠ¨ï¼Œæ˜“æ‰©å±• |
| ç”¨æˆ·ä½“éªŒ | â­â­â­â­ | æ—¶é—´æ„ŸçœŸå® |

**æ€»åˆ†**: 24/25 â­â­â­â­â­ (ä¼˜ç§€)

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼æ€»ç»“

### æŠ€æœ¯ä»·å€¼
1. **æˆæœ¬ä¼˜åŒ–** - 66%æˆæœ¬é™ä½
2. **æ€§èƒ½æå‡** - 66%å»¶è¿Ÿé™ä½
3. **èµ„æºé«˜æ•ˆ** - APIè°ƒç”¨æ¬¡æ•°é™ä½

### è®¾è®¡ä»·å€¼
1. **æ‰¹é‡æ€ç»´** - ä¸€æ¬¡è°ƒç”¨å®Œæˆå¤šä¸ªä»»åŠ¡
2. **æ ¼å¼åŒ–è¾“å‡º** - JSONç»“æ„åŒ–æ•°æ®
3. **é™çº§è®¾è®¡** - ç¡®ä¿ç³»ç»Ÿå¥å£®

### åº”ç”¨ä»·å€¼
1. **æ¸¸æˆçœŸå®æ„Ÿ** - æ—¶é—´ç³»ç»Ÿ+åœºæ™¯æè¿°
2. **å¯ç»´æŠ¤æ€§** - æ•°æ®é©±åŠ¨é…ç½®
3. **å¯æ‰©å±•æ€§** - è½»æ¾æ·»åŠ æ–°NPC

---

**å­¦ä¹ å®Œæˆæ—¶é—´**: é¢„è®¡1å°æ—¶  
**é‡è¦ç¨‹åº¦**: â­â­â­â­â­  
**ä¸‹ä¸€æ­¥**: å­¦ä¹ state_manager.pyï¼Œç†è§£å¦‚ä½•è°ƒç”¨æ‰¹é‡ç”Ÿæˆ
