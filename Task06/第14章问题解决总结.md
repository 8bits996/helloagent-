# ç¬¬14ç« é—®é¢˜è§£å†³æ€»ç»“ - DeepResearch Agent

**è§£å†³æ—¥æœŸ**: 2025-12-26  
**é—®é¢˜ç±»å‹**: ç½‘ç»œè¿æ¥é”™è¯¯  
**çŠ¶æ€**: âœ… å·²è§£å†³

---

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä½¿ç”¨ DeepResearch Agent æ—¶é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š
1. âœ… ç¬¬ä¸€æ¬¡ç ”ç©¶è¯·æ±‚æˆåŠŸ
2. âŒ ç¬¬äºŒæ¬¡åŠåç»­è¯·æ±‚å‡ºç° `network error`
3. âŒ æµè§ˆå™¨æ˜¾ç¤º: `Failed to load resource: net::ERR_CONNECTION_RESET`
4. âŒ åç«¯å°è¯•è¿æ¥ `localhost:11434` (Ollama) è€Œéé…ç½®çš„ç¡…åŸºæµåŠ¨ API

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡æ·±å…¥æ’æŸ¥ï¼Œå‘ç°äº†**ä¸¤ä¸ªå…³é”®é—®é¢˜**ï¼š

### 1. `.env` æ–‡ä»¶æœªè¢«åŠ è½½
**é—®é¢˜**: åç«¯ä»£ç  (`main.py`) ä¸­**æ²¡æœ‰ä½¿ç”¨ `python-dotenv` åŠ è½½ç¯å¢ƒå˜é‡**ï¼Œå¯¼è‡´ `.env` æ–‡ä»¶ä¸­çš„é…ç½®ï¼ˆåŒ…æ‹¬ LLM API é…ç½®ï¼‰å®Œå…¨è¢«å¿½ç•¥ã€‚

**åæœ**: 
- ç³»ç»Ÿä½¿ç”¨é»˜è®¤é…ç½® (Ollama on localhost:11434)
- ç¡…åŸºæµåŠ¨ API å¯†é’¥å’Œ URL æœªç”Ÿæ•ˆ
- å¯¼è‡´è¿æ¥è¢«æ‹’ç»é”™è¯¯

### 2. è‡ªåŠ¨é‡è½½å¯¼è‡´æœåŠ¡ä¸ç¨³å®š
**é—®é¢˜**: `main.py` ä¸­çš„ `uvicorn.run()` è®¾ç½®äº† `reload=True`ï¼Œå¯¼è‡´æœåŠ¡ä¸æ–­æ£€æµ‹æ–‡ä»¶å˜åŒ–å¹¶é‡å¯ã€‚

**åæœ**:
- æœåŠ¡é¢‘ç¹é‡å¯ï¼Œè¿æ¥è¢«ä¸­æ–­
- æ—¥å¿—ä¸­å‡ºç°å¤§é‡ `watchfiles.main: X changes detected` ä¿¡æ¯
- ç”¨æˆ·è¯·æ±‚å¯èƒ½åœ¨æœåŠ¡é‡å¯æ—¶å¤±è´¥

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1: æ·»åŠ  `.env` æ–‡ä»¶åŠ è½½

**æ–‡ä»¶**: `backend/src/main.py`

**ä¿®æ”¹å‰**:
```python
"""FastAPI entrypoint exposing the DeepResearchAgent via HTTP."""

from __future__ import annotations

import json
import sys
from typing import Any, Dict, Iterator, Optional

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse
from loguru import logger
from pydantic import BaseModel, Field

from config import Configuration, SearchAPI
from agent import DeepResearchAgent
```

**ä¿®æ”¹å**:
```python
"""FastAPI entrypoint exposing the DeepResearchAgent via HTTP."""

from __future__ import annotations

import json
import sys
import os
from pathlib import Path
from typing import Any, Dict, Iterator, Optional

from dotenv import load_dotenv  # ğŸ‘ˆ æ–°å¢
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse
from loguru import logger
from pydantic import BaseModel, Field

from config import Configuration, SearchAPI
from agent import DeepResearchAgent

# åŠ è½½ .env æ–‡ä»¶ ğŸ‘ˆ æ–°å¢
env_path = Path(__file__).parent.parent / '.env'
load_dotenv(dotenv_path=env_path)
```

### ä¿®å¤ 2: ç¦ç”¨è‡ªåŠ¨é‡è½½

**æ–‡ä»¶**: `backend/src/main.py`

**ä¿®æ”¹å‰**:
```python
if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,  # ğŸ‘ˆ é—®é¢˜æ‰€åœ¨
        log_level="info"
    )
```

**ä¿®æ”¹å**:
```python
if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=8000,
        reload=False,  # ğŸ‘ˆ ç¦ç”¨è‡ªåŠ¨é‡è½½ä»¥æé«˜ç¨³å®šæ€§
        log_level="info"
    )
```

---

## ğŸ§ª éªŒè¯æµ‹è¯•

åˆ›å»ºäº†æµ‹è¯•è„šæœ¬ `Task06/test_backend_api.py` æ¥éªŒè¯ä¿®å¤ï¼š

```python
# æµ‹è¯•å¥åº·æ£€æŸ¥
response = requests.get("http://localhost:8000/")

# æµ‹è¯•ç ”ç©¶åŠŸèƒ½
response = requests.post(
    "http://localhost:8000/research/stream",
    json={"topic": "Python 3.12"},
    stream=True,
    timeout=300
)
```

### æµ‹è¯•ç»“æœ
âœ… **æµ‹è¯•æˆåŠŸï¼å…±æ¥æ”¶ 4259 ä¸ªäº‹ä»¶**
- åç«¯æœåŠ¡ç¨³å®šè¿è¡Œ
- æ­£ç¡®è°ƒç”¨ç¡…åŸºæµåŠ¨ API (`https://api.siliconflow.cn/v1`)
- ç ”ç©¶è¯·æ±‚æˆåŠŸå®Œæˆï¼Œç”Ÿæˆäº†å®Œæ•´çš„ç ”ç©¶æŠ¥å‘Š
- æ²¡æœ‰è¿æ¥é”™è¯¯æˆ–æœåŠ¡é‡å¯

---

## ğŸ“Š é—®é¢˜å½±å“åˆ†æ

### ä¿®å¤å‰çš„é”™è¯¯æ—¥å¿—
```
httpcore.ConnectError: [WinError 10061] ç”±äºç›®æ ‡è®¡ç®—æœºç§¯ææ‹’ç»ï¼Œæ— æ³•è¿æ¥ã€‚
Request('POST', 'http://localhost:11434/v1/chat/completions')
openai.APIConnectionError: Connection error.
```

### ä¿®å¤åçš„æˆåŠŸæ—¥å¿—
```
INFO:     Started server process [45004]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     127.0.0.1:54375 - "POST /research/stream HTTP/1.1" 200 OK
```

---

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### 1. ç¯å¢ƒå˜é‡åŠ è½½çš„é‡è¦æ€§
- Python åº”ç”¨ä¸ä¼šè‡ªåŠ¨åŠ è½½ `.env` æ–‡ä»¶
- å¿…é¡»æ˜¾å¼ä½¿ç”¨ `python-dotenv` åº“çš„ `load_dotenv()` å‡½æ•°
- å»ºè®®åœ¨åº”ç”¨å…¥å£å¤„å°½æ—©åŠ è½½ç¯å¢ƒå˜é‡

### 2. å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒé…ç½®
- **å¼€å‘ç¯å¢ƒ**: `reload=True` ä¾¿äºå¼€å‘è°ƒè¯•
- **ç”Ÿäº§ç¯å¢ƒ**: `reload=False` ç¡®ä¿ç¨³å®šæ€§
- å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡åŠ¨æ€æ§åˆ¶è¯¥è¡Œä¸º

### 3. é…ç½®æ–‡ä»¶çš„åŠ è½½é¡ºåº
```
åº”ç”¨å¯åŠ¨
    â†“
åŠ è½½ .env æ–‡ä»¶ (load_dotenv)
    â†“
è¯»å–ç¯å¢ƒå˜é‡ (os.getenv)
    â†“
åˆ›å»ºé…ç½®å¯¹è±¡ (Configuration.from_env)
    â†“
åˆå§‹åŒ–æœåŠ¡
```

### 4. è°ƒè¯•æŠ€å·§
- æ£€æŸ¥æ—¥å¿—ä¸­çš„ API URLï¼ˆç¡®è®¤æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„ç«¯ç‚¹ï¼‰
- éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦è¢«æ­£ç¡®è¯»å–
- ä½¿ç”¨æµ‹è¯•è„šæœ¬å•ç‹¬éªŒè¯ API è¿æ¥
- æŸ¥çœ‹æœåŠ¡å¯åŠ¨æ—¥å¿—ä¸­çš„é…ç½®ä¿¡æ¯

---

## ğŸš€ åç»­å»ºè®®

### 1. ä»£ç æ”¹è¿›
```python
# å»ºè®®ï¼šæ·»åŠ ç¯å¢ƒå˜é‡éªŒè¯
def validate_env():
    required_vars = ['LLM_API_KEY', 'LLM_BASE_URL', 'LLM_MODEL_ID']
    missing = [var for var in required_vars if not os.getenv(var)]
    if missing:
        raise ValueError(f"Missing required environment variables: {missing}")

# åœ¨å¯åŠ¨æ—¶è°ƒç”¨
validate_env()
```

### 2. é…ç½®ä¼˜åŒ–
```ini
# æ¨èçš„ .env é…ç½®
# æœç´¢å¼•æ“
SEARCH_API=duckduckgo

# LLM é…ç½®
LLM_PROVIDER=custom
LLM_MODEL_ID=Qwen/Qwen2.5-7B-Instruct
LLM_API_KEY=your_api_key_here
LLM_BASE_URL=https://api.siliconflow.cn/v1
LLM_TIMEOUT=180

# ç ”ç©¶é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ï¼‰
MAX_WEB_RESEARCH_LOOPS=2
FETCH_FULL_PAGE=False
LOG_LEVEL=INFO
```

### 3. ç›‘æ§å»ºè®®
- æ·»åŠ  API è°ƒç”¨æˆåŠŸç‡ç›‘æ§
- è®°å½• API å“åº”æ—¶é—´
- ç›‘æ§æœåŠ¡é‡å¯æ¬¡æ•°
- è®¾ç½®å¼‚å¸¸å‘Šè­¦

---

## ğŸ“ æœ€ç»ˆé…ç½®

### æœåŠ¡çŠ¶æ€
```
ğŸŸ¢ åç«¯æœåŠ¡: http://localhost:8000
   - Provider: custom (ç¡…åŸºæµåŠ¨)
   - Model: Qwen/Qwen2.5-7B-Instruct
   - Search: DuckDuckGo
   - Reload: Disabled
   - çŠ¶æ€: ç¨³å®šè¿è¡Œ

ğŸŸ¢ å‰ç«¯æœåŠ¡: http://localhost:5174
   - Framework: Vue 3 + Vite
   - çŠ¶æ€: æ­£å¸¸è¿è¡Œ
```

### æµ‹è¯•å·¥å…·
- `Task06/test_backend_api.py` - åç«¯ API æµ‹è¯•è„šæœ¬
- å¯ç”¨äºå›å½’æµ‹è¯•å’ŒæŒç»­éªŒè¯

---

## âœ… é—®é¢˜è§£å†³æ¸…å•

- [x] è¯†åˆ«æ ¹æœ¬åŸå› ï¼ˆ.env æ–‡ä»¶æœªåŠ è½½ï¼‰
- [x] ä¿®å¤ç¯å¢ƒå˜é‡åŠ è½½é—®é¢˜
- [x] è§£å†³æœåŠ¡è‡ªåŠ¨é‡è½½é—®é¢˜
- [x] åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤
- [x] è¿è¡ŒæˆåŠŸæµ‹è¯•
- [x] ç¼–å†™è§£å†³æ–¹æ¡ˆæ–‡æ¡£
- [x] æ€»ç»“å­¦ä¹ è¦ç‚¹

---

## ğŸ“ ç»éªŒæ€»ç»“

è¿™æ¬¡é—®é¢˜æ’æŸ¥å±•ç¤ºäº†**é…ç½®ç®¡ç†**å’Œ**æœåŠ¡ç¨³å®šæ€§**çš„é‡è¦æ€§ï¼š

1. **é…ç½®åŠ è½½æ˜¯åŸºç¡€**: å³ä½¿é…ç½®æ–‡ä»¶å†™å¾—å†å®Œç¾ï¼Œå¦‚æœæ²¡æœ‰è¢«æ­£ç¡®åŠ è½½ï¼Œä¹Ÿæ¯«æ— æ„ä¹‰
2. **å¼€å‘ä¾¿åˆ© vs ç”Ÿäº§ç¨³å®š**: éœ€è¦åœ¨ä¸¤è€…ä¹‹é—´åšå‡ºæƒè¡¡
3. **æ—¥å¿—æ˜¯æœ€å¥½çš„æœ‹å‹**: é€šè¿‡æ—¥å¿—å¿«é€Ÿå®šä½åˆ°é”™è¯¯çš„ API ç«¯ç‚¹
4. **æµ‹è¯•é©±åŠ¨ä¿®å¤**: åˆ›å»ºè‡ªåŠ¨åŒ–æµ‹è¯•ç¡®ä¿é—®é¢˜çœŸæ­£è§£å†³

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼ŒDeepResearch Agent ç°åœ¨å¯ä»¥ç¨³å®šè¿è¡Œï¼ŒæˆåŠŸä½¿ç”¨ç¡…åŸºæµåŠ¨ API è¿›è¡Œç ”ç©¶ä»»åŠ¡ï¼

---

**è§£å†³æ—¶é—´**: 2025-12-26 16:30  
**è§£å†³äººå‘˜**: CodeBuddy Code  
**æœ€ç»ˆçŠ¶æ€**: âœ… å®Œå…¨è§£å†³ï¼ŒæœåŠ¡ç¨³å®šè¿è¡Œ
