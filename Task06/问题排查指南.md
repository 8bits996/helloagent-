# 问题排查指南

## 🔍 当前问题

根据截图，存在以下严重问题：
1. **地图完全空白** - 没有底图，没有标记
2. **景点内容全是模板** - 没有实际的景点名称、地址、描述
3. **没有图片显示**

## 🎯 问题根源分析

这些问题说明：**后端根本没有生成真实的旅行计划数据**，前端显示的都是空模板。

可能的原因：
1. ❌ 您没有在首页生成旅行计划，直接访问了结果页
2. ❌ 后端Agent调用失败，但没有报错
3. ❌ 高德地图API调用失败
4. ❌ LLM配置有问题

## 📋 排查步骤

### 第1步：确认是否生成了计划

**操作**：
1. 打开 http://localhost:5173
2. 在首页填写：
   - 目的地城市：北京
   - 开始日期：2025-12-28
   - 结束日期：2025-12-30
   - 旅行天数：3
3. 点击"生成旅行计划"按钮
4. **等待30-60秒**（生成计划需要时间）
5. 查看是否跳转到结果页

**检查要点**：
- 按钮是否显示"生成中..."
- 是否有进度提示
- 是否有错误提示

### 第2步：查看浏览器控制台

**操作**：
1. 按F12打开开发者工具
2. 切换到Console标签
3. 重新生成计划
4. 查看是否有红色错误信息

**截图给我看**：
- 任何红色错误
- API请求的响应内容

### 第3步：查看后端日志

**操作**：
1. 找到运行后端的PowerShell窗口
2. 查看是否有错误信息
3. 特别关注：
   - "❌" 开头的错误
   - "MCP" 相关的错误
   - "API Key" 相关的错误

**截图给我看**：
- 后端启动时的日志
- 生成计划时的日志

### 第4步：测试后端API（高级）

打开新的PowerShell窗口，运行：

```powershell
# 测试生成旅行计划API
$body = @{
    city = "北京"
    start_date = "2025-12-28"
    end_date = "2025-12-30"
    num_days = 3
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/api/trip/plan" -Method Post -Body $body -ContentType "application/json" -TimeoutSec 120
```

**结果分析**：
- ✅ 如果返回了详细的旅行计划JSON → 后端正常
- ❌ 如果报错 → 记录错误信息
- ⏳ 如果超时 → 后端处理太慢或卡住

## 🚨 常见问题

### 问题1：直接访问结果页
**现象**：地图空白，内容全是模板
**原因**：没有先在首页生成计划
**解决**：必须从首页开始，填写信息并生成计划

### 问题2：高德地图API Key无效
**现象**：地图空白但有标记
**检查**：
```powershell
# 测试高德API Key
curl "https://restapi.amap.com/v3/place/text?keywords=故宫&city=北京&key=3fb674a8c918bfcf5c6c310c4a3adba8"
```

**预期结果**：返回景点JSON数据
**如果失败**：说明API Key有问题

### 问题3：MCP服务器未安装
**现象**：后端日志显示MCP相关错误
**解决**：
```powershell
cd C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter13\helloagents-trip-planner\backend
.\venv\Scripts\pip.exe install amap-mcp-server
```

### 问题4：LLM配置问题
**现象**：后端卡住不动，没有生成计划
**检查**：backend/.env中的LLM配置是否正确

## 🔧 快速修复尝试

### 方案1：完全重新开始

```powershell
# 1. 停止所有服务
Get-Process | Where-Object { $_.ProcessName -in @("python", "node") } | Stop-Process -Force

# 2. 清理浏览器缓存
# 按Ctrl+Shift+Delete，清除缓存

# 3. 重启服务
cd C:\Users\frankechen\CFP-Study\Task06
.\重启服务.ps1

# 4. 等待服务完全启动（约10秒）

# 5. 访问首页生成计划
# http://localhost:5173
```

### 方案2：检查端口占用

```powershell
# 检查8000端口
netstat -ano | findstr ":8000"

# 检查5173端口
netstat -ano | findstr ":5173"
```

## 📸 需要提供的信息

为了帮您解决问题，请提供：

1. **浏览器控制台截图**（F12 → Console标签）
2. **后端日志截图**（运行uvicorn的PowerShell窗口）
3. **首页截图**（确认您是从首页还是直接访问结果页）
4. **生成过程截图**（点击生成按钮后的状态）

## ⚡ 最可能的原因

根据经验，90%的可能性是：
**您直接访问了结果页面（http://localhost:5173/result），而没有先在首页生成计划**

**正确流程**：
1. 访问 http://localhost:5173（首页）
2. 填写旅行信息
3. 点击"生成旅行计划"
4. 等待30-60秒
5. 自动跳转到结果页
6. 查看生成的计划

如果您直接访问结果页，sessionStorage中没有数据，所以显示的都是空模板。
