# 第15章 - 赛博小镇完整启动指南

**创建日期**: 2025-12-27  
**目标**: 30分钟内完整运行赛博小镇游戏

---

## 🎯 快速导航

**已完成**:
- ✅ 后端虚拟环境创建
- ✅ 依赖包安装（43个包）
- ✅ .env 配置（硅基流动 API）

**待完成**:
- ⏳ 下载并安装 Godot
- ⏳ 启动后端服务
- ⏳ 导入 Godot 项目
- ⏳ 运行游戏

---

## 📥 第一步：下载并安装 Godot（10分钟）

### 方式1：使用下载脚本（推荐）✨

1. **打开文件资源管理器**
   ```
   按 Win+E 打开文件资源管理器
   ```

2. **导航到 Godot 目录**
   ```
   地址栏输入: C:\Godot
   按 Enter
   ```

3. **运行下载脚本**
   ```
   右键点击: 下载Godot.ps1
   选择: "使用 PowerShell 运行"
   ```

4. **等待下载完成**
   - 文件大小: 约 100 MB
   - 下载时间: 1-5 分钟（取决于网速）
   - 脚本会自动解压并创建桌面快捷方式

5. **启动 Godot**
   - 脚本完成后会询问是否启动
   - 或双击桌面的 "Godot" 快捷方式

### 方式2：手动下载（备选）

如果脚本下载失败，请手动下载：

1. **访问下载页面**
   ```
   浏览器打开: https://godotengine.org/download/windows/
   ```

2. **下载 Godot 4.3 Standard**
   - 点击 "Download" 按钮
   - 选择 64位版本
   - **注意**: 不要下载 .NET 版本

3. **解压文件**
   ```
   下载的文件: Godot_v4.3-stable_win64.exe.zip
   解压到: C:\Godot\
   ```

4. **启动 Godot**
   ```
   双击: C:\Godot\Godot_v4.3-stable_win64.exe
   ```

---

## 🚀 第二步：启动后端服务（2分钟）

### 使用启动脚本（推荐）

1. **打开文件资源管理器**
   ```
   Win+E
   ```

2. **导航到后端目录**
   ```
   地址栏输入:
   C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\backend
   按 Enter
   ```

3. **运行启动脚本**
   ```
   右键点击: 启动后端.ps1
   选择: "使用 PowerShell 运行"
   ```

4. **确认服务启动**
   看到以下输出表示成功：
   ```
   ============================================================
   🎮 赛博小镇后端服务启动中...
   ============================================================
   🤖 正在初始化NPC Agent系统...
   ✅ LLM初始化成功
   ✅ 记忆管理器初始化完成
   ✅ 好感度管理器初始化完成
   ✅ 创建NPC: 张三 (Python工程师)
   ✅ 创建NPC: 李四 (产品经理)
   ✅ 创建NPC: 王五 (UI设计师)
   
   ✅ 所有服务已启动!
   📡 API地址: http://0.0.0.0:8000
   📚 API文档: http://0.0.0.0:8000/docs
   ============================================================
   INFO:     Started server process [xxxxx]
   INFO:     Waiting for application startup.
   INFO:     Application startup complete.
   INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
   ```

5. **保持窗口运行**
   - ⚠️ **不要关闭这个窗口**
   - 后端服务需要持续运行
   - 可以最小化窗口

### 手动启动（备选）

如果脚本无法运行：

```powershell
# 打开 PowerShell
# 输入以下命令：

cd C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\backend
.\venv\Scripts\Activate.ps1
python main.py
```

---

## 🎮 第三步：导入 Godot 项目（3分钟）

### 1. 启动 Godot

- 双击桌面的 "Godot" 快捷方式
- 或运行 `C:\Godot\Godot_v4.3-stable_win64.exe`

### 2. 首次启动界面

你会看到：
```
┌─────────────────────────────────────────┐
│       Godot Engine 4.3                  │
├─────────────────────────────────────────┤
│                                         │
│   [新建]   [导入]   [扫描]              │
│                                         │
│   最近项目: (空)                         │
│                                         │
└─────────────────────────────────────────┘
```

### 3. 导入项目

1. **点击 "导入" 按钮**

2. **浏览项目目录**
   - 点击 "浏览" 按钮
   - 导航到:
     ```
     C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\helloagents-ai-town
     ```
   - 选择 `project.godot` 文件
   - 点击 "打开"

3. **确认导入**
   - 点击 "导入并编辑"
   - 等待项目加载（首次可能需要10-30秒）

### 4. 项目导入成功

你会看到 Godot 编辑器界面：
```
┌────────────────────────────────────────────────────────┐
│  Godot - helloagents-ai-town                          │
├────────────────────────────────────────────────────────┤
│  场景  脚本  资源管理器  [运行] [调试] [导出]          │
├─────────────┬──────────────────────┬──────────────────┤
│             │                      │                  │
│  场景树     │   2D 视图            │   检查器         │
│             │                      │                  │
│  Main       │   [游戏场景预览]     │   节点属性       │
│  ├Player    │                      │                  │
│  ├NPCs      │                      │                  │
│  └UI        │                      │                  │
│             │                      │                  │
├─────────────┴──────────────────────┴──────────────────┤
│  [输出] [调试器] [控制台]                              │
└────────────────────────────────────────────────────────┘
```

---

## 🎉 第四步：运行游戏（1分钟）

### 1. 运行游戏

- 点击右上角的 **"运行"** 按钮（▶ 图标）
- 或按键盘 **F5**

### 2. 选择主场景（仅首次）

- 如果首次运行，会提示选择主场景
- 选择: `scenes/main.tscn`
- 点击 "选择"

### 3. 游戏窗口打开

你会看到：
```
┌────────────────────────────────────────┐
│  赛博小镇 - AI NPC 对话系统            │
├────────────────────────────────────────┤
│                                        │
│      [建筑物]                          │
│                                        │
│    张三 💬  "正在写代码..."             │
│                                        │
│         👤 (玩家)                      │
│                                        │
│    李四 💬  "整理需求文档..."           │
│                                        │
│      [建筑物]   王五 💬                │
│                                        │
└────────────────────────────────────────┘
```

### 4. 游戏控制

- **WASD**: 移动玩家
- **E**: 与 NPC 交互（走到 NPC 附近）
- **Enter**: 发送消息
- **ESC**: 关闭对话框

---

## ✅ 第五步：测试功能（5分钟）

### 测试清单

1. **移动玩家** ✓
   - 按 WASD 键移动
   - 确认玩家可以正常移动

2. **与张三对话** ✓
   - 走到张三附近
   - 看到提示 "E to talk"
   - 按 E 键打开对话框
   - 输入: "你好，你是做什么的？"
   - 按 Enter 发送
   - 等待 NPC 回复

3. **与李四对话** ✓
   - 关闭对话框（按 ESC）
   - 走到李四附近
   - 按 E 键对话
   - 输入: "你好，能介绍一下你的工作吗？"
   - 观察回复

4. **与王五对话** ✓
   - 走到王五附近
   - 按 E 键对话
   - 输入: "你好，你喜欢什么设计风格？"
   - 观察回复

5. **测试好感度** ✓
   - 重复与同一个 NPC 对话
   - 说一些夸奖的话
   - 观察 NPC 的态度变化

6. **测试记忆** ✓
   - 与 NPC 提到某个话题
   - 关闭对话
   - 重新对话时再次提到
   - 看 NPC 是否记得

---

## 🐛 故障排查

### 问题1: 后端服务启动失败

**症状**: 看到 Python 错误或服务无法启动

**解决方案**:
```powershell
# 1. 检查虚拟环境
cd C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\backend
Test-Path .\venv

# 2. 重新激活虚拟环境
.\venv\Scripts\Activate.ps1

# 3. 检查 .env 文件
Test-Path .\.env
Get-Content .\.env

# 4. 重新安装依赖
pip install -r requirements.txt --force-reinstall

# 5. 手动启动
python main.py
```

### 问题2: Godot 导入失败

**症状**: 项目无法导入或报错

**解决方案**:
1. 确认 Godot 版本 >= 4.2
2. 确认选择了 `project.godot` 文件
3. 尝试关闭 Godot，删除项目中的 `.godot` 文件夹
4. 重新导入项目

### 问题3: 游戏运行但无法对话

**症状**: NPC 不回复或报错

**解决方案**:
1. **检查后端服务**
   - 确认后端窗口还在运行
   - 查看是否有错误信息

2. **检查 API 连接**
   - 在浏览器打开: http://localhost:8000
   - 应该看到 JSON 响应

3. **查看 Godot 控制台**
   - 在 Godot 底部的 "输出" 面板
   - 查看是否有网络错误

4. **检查 API 配置**
   - 打开 Godot 项目
   - 找到 `scripts/config.gd`
   - 确认 `API_BASE_URL = "http://localhost:8000"`

### 问题4: LLM API 错误

**症状**: 后端日志显示 API 调用失败

**解决方案**:
1. **检查 .env 文件**
   ```powershell
   cd backend
   Get-Content .\.env
   ```

2. **确认 API 密钥正确**
   ```ini
   LLM_API_KEY=YOUR_LLM_API_KEY_HERE
   LLM_BASE_URL=https://api.siliconflow.cn/v1
   LLM_MODEL_ID=Qwen/Qwen2.5-7B-Instruct
   ```

3. **测试 API 连接**
   ```powershell
   # 在后端目录
   .\venv\Scripts\Activate.ps1
   python
   ```
   ```python
   from openai import OpenAI
   client = OpenAI(
       api_key="YOUR_LLM_API_KEY_HERE",
       base_url="https://api.siliconflow.cn/v1"
   )
   response = client.chat.completions.create(
       model="Qwen/Qwen2.5-7B-Instruct",
       messages=[{"role": "user", "content": "你好"}]
   )
   print(response.choices[0].message.content)
   ```

### 问题5: NPC 不移动

**症状**: NPC 站着不动

**解决方案**:
- 这是正常的，NPC 会随机巡逻
- 等待 2-5 秒，NPC 会开始移动
- 巡逻是随机的，不是持续的

---

## 📊 完整启动检查清单

### 后端检查 ✓
- [ ] 虚拟环境存在: `backend\venv\`
- [ ] .env 文件存在并配置正确
- [ ] 后端服务成功启动
- [ ] 看到 "✅ 所有服务已启动!" 消息
- [ ] 可以访问 http://localhost:8000

### Godot 检查 ✓
- [ ] Godot 4.3 已安装
- [ ] 项目成功导入
- [ ] 可以看到 main 场景
- [ ] 无错误信息

### 游戏测试 ✓
- [ ] 游戏窗口成功打开
- [ ] 可以看到玩家和 3 个 NPC
- [ ] 玩家可以移动（WASD）
- [ ] 可以与 NPC 对话（E 键）
- [ ] NPC 能够回复消息
- [ ] 后端日志显示对话记录

---

## 🎯 成功标志

当你看到以下所有内容时，说明一切正常：

1. ✅ **后端窗口**
   ```
   INFO:     Uvicorn running on http://0.0.0.0:8000
   ```

2. ✅ **Godot 编辑器**
   - 项目已打开
   - 无错误提示

3. ✅ **游戏窗口**
   - 玩家可以移动
   - 可以看到 3 个 NPC
   - NPC 有对话气泡

4. ✅ **对话功能**
   - 按 E 键打开对话框
   - 输入消息后能收到回复
   - 回复内容符合 NPC 角色

5. ✅ **后端日志**
   ```
   [INFO] 收到对话请求: 玩家 -> 张三
   [INFO] 收到NPC回复: 张三 -> ...
   ```

---

## 🚀 下一步学习

完成启动后，你可以：

1. **深入体验** (30分钟)
   - 与每个 NPC 多次对话
   - 测试好感度变化
   - 测试记忆系统
   - 观察 NPC 巡逻行为

2. **查看代码** (1-2小时)
   - 阅读 `backend/agents.py`
   - 阅读 `scripts/player.gd`
   - 理解前后端通信

3. **进入学习** (3-4天)
   - 按照 `第15章-学习路线图.md`
   - 深入学习后端和前端
   - 完成实践项目

---

## 📞 需要帮助？

如果遇到问题：

1. **查看日志**
   - 后端: PowerShell 窗口
   - 前端: Godot 输出面板

2. **检查本文档的"故障排查"部分**

3. **询问 AI 助手**
   - 我随时在这里帮助你！

---

**准备好了吗？让我们开始吧！** 🎉

1. 运行 `C:\Godot\下载Godot.ps1` 下载 Godot
2. 运行 `backend\启动后端.ps1` 启动后端
3. 打开 Godot 并导入项目
4. 按 F5 运行游戏

**Let's play!** 🚀

---

**创建时间**: 2025-12-27  
**预计用时**: 30 分钟  
**难度**: ⭐⭐⭐ (中等)
