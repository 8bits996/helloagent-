# 第14章问题排查

**问题时间**: 2025-12-26  
**问题类型**: 网络连接错误

---

## 🐛 问题描述

### 现象
1. ✅ 第一次研究请求成功，生成了4个任务的notes
2. ❌ 创建新的研究时出现 `network error`
3. ❌ 浏览器控制台显示: `Failed to load resource: net::ERR_CONNECTION_RESET`
4. ❌ 前端 WebSocket 连接失败

### 错误日志
```
:8000/research/stream:1  Failed to load resource: net::ERR_CONNECTION_RESET
client:1035 WebSocket connection to 'ws://localhost:5174/' failed
```

---

## 🔍 问题分析

### 根本原因
后端服务在处理研究请求时崩溃或超时，导致连接被重置。

### 可能的具体原因

1. **LLM API 调用问题**
   - API 超时
   - API 限流
   - 网络不稳定

2. **后端资源不足**
   - 内存占用过高
   - CPU 占用过高
   - 任务执行时间过长

3. **代码bug**
   - 异常处理不完善
   - 错误没有被正确捕获

---

## 🔧 解决方案

### 方案1: 调整超时和限制参数

修改 `backend/.env`:
```ini
# 增加超时时间
LLM_TIMEOUT=180

# 减少研究循环次数
MAX_WEB_RESEARCH_LOOPS=2

# 禁用完整页面获取（减少数据量）
FETCH_FULL_PAGE=False
```

### 方案2: 使用更简单的研究主题

避免使用过于复杂的主题，例如：
- ❌ "deepreseach的最新进展" （太模糊）
- ✅ "Python 3.12新特性"（具体明确）
- ✅ "Vue 3性能优化技巧"（范围明确）

### 方案3: 直接使用后端 API 测试

跳过前端，直接测试后端：

```bash
# 使用 curl 测试
curl -X POST http://localhost:8000/research/stream \
  -H "Content-Type: application/json" \
  -d '{"topic":"Python最新版本"}'
```

或使用 Python:
```python
import requests

response = requests.post(
    "http://localhost:8000/research/stream",
    json={"topic": "Python最新版本"},
    stream=True,
    timeout=300
)

for line in response.iter_lines():
    if line:
        print(line.decode())
```

### 方案4: 查看详细错误日志

重启后端服务并查看详细日志：
```powershell
cd backend
python src\main.py
```

观察控制台输出，找到具体的错误信息。

### 方案5: 使用更小的模型

如果是模型响应慢导致超时，可以换用更小的模型：

修改 `backend/.env`:
```ini
# 使用更小更快的模型
LLM_MODEL_ID=Qwen/Qwen2.5-3B-Instruct
```

---

## 💡 建议的配置

### 稳定配置（推荐）
```ini
# backend/.env

# 搜索引擎
SEARCH_API=duckduckgo

# LLM配置
LLM_PROVIDER=custom
LLM_MODEL_ID=Qwen/Qwen2.5-3B-Instruct  # 使用更小的模型
LLM_API_KEY=YOUR_LLM_API_KEY_HERE
LLM_BASE_URL=https://api.siliconflow.cn/v1
LLM_TIMEOUT=180  # 增加超时

# 服务器配置
HOST=0.0.0.0
PORT=8000
CORS_ORIGINS=http://localhost:5173,http://localhost:5174

# 研究配置
MAX_WEB_RESEARCH_LOOPS=2  # 减少循环次数
FETCH_FULL_PAGE=False     # 不获取完整页面
LOG_LEVEL=DEBUG           # 启用详细日志
```

---

## 🎯 测试步骤

### 1. 重启服务
```powershell
# 停止当前服务（Ctrl+C）

# 重新启动后端
cd backend
python src\main.py

# 重新启动前端（新窗口）
cd frontend
npm run dev
```

### 2. 使用简单主题测试
在前端输入简单明确的主题：
- "Python 3.12"
- "Vue 3"  
- "FastAPI"

### 3. 观察日志
注意观察后端控制台的输出，查找错误信息。

---

## 📝 当前状态

- ✅ 第一次研究成功
- ❌ 第二次研究失败
- ⚠️ 后端可能不稳定
- ⚠️ 需要调整配置或修复代码

---

## 🔗 相关文件

- 后端配置: `backend/.env`
- 后端入口: `backend/src/main.py`
- 研究Agent: `backend/src/agent.py`
- 错误日志: 后端控制台输出

---

**创建时间**: 2025-12-26  
**状态**: 待解决
