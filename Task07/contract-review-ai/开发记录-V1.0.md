# 合同评审AI系统 V1.0 开发记�?
## 项目概述

**项目名称**: 合同评审AI系统 (Contract Review AI)  
**版本**: V1.0  
**仓库地址**: https://github.com/yourusername/contract-review-ai  
**开发周�?*: CFP-Study Task07 毕业设计项目  
**完成时间**: 2025-12-29

---

## 一、项目规�?
### 1.1 项目背景

本项目是 Hello Agents 课程 Task07 毕业设计，目标是构建一个基于大语言模型的智能合同评审系统�?
### 1.2 技术栈选型

| 组件 | 技�?| 说明 |
|------|------|------|
| 后端框架 | FastAPI | 异步高性能 API 框架 |
| 前端框架 | Streamlit | Python Web UI 框架 |
| 文档解析 | MarkItDown | 微软开源文档转换工�?|
| AI引擎 | CodeBuddy CLI | 智能评审引擎 |
| 数据存储 | SQLite | 轻量级数据库 |
| 知识�?| CSV/Excel | 评审规则和检查清�?|

### 1.3 系统架构

```
┌─────────────────────────────────────────────────────────────�?�?                   Streamlit 前端 (8501)                     �?├─────────────────────────────────────────────────────────────�?�?                   FastAPI 后端 (8000)                       �?├──────────────┬──────────────┬──────────────┬────────────────�?�?MarkItDown   �?CodeBuddy    �?Report       �?Knowledge      �?�?文档解析     �?CLI 评审     �?Generator    �?Base Manager   �?├──────────────┴──────────────┴──────────────┴────────────────�?�?                   SQLite + 文件系统                         �?└─────────────────────────────────────────────────────────────�?```

---

## 二、开发过�?
### 2.1 Phase 1: 报告生成模块开�?
#### 2.1.1 创建报告生成�?(`app/services/report_generator.py`)

**功能**:
- Markdown 摘要报告生成
- Excel 综合报告 (5个工作表)
- 风险矩阵 CSV
- 合规检�?CSV
- ZIP 打包

**关键代码结构**:
```python
class ReportGenerator:
    def generate_all_reports(self, task_id, review_result, output_dir, contract_name)
    def generate_markdown_summary(self, review_result, output_path, contract_name, task_id)
    def generate_excel_report(self, review_result, output_path, contract_name)
    def generate_risk_matrix_csv(self, review_result, output_path)
    def generate_compliance_csv(self, review_result, output_path)
    def create_zip_package(self, output_dir, task_id)
```

#### 2.1.2 集成到主程序

**修改文件**: `app/main.py`

**新增 API 端点**:
```
GET  /api/report/{task_id}/summary      - 下载管理层摘�?GET  /api/report/{task_id}/excel        - 下载Excel报告
GET  /api/report/{task_id}/risk-matrix  - 下载风险矩阵
GET  /api/report/{task_id}/compliance   - 下载合规报告
GET  /api/report/{task_id}/zip          - 下载全部报告
GET  /api/report/{task_id}/list         - 列出可用报告
```

### 2.2 Phase 2: HTML 专业报告开�?
#### 2.2.1 创建 HTML 报告生成�?(`app/services/html_report_generator.py`)

**功能**:
- 5个页�? 决策总览、风险详情、合规检查、修改建议、缺失条�?- 专业视觉设计 (渐变色、卡片、图�?
- 响应式布局
- JavaScript 页签切换
- 打印优化

**文件大小**: 700+ 行代�?
**关键方法**:
```python
class HTMLReportGenerator:
    def generate_html_report(self, review_result, output_path, contract_name, task_id)
    def _generate_overview_tab(self, result)      # 决策总览
    def _generate_risks_tab(self, result)         # 风险详情
    def _generate_compliance_tab(self, result)    # 合规检�?    def _generate_recommendations_tab(self, result) # 修改建议
    def _generate_missing_tab(self, result)       # 缺失条款
```

#### 2.2.2 新增 API 端点

```
GET  /api/report/{task_id}/html          - 下载HTML报告
GET  /api/report/{task_id}/html/preview  - 浏览器预览HTML
```

### 2.3 Phase 3: 知识库管理模�?
#### 2.3.1 创建知识库管理器 (`app/services/knowledge_base_manager.py`)

**功能**:
- 文件上传/删除
- 元数据管�?(JSON)
- 文件预览
- 备份功能
- ZIP 导入/导出

**关键方法**:
```python
class KnowledgeBaseManager:
    def list_knowledge_bases(self)
    def upload_knowledge_base(self, filename, content, display_name, description, category)
    def delete_knowledge_base(self, filename, backup)
    def get_knowledge_base_detail(self, filename)
    def update_knowledge_base_meta(self, filename, ...)
    def export_all(self, output_path)
    def import_from_zip(self, zip_path, overwrite)
```

#### 2.3.2 知识�?API 端点

```
GET    /api/knowledge-base/list                    - 列出所有文�?POST   /api/knowledge-base/upload                  - 上传文件
DELETE /api/knowledge-base/{filename}              - 删除文件
GET    /api/knowledge-base/{filename}/preview      - 预览内容
GET    /api/knowledge-base/{filename}/download     - 下载文件
PUT    /api/knowledge-base/{filename}/metadata     - 更新元数�?POST   /api/knowledge-base/export                  - 导出ZIP
POST   /api/knowledge-base/import                  - 导入ZIP
```

### 2.4 Phase 4: 任务历史管理模块

#### 2.4.1 创建任务历史管理�?(`app/services/task_history_manager.py`)

**功能**:
- SQLite 持久化存�?- 任务 CRUD 操作
- 统计分析
- 搜索功能
- 旧数据清�?
**数据库表结构**:
```sql
-- 任务�?CREATE TABLE tasks (
    task_id TEXT PRIMARY KEY,
    status TEXT NOT NULL,
    progress INTEGER DEFAULT 0,
    message TEXT,
    contract_name TEXT,
    file_count INTEGER,
    total_size INTEGER,
    risk_level TEXT,
    created_at TEXT,
    updated_at TEXT,
    completed_at TEXT,
    review_mode TEXT,
    duration_seconds INTEGER
);

-- 任务文件�?CREATE TABLE task_files (
    id INTEGER PRIMARY KEY,
    task_id TEXT,
    filename TEXT,
    file_size INTEGER,
    file_type TEXT
);

-- 评审摘要�?CREATE TABLE review_summaries (
    task_id TEXT PRIMARY KEY,
    overall_assessment TEXT,
    risk_level TEXT,
    high_risk_count INTEGER,
    medium_risk_count INTEGER,
    low_risk_count INTEGER,
    ...
);
```

#### 2.4.2 任务历史 API 端点

```
GET    /api/history/list                 - 获取历史列表
GET    /api/history/statistics           - 获取统计信息
GET    /api/history/search               - 搜索任务
POST   /api/history/cleanup              - 清理旧任�?GET    /api/history/{task_id}            - 获取任务详情
DELETE /api/history/{task_id}            - 删除任务
```

### 2.5 Phase 5: 前端界面升级

#### 2.5.1 前端 v3.0 (`app/frontend.py`)

**新增页面**:
1. 📤 上传评审 - 文件上传和评审启�?2. 📊 任务状�?- 实时进度监控
3. 📈 评审结果 - 可视化结果展�?4. 📚 知识库管�?- 知识库文件管�?5. 📜 任务历史 - 历史记录查询
6. ⚙️ 系统设置 - 系统配置

**新增功能**:
- 知识库文件列表、上传、预览、删�?- 任务历史统计卡片
- 任务搜索和过�?- 数据清理功能

---

## 三、排错记�?
### 3.1 配置错误: DATA_DIR 缺失

**错误信息**:
```
AttributeError: 'Settings' object has no attribute 'DATA_DIR'
```

**原因**: `app/config.py` 中未定义 `DATA_DIR` 属�?
**修复**:
```python
# app/config.py
class Settings(BaseSettings):
    # 文件存储路径
    DATA_DIR: Path = Path("data")  # 新增
    UPLOAD_DIR: Path = Path("data/uploads")
    OUTPUT_DIR: Path = Path("data/outputs")
    KB_DIR: Path = Path("知识�?)
```

**执行命令**:
```powershell
cd "/path/to/contract-review-ai"
python -m py_compile app/config.py  # 验证语法
```

### 3.2 API 路由冲突

**错误信息**:
```
GET /api/history/statistics 返回 404 "任务不存�?
```

**原因**: FastAPI 路由匹配顺序问题，`/api/history/{task_id}` �?`/api/history/statistics` 之前定义，导�?`statistics` 被当�?`task_id` 参数

**修复**: 调整路由定义顺序，将带参数的路由放在最�?
```python
# 正确顺序
@app.get("/api/history/list")           # 1. 固定路径
@app.get("/api/history/statistics")     # 2. 固定路径
@app.get("/api/history/search")         # 3. 固定路径
@app.post("/api/history/cleanup")       # 4. 固定路径
@app.get("/api/history/{task_id}")      # 5. 参数路径 (最�?
@app.delete("/api/history/{task_id}")   # 6. 参数路径 (最�?
```

### 3.3 知识�?API 方法名不匹配

**错误信息**:
```
'KnowledgeBaseManager' object has no attribute 'list_files'
```

**原因**: `main.py` 中调用的方法名与 `KnowledgeBaseManager` 类中定义的不一�?
**修复对照�?*:
| main.py 错误调用 | 正确方法�?|
|-----------------|-----------|
| `kb_manager.list_files()` | `kb_manager.list_knowledge_bases()` |
| `kb_manager.add_file()` | `kb_manager.upload_knowledge_base()` |
| `kb_manager.delete_file()` | `kb_manager.delete_knowledge_base()` |
| `kb_manager.preview_file()` | `kb_manager.get_knowledge_base_detail()` |
| `kb_manager.update_metadata()` | `kb_manager.update_knowledge_base_meta()` |

### 3.4 前端预览功能报错

**错误信息**:
```
AttributeError: 'bool' object has no attribute 'get'
File "frontend.py", line 1010, in <module>
    if preview_data.get("success"):
```

**原因**: `preview_knowledge_base()` 返回元组 `(success, data)`，但直接�?`success` 存入�?session_state

**修复**:
```python
# 修复�?if st.button("👁�?预览", key=f"preview_{file_info['filename']}"):
    success, preview_data = preview_knowledge_base(file_info['filename'])
    if success:
        st.session_state[f"preview_{file_info['filename']}"] = preview_data

# 修复�?if st.button("👁�?预览", key=f"preview_btn_{file_info['filename']}"):
    success, preview_data = preview_knowledge_base(file_info['filename'])
    if success and isinstance(preview_data, dict):
        st.session_state[f"preview_{file_info['filename']}"] = preview_data
    else:
        st.error("预览失败")
```

### 3.5 端口占用问题

**错误信息**:
```
ERROR: [Errno 10048] error while attempting to bind on address ('0.0.0.0', 8000)
```

**解决命令**:
```powershell
# 查找占用端口的进�?netstat -ano | findstr :8000

# 终止进程 (PID 为上一步查到的)
taskkill /PID <PID> /F
```

### 3.6 服务自动停止问题

**现象**: 后端/前端服务在一段时间后自动停止

**原因**: 后台进程超时或被系统回收

**解决**: 使用更长�?timeout 参数启动服务
```powershell
# 后端 (10分钟超时)
python -m uvicorn app.main:app --host 127.0.0.1 --port 8000

# 前端
python -m streamlit run app/frontend.py --server.port 8501
```

---

## 四、测试记�?
### 4.1 API 健康检查测�?
**命令**:
```powershell
python -c "import requests; r = requests.get('http://127.0.0.1:8000/health'); print('Status:', r.status_code); print('Response:', r.json())"
```

**输出**:
```
Status: 200
Response: {'status': 'unhealthy', 'services': {'fastapi': 'ok', 'codebuddy': 'error', 'markitdown': 'ok'}}
```

**说明**: `codebuddy: error` 是因为使�?CLI 模式而非 HTTP 模式，属于正常现�?
### 4.2 知识�?API 测试

**命令**:
```powershell
python -c "import requests; r = requests.get('http://127.0.0.1:8000/api/knowledge-base/list'); print('Status:', r.status_code); import json; print(json.dumps(r.json(), indent=2, ensure_ascii=False))"
```

**输出**:
```json
{
  "success": true,
  "files": [
    {
      "filename": "主合同评审checklist.csv",
      "display_name": "主合同评审checklist",
      "description": "",
      "category": "通用",
      "size": 33299,
      "modified_at": "2025-10-23T15:20:16",
      "row_count": 60,
      "columns": ["一级分�?, "二级分类", "三级分类", "评审�?, ...],
      "enabled": true
    },
    // ... �?个知识库文件
  ],
  "total": 8
}
```

### 4.3 任务历史统计测试

**命令**:
```powershell
python -c "import requests; r = requests.get('http://127.0.0.1:8000/api/history/statistics'); print(r.json())"
```

**输出**:
```json
{
  "success": true,
  "statistics": {
    "total": 1,
    "completed": 1,
    "in_progress": 0,
    "error": 0,
    "status_distribution": {"completed": 1},
    "risk_distribution": {},
    "average_duration_seconds": 104.0,
    "recent_tasks": 1,
    "period_days": 30
  }
}
```

### 4.4 端到端评审测�?
**测试脚本**: `test_e2e_review.py`

**执行命令**:
```powershell
cd "/path/to/contract-review-ai"
python test_e2e_review.py
```

**输出**:
```
Task ID: 31108e7a-2637-4dc9-a300-a36aea599420

等待解析完成...
  ready - 文件解析完成 (1/1 成功) (40%)

启动评审...
Review Response: 200
{
  "task_id": "31108e7a-2637-4dc9-a300-a36aea599420",
  "status": "reviewing",
  "message": "评审任务已启动，预计5-10分钟完成"
}

等待评审完成 (使用Mock模式�?�?...
  reviewing - 正在调用AI模型进行评审... (60%)
  ... (多次轮询)
  completed - 评审完成 (100%)

评审完成�?
获取报告列表...
{
  "task_id": "31108e7a-2637-4dc9-a300-a36aea599420",
  "reports": [
    {"filename": "review_report.html", "name": "专业网页报告", "size": 44250},
    {"filename": "review_result.json", "name": "原始评审结果", "size": 5870},
    {"filename": "management_summary.md", "name": "管理层摘要报�?, "size": 6191},
    {"filename": "comprehensive_report.xlsx", "name": "Excel综合报告", "size": 11514},
    {"filename": "risk_matrix.csv", "name": "风险矩阵", "size": 1869},
    {"filename": "compliance_check.csv", "name": "合规检查报�?, "size": 827},
    {"filename": "combined.md", "name": "合同Markdown", "size": 664},
    {"filename": "review_reports_31108e7a.zip", "name": "全部报告打包", "size": 25289}
  ],
  "total": 8
}
```

---

## 五、服务启动命�?
### 5.1 启动后端服务

```powershell
cd "/path/to/contract-review-ai"
python -m uvicorn app.main:app --host 127.0.0.1 --port 8000
```

**启动日志**:
```
2025-12-29 16:10:54 - app.services.document_parser - INFO - MarkItDown初始化完�?(标准模式)
2025-12-29 16:10:54 - app.services.codebuddy_client - INFO - CodeBuddy客户端初始化: http://127.0.0.1:3000
2025-12-29 16:10:54 - app.services.codebuddy_cli_client - INFO - 找到 codebuddy: /usr/local/bin\codebuddy.cmd
2025-12-29 16:10:54 - app.services.codebuddy_cli_client - INFO - CodeBuddy CLI客户端初始化
2025-12-29 16:10:54 - app.services.mock_review_client - INFO - Mock评审客户端初始化（测试模式）
INFO:     Started server process [35120]
INFO:     Waiting for application startup.
2025-12-29 16:10:54 - app.main - INFO - ============================================================
2025-12-29 16:10:54 - app.main - INFO - 合同评审AI系统启动
2025-12-29 16:10:54 - app.main - INFO - FastAPI: http://0.0.0.0:8000
2025-12-29 16:10:54 - app.main - INFO - API文档: http://0.0.0.0:8000/docs
2025-12-29 16:10:54 - app.main - INFO - 评审模式: cli
2025-12-29 16:10:54 - app.main - INFO - ============================================================
2025-12-29 16:10:54 - app.main - INFO - �?CLI模式: 使用 /usr/local/bin\codebuddy.cmd
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

### 5.2 启动前端服务

```powershell
cd "/path/to/contract-review-ai"
python -m streamlit run app/frontend.py --server.port 8501
```

**启动日志**:
```
You can now view your Streamlit app in your browser.

  Local URL: http://localhost:8501
  Network URL: http://10.43.43.57:8501
```

---

## 六、Git 提交记录

### 6.1 初始化仓�?
```powershell
cd "/path/to/contract-review-ai"

# 删除原有 git 配置 (如有)
Remove-Item -Recurse -Force ".git"

# 初始化新仓库
git init

# 添加远程仓库
git remote add origin https://github.com/yourusername/contract-review-ai.git
```

### 6.2 添加文件并提�?
```powershell
# 添加所有文�?git add -A

# 查看状�?git status --short
```

**输出** (60个文�?:
```
A  .env.example
A  .gitignore
A  Day10_完成报告.md
A  Day11_完成报告.md
A  Day8_完成报告.md
A  Day9_完成报告.md
A  QUICKSTART.md
A  README.md
A  app/__init__.py
A  app/config.py
A  app/frontend.py
A  app/main.py
A  app/services/__init__.py
A  app/services/codebuddy_cli_client.py
A  app/services/codebuddy_client.py
A  app/services/document_parser.py
A  app/services/html_report_generator.py
A  app/services/knowledge_base_manager.py
A  app/services/mock_review_client.py
A  app/services/report_generator.py
A  app/services/task_history_manager.py
A  data/test_review_result.json
A  requirements.txt
A  start.bat
A  test_*.py (多个测试文件)
A  启动说明.md
A  故障排查指南.md
A  知识�?*.csv (8个知识库文件)
A  �?周完整开发报�?md
A  �?周开发计�?md
A  系统运行状�?md
```

### 6.3 提交并打标签

```powershell
# 提交
git commit -m "V1.0 合同评审AI系统 - 初始版本：CodeBuddy+MarkItDown智能评审，多格式报告，知识库管理，任务历�?

# 创建标签
git tag -a v1.0 -m "V1.0 合同评审AI系统正式�?

# 推送到远程
git push -u origin master --tags
```

**推送日�?*:
```
Enumerating objects: 67, done.
Counting objects: 100% (67/67), done.
Delta compression using up to 16 threads
Compressing objects: 100% (66/66), done.
Writing objects: 100% (67/67), 256.39 KiB | 7.33 MiB/s, done.
Total 67 (delta 0), reused 0 (delta 0), pack-reused 0 (from 0)
To https://github.com/yourusername/contract-review-ai.git
 * [new branch]      master -> master
 * [new tag]         v1.0 -> v1.0
branch 'master' set up to track 'origin/master'.
```

---

## 七、项目文件结�?
```
contract-review-ai/
├── app/
�?  ├── __init__.py
�?  ├── config.py                      # 配置管理
�?  ├── frontend.py                    # Streamlit 前端 (v3.0)
�?  ├── main.py                        # FastAPI 后端 (v3.0)
�?  └── services/
�?      ├── __init__.py
�?      ├── codebuddy_cli_client.py    # CodeBuddy CLI 客户�?�?      ├── codebuddy_client.py        # CodeBuddy HTTP 客户�?�?      ├── document_parser.py         # MarkItDown 文档解析
�?      ├── html_report_generator.py   # HTML 报告生成�?�?      ├── knowledge_base_manager.py  # 知识库管理器
�?      ├── mock_review_client.py      # Mock 评审客户�?�?      ├── report_generator.py        # 报告生成�?�?      └── task_history_manager.py    # 任务历史管理�?├── data/
�?  ├── uploads/                       # 上传文件目录
�?  ├── outputs/                       # 输出文件目录
�?  └── task_history.db               # SQLite 数据�?├── 知识�?
�?  ├── 主合同评审checklist.csv
�?  ├── 分包合同评审checklist.csv
�?  ├── 可交付评审checklistfor集成.csv
�?  ├── 可交付评审checklistfor被集�?csv
�?  ├── 可交付评审SOP流程说明.csv
�?  ├── 产品层面风险提示�?csv
�?  ├── 风险矩阵.csv
�?  └── 风险清单.csv
├── logs/
�?  └── app.log                        # 应用日志
├── .env.example                       # 环境变量示例
├── .gitignore                         # Git 忽略配置
├── requirements.txt                   # Python 依赖
├── start.bat                          # Windows 启动脚本
├── README.md                          # 项目说明
├── QUICKSTART.md                      # 快速开始指�?├── 启动说明.md                        # 启动说明
├── 故障排查指南.md                    # 故障排查
└── 开发记�?V1.0.md                   # 本文�?```

---

## 八、API 端点汇�?
### 8.1 基础接口

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/` | 根路�?|
| GET | `/health` | 健康检�?|

### 8.2 文件上传与评�?
| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/upload` | 上传合同文件 |
| POST | `/api/review/{task_id}` | 启动评审任务 |
| GET | `/api/status/{task_id}` | 查询任务状�?|

### 8.3 报告下载

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/report/{task_id}/result` | 下载评审结果 JSON |
| GET | `/api/report/{task_id}/markdown` | 下载合同 Markdown |
| GET | `/api/report/{task_id}/summary` | 下载管理层摘�?|
| GET | `/api/report/{task_id}/excel` | 下载 Excel 报告 |
| GET | `/api/report/{task_id}/html` | 下载 HTML 报告 |
| GET | `/api/report/{task_id}/html/preview` | 预览 HTML 报告 |
| GET | `/api/report/{task_id}/risk-matrix` | 下载风险矩阵 |
| GET | `/api/report/{task_id}/compliance` | 下载合规报告 |
| GET | `/api/report/{task_id}/zip` | 下载全部报告 |
| GET | `/api/report/{task_id}/list` | 列出可用报告 |

### 8.4 知识库管�?
| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/knowledge-base/list` | 列出所有文�?|
| POST | `/api/knowledge-base/upload` | 上传文件 |
| DELETE | `/api/knowledge-base/{filename}` | 删除文件 |
| GET | `/api/knowledge-base/{filename}/preview` | 预览内容 |
| GET | `/api/knowledge-base/{filename}/download` | 下载文件 |
| PUT | `/api/knowledge-base/{filename}/metadata` | 更新元数�?|
| POST | `/api/knowledge-base/export` | 导出 ZIP |
| POST | `/api/knowledge-base/import` | 导入 ZIP |

### 8.5 任务历史

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/history/list` | 获取历史列表 |
| GET | `/api/history/statistics` | 获取统计信息 |
| GET | `/api/history/search` | 搜索任务 |
| POST | `/api/history/cleanup` | 清理旧任�?|
| GET | `/api/history/{task_id}` | 获取任务详情 |
| DELETE | `/api/history/{task_id}` | 删除任务 |

---

## 九、版本信�?
| 项目 | 版本 |
|------|------|
| 系统版本 | V1.0 |
| FastAPI | 后端 v3.0.0 |
| Streamlit | 前端 v3.0.0 |
| Python | 3.14 |
| 提交文件�?| 60 |
| 代码行数 | 15,219 |
| Git 标签 | v1.0 |
| 仓库 | https://github.com/yourusername/contract-review-ai |

---

## 十、后续优化方�?
1. **性能优化**: 添加 Redis 缓存，优化大文件处理
2. **安全增强**: 添加用户认证和权限管�?3. **功能扩展**: 支持批量评审、评审模板自定义
4. **部署优化**: Docker 容器化部�?5. **监控告警**: 添加 Prometheus + Grafana 监控

---

*文档生成时间: 2025-12-29*
*作�? CFP-Study Task07*
