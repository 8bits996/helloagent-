# 第15章 - 构建赛博小镇 学习指南

**学习者**: Franke Chen  
**创建日期**: 2025-12-27  
**学习目标**: 掌握 AI 与游戏引擎结合，构建智能 NPC 系统

---

## 📚 章节概述

### 核心内容
将 AI 智能体技术与 Godot 游戏引擎结合，创建一个拥有智能 NPC 的赛博小镇。NPC 具有：
- 🧠 **智能对话能力** - 基于 LLM 的自然语言交互
- 💭 **记忆系统** - 短期记忆 + 长期记忆
- ❤️ **好感度系统** - 5 个等级动态关系
- 🚶 **自主行为** - 随机巡逻、对话气泡

### 技术架构（四层）
```
┌─────────────────────────────────┐
│   前端层：Godot 4.5 + GDScript   │  游戏场景、玩家控制、UI
├─────────────────────────────────┤
│   后端层：FastAPI + Python       │  API 服务、状态管理
├─────────────────────────────────┤
│   智能体层：HelloAgents          │  NPC Agent、记忆、好感度
├─────────────────────────────────┤
│   外部服务层：LLM + Qdrant       │  对话生成、向量检索
└─────────────────────────────────┘
```

---

## 🎯 学习路线图

### 阶段一：环境准备（1-2小时）✅

#### 1. 安装 Godot 游戏引擎
- [ ] 访问 [Godot官网](https://godotengine.org/download)
- [ ] 下载 Godot 4.2+ 版本（推荐 4.3）
- [ ] 解压并运行 Godot
- [ ] 熟悉基本界面和操作

#### 2. 检查 Python 环境
```bash
python --version  # 需要 3.10+
```

#### 3. 项目定位
```
位置: C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town
```

#### 4. 查看项目结构
```
Helloagents-AI-Town/
├── backend/               # Python 后端服务
│   ├── main.py           # FastAPI 主程序
│   ├── agents.py         # NPC Agent 系统
│   ├── relationship_manager.py  # 好感度管理
│   ├── state_manager.py  # 状态管理
│   ├── logger.py         # 日志系统
│   ├── config.py         # 配置管理
│   └── requirements.txt  # 依赖包
│
├── helloagents-ai-town/  # Godot 游戏项目
│   ├── scenes/           # 游戏场景
│   │   ├── main.tscn    # 主场景
│   │   ├── player.tscn  # 玩家场景
│   │   ├── npc.tscn     # NPC 模板
│   │   └── dialogue_ui.tscn  # 对话界面
│   ├── scripts/         # GDScript 脚本
│   │   ├── player.gd    # 玩家控制
│   │   ├── npc.gd       # NPC 行为
│   │   ├── api_client.gd  # API 客户端
│   │   └── dialogue_ui.gd  # 对话 UI
│   └── assets/          # 游戏资源
│       ├── sprites/     # 精灵图
│       └── sounds/      # 音效
│
└── 文档/
    ├── README.md                # 项目说明
    ├── SETUP_GUIDE.md          # 安装指南
    ├── DIALOGUE_LOG_GUIDE.md   # 日志系统
    ├── AFFINITY_SYSTEM_GUIDE.md  # 好感度系统
    └── MEMORY_SYSTEM_GUIDE.md   # 记忆系统
```

---

### 阶段二：快速体验（30分钟）⏳

#### 1. 配置后端环境
```bash
cd C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\backend

# 创建虚拟环境（如果还没有）
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

#### 2. 配置环境变量
```bash
# 复制示例配置
cp .env.example .env

# 编辑 .env 文件，配置你的 LLM API
```

**重要配置项**:
```ini
# LLM API 配置（使用你现有的硅基流动配置）
LLM_API_KEY=your_siliconflow_api_key
LLM_BASE_URL=https://api.siliconflow.cn/v1
LLM_MODEL=Qwen/Qwen2.5-7B-Instruct

# API 服务配置
API_HOST=0.0.0.0
API_PORT=8000

# NPC 更新间隔（秒）
NPC_UPDATE_INTERVAL=30
```

#### 3. 启动后端服务
```bash
python main.py
```

**预期输出**:
```
🎮 赛博小镇后端服务启动中...
✅ 所有服务已启动!
📡 API地址: http://0.0.0.0:8000
📚 API文档: http://0.0.0.0:8000/docs
```

#### 4. 打开 Godot 项目
1. 启动 Godot 应用
2. 点击 "导入" 按钮
3. 浏览到: `C:\Users\frankechen\CFP-Study\Task06\official-code\code\chapter15\Helloagents-AI-Town\helloagents-ai-town`
4. 选择 `project.godot` 文件
5. 点击 "导入并编辑"

#### 5. 运行游戏
1. 在 Godot 编辑器中，点击右上角的 **"运行"** 按钮（或按 F5）
2. 使用 **WASD** 移动玩家
3. 走到 NPC 附近，按 **E** 键交互
4. 输入消息，观察 NPC 的智能回复

#### 6. 测试核心功能
- [ ] 与张三对话（Python 工程师）
- [ ] 与李四对话（产品经理）
- [ ] 与王五对话（UI 设计师）
- [ ] 观察好感度变化
- [ ] 测试记忆系统（重复提到之前的话题）
- [ ] 查看后端日志

---

### 阶段三：理解架构（2-3小时）⏳

#### 1. 后端系统深入学习

##### 1.1 NPC Agent 系统（agents.py）
```python
核心概念：
- SimpleAgent: 基础智能体类
- 系统提示词: 定义 NPC 性格和角色
- 记忆管理: WorkingMemory + EpisodicMemory
- 批量生成: 降低 API 成本
```

**学习任务**:
- [ ] 阅读 `backend/agents.py`
- [ ] 理解 3 个 NPC 的角色设定
- [ ] 查看系统提示词的构建
- [ ] 理解批量对话生成机制

##### 1.2 好感度系统（relationship_manager.py）
```python
五级好感度体系：
0-20:  陌生 - 礼貌疏远，回复简短
21-40: 熟悉 - 自然交流，分享工作信息
41-60: 友好 - 主动关心，详细回复
61-80: 亲密 - 充满信任，分享私人话题
81-100: 挚友 - 无话不谈，内心想法
```

**学习任务**:
- [ ] 阅读 `backend/relationship_manager.py`
- [ ] 理解好感度计算逻辑
- [ ] 查看好感度如何影响系统提示词
- [ ] 测试不同好感度等级的对话差异

##### 1.3 FastAPI 服务（main.py）
```python
核心 API 端点：
GET  /npcs/status               # 获取所有 NPC 状态
POST /dialogue                  # 处理对话请求
GET  /affinity/{npc_id}/{player}  # 查询好感度
```

**学习任务**:
- [ ] 阅读 `backend/main.py`
- [ ] 访问 http://localhost:8000/docs 查看 API 文档
- [ ] 使用 Swagger UI 测试 API
- [ ] 理解状态管理器的作用

##### 1.4 日志系统（logger.py）
**学习任务**:
- [ ] 阅读 `backend/logger.py`
- [ ] 查看日志文件位置：`backend/logs/`
- [ ] 理解日志格式和内容
- [ ] 使用日志调试问题

#### 2. 前端系统深入学习

##### 2.1 Godot 基础概念
```
核心概念：
- Node (节点): 最基本的构建块
- Scene (场景): 节点集合，可复用的预制件
- Script (脚本): 使用 GDScript 编写的行为逻辑
- Signal (信号): 事件通知机制
```

**学习资源**:
- [ ] [Godot 官方文档](https://docs.godotengine.org/)
- [ ] [GDScript 基础教程](https://docs.godotengine.org/en/stable/tutorials/scripting/gdscript/index.html)

##### 2.2 玩家场景（player.tscn + player.gd）
```gdscript
核心功能：
- WASD 移动控制
- 4 方向动画切换
- 碰撞检测
- E 键交互
- 走路音效
```

**学习任务**:
- [ ] 在 Godot 中打开 `scenes/player.tscn`
- [ ] 阅读 `scripts/player.gd`
- [ ] 理解 `_physics_process()` 函数
- [ ] 理解动画状态切换逻辑
- [ ] 测试修改移动速度

##### 2.3 NPC 场景（npc.tscn + npc.gd）
```gdscript
核心功能：
- 随机巡逻游走
- 交互区域检测
- 对话气泡显示
- 动画状态管理
```

**学习任务**:
- [ ] 在 Godot 中打开 `scenes/npc.tscn`
- [ ] 阅读 `scripts/npc.gd`
- [ ] 理解巡逻算法
- [ ] 理解 Area2D 交互检测
- [ ] 测试调整巡逻范围

##### 2.4 对话 UI（dialogue_ui.tscn + dialogue_ui.gd）
```gdscript
核心功能：
- 显示 NPC 信息
- 富文本对话显示
- 玩家输入处理
- 异步响应等待
```

**学习任务**:
- [ ] 在 Godot 中打开 `scenes/dialogue_ui.tscn`
- [ ] 阅读 `scripts/dialogue_ui.gd`
- [ ] 理解输入处理逻辑
- [ ] 理解富文本格式化
- [ ] 测试修改 UI 样式

##### 2.5 API 客户端（api_client.gd）
```gdscript
核心功能：
- HTTPRequest 封装
- 异步请求不阻塞
- 信号机制通知响应
- 独立节点避免冲突
```

**学习任务**:
- [ ] 阅读 `scripts/api_client.gd`
- [ ] 理解 HTTPRequest 使用方式
- [ ] 理解信号的发送和接收
- [ ] 测试 API 调用流程

---

### 阶段四：代码实践（4-6小时）⏳

#### 实践项目 1：添加新 NPC
**目标**: 创建第 4 个 NPC "赵六"，职业为"运维工程师"

**任务清单**:
- [ ] 在 `backend/agents.py` 中添加赵六的配置
- [ ] 设计赵六的性格和对话风格
- [ ] 在 Godot 中创建赵六的实例
- [ ] 配置赵六的初始位置和巡逻范围
- [ ] 测试与赵六的对话

#### 实践项目 2：优化好感度系统
**目标**: 让好感度影响更加明显

**任务清单**:
- [ ] 修改好感度计算公式
- [ ] 增加更多好感度等级的差异化表现
- [ ] 在对话 UI 中显示当前好感度
- [ ] 添加好感度变化动画效果

#### 实践项目 3：增强记忆系统
**目标**: 让 NPC 能够记住更多细节

**任务清单**:
- [ ] 调整短期记忆容量
- [ ] 优化长期记忆检索逻辑
- [ ] 测试记忆系统的效果
- [ ] 在日志中查看记忆存储情况

#### 实践项目 4：扩展游戏场景
**目标**: 添加更多互动元素

**任务清单**:
- [ ] 添加建筑物（咖啡馆、办公室）
- [ ] 创建特定位置的对话触发
- [ ] 添加背景音乐
- [ ] 优化视觉效果

---

### 阶段五：系统集成测试（2-3小时）⏳

#### 1. 功能测试清单

##### 对话系统测试
- [ ] 测试 3 个 NPC 的对话是否正常
- [ ] 测试不同风格的输入（技术问题、闲聊、情感交流）
- [ ] 验证 NPC 回复是否符合角色设定
- [ ] 测试对话历史是否正确保存

##### 好感度系统测试
- [ ] 测试友好态度：连续夸奖 NPC，观察好感度上升
- [ ] 测试不友好态度：说负面话，观察好感度下降
- [ ] 测试不同好感度等级的对话差异
- [ ] 验证好感度持久化（重启后是否保存）

##### 记忆系统测试
- [ ] 短期记忆测试：在同一次对话中提到之前的内容
- [ ] 长期记忆测试：关闭游戏，重新启动，验证是否记得
- [ ] 语义检索测试：用不同表述提到相同话题

##### 性能测试
- [ ] 测试多次连续对话是否卡顿
- [ ] 测试批量生成对话的性能
- [ ] 测试同时与多个 NPC 对话
- [ ] 监控 API 调用次数和成本

#### 2. 错误处理测试
- [ ] 测试后端服务停止时的前端表现
- [ ] 测试 API 超时情况
- [ ] 测试无效输入的处理
- [ ] 测试网络错误的恢复

---

### 阶段六：扩展实践（选修）⏳

#### 扩展方向 1：任务系统
**目标**: 添加 NPC 发布任务，玩家完成任务获得奖励

**实现思路**:
```python
# 后端
class Task:
    task_id: str
    npc_id: str
    description: str
    reward: int
    status: str  # pending, completed

# 前端
- 任务列表 UI
- 任务进度显示
- 完成任务的交互
```

#### 扩展方向 2：NPC 互动
**目标**: NPC 之间可以互相对话

**实现思路**:
```python
# 后端
def npc_to_npc_dialogue(npc1_id, npc2_id, topic):
    # NPC1 生成对话
    # NPC2 回复
    # 更新双方记忆
    pass

# 前端
- NPC 对话气泡显示
- 对话动画效果
```

#### 扩展方向 3：情感系统
**目标**: NPC 有情绪状态（开心、悲伤、愤怒）

**实现思路**:
```python
# 后端
class Emotion:
    emotion_type: str  # happy, sad, angry
    intensity: float   # 0-1
    duration: int      # 持续时间

# 前端
- 情绪表情动画
- 情绪影响对话风格
```

#### 扩展方向 4：动态事件
**目标**: 小镇中发生随机事件

**实现思路**:
```python
# 后端
class Event:
    event_type: str
    description: str
    affected_npcs: list
    duration: int

# 前端
- 事件公告显示
- NPC 对事件的反应
```

---

## 📖 学习资源

### 官方文档
- 📘 [Hello Agents - 第15章](https://github.com/datawhalechina/hello-agents/blob/main/docs/chapter15/第十五章%20构建赛博小镇.md)
- 🎮 [Godot 官方文档](https://docs.godotengine.org/)
- 🐍 [FastAPI 文档](https://fastapi.tiangolo.com/)

### 项目文档
- 📄 [SETUP_GUIDE.md](../official-code/code/chapter15/Helloagents-AI-Town/SETUP_GUIDE.md)
- 📄 [DIALOGUE_LOG_GUIDE.md](../official-code/code/chapter15/Helloagents-AI-Town/DIALOGUE_LOG_GUIDE.md)
- 📄 [AFFINITY_SYSTEM_GUIDE.md](../official-code/code/chapter15/Helloagents-AI-Town/AFFINITY_SYSTEM_GUIDE.md)
- 📄 [MEMORY_SYSTEM_GUIDE.md](../official-code/code/chapter15/Helloagents-AI-Town/MEMORY_SYSTEM_GUIDE.md)

### 视频教程（推荐搜索）
- Godot 4 入门教程
- GDScript 编程基础
- FastAPI 快速入门

---

## 🎓 核心知识点总结

### 技术栈掌握
| 技术 | 作用 | 重要程度 |
|------|------|----------|
| Godot + GDScript | 游戏开发 | ⭐⭐⭐⭐⭐ |
| FastAPI | 后端服务 | ⭐⭐⭐⭐⭐ |
| HelloAgents | AI 智能体 | ⭐⭐⭐⭐⭐ |
| SQLite + Qdrant | 数据存储 | ⭐⭐⭐⭐ |

### 设计模式应用
1. **前后端分离**: 独立开发、独立测试
2. **场景实例化**: 模块化、可复用
3. **信号通信**: 松耦合、易扩展
4. **批量优化**: 降低成本、提升性能
5. **记忆分层**: 短期+长期、语义检索

### 重要实现细节
- 好感度动态影响系统提示词
- 批量生成与即时响应混合模式
- Area2D 实现交互检测
- HTTPRequest 异步通信
- RichTextLabel 富文本显示

---

## 💡 学习建议

### 学习方法
1. **先体验后学习**: 运行项目感受效果，再深入代码
2. **分层理解**: 从架构到实现，逐层深入
3. **动手实践**: 修改参数、添加功能，加深理解
4. **查看日志**: 通过日志理解系统运行过程
5. **扩展创新**: 基于项目实现自己的想法

### 常见问题处理

#### Q1: Godot 导入项目失败
**解决方案**:
- 确保 Godot 版本 >= 4.2
- 检查是否选择了正确的 `project.godot` 文件
- 尝试重新导入项目

#### Q2: 后端启动失败
**解决方案**:
- 检查 Python 版本 >= 3.10
- 确认已激活虚拟环境
- 确认 `.env` 文件配置正确
- 查看错误日志

#### Q3: NPC 无法对话
**解决方案**:
- 确认后端服务正在运行
- 检查后端地址配置（默认 http://localhost:8000）
- 查看 Godot 控制台的错误信息
- 检查 LLM API 配置是否正确

#### Q4: 记忆系统不工作
**解决方案**:
- 检查 Qdrant 向量数据库是否启动
- 查看后端日志的记忆存储信息
- 验证 API 配置是否正确

---

## 🎯 学习成果检验

### 理论掌握（自评）
- [ ] 理解四层架构设计
- [ ] 掌握前后端分离思想
- [ ] 理解 NPC Agent 的构建流程
- [ ] 理解好感度系统的设计原理
- [ ] 理解记忆系统的分层设计

### 实践能力（自评）
- [ ] 能够独立启动和运行项目
- [ ] 能够修改 NPC 的角色设定
- [ ] 能够添加新的 NPC
- [ ] 能够调试前后端问题
- [ ] 能够扩展游戏功能

### 代码理解（自评）
- [ ] 理解后端 API 的实现
- [ ] 理解前端场景的组织
- [ ] 理解 GDScript 脚本逻辑
- [ ] 理解 API 客户端的封装
- [ ] 理解日志系统的使用

---

## 📊 时间规划

| 阶段 | 预计时间 | 完成标准 |
|------|----------|----------|
| 环境准备 | 1-2小时 | Godot + 后端环境配置完成 |
| 快速体验 | 30分钟 | 成功运行游戏并与 NPC 对话 |
| 理解架构 | 2-3小时 | 理解前后端架构和核心代码 |
| 代码实践 | 4-6小时 | 完成至少 2 个实践项目 |
| 系统测试 | 2-3小时 | 完成功能测试和性能测试 |
| 扩展实践 | 选修 | 实现至少 1 个扩展功能 |

**总计**: 10-15 小时（不含扩展）

---

## 🎉 下一步

完成第15章学习后，你将：
1. ✅ 掌握 AI 与游戏引擎结合的完整方案
2. ✅ 理解分布式系统设计思想
3. ✅ 积累全栈开发实践经验
4. ✅ 准备好进入 Task07 毕业设计

**开始学习吧！** 🚀

---

**创建时间**: 2025-12-27  
**最后更新**: 2025-12-27  
**状态**: 📝 学习指南已创建
