# 好感度系统 - 学习笔记

**日期**: 2025-12-28  
**学习者**: Franke Chen

---

## 🎯 核心概念

好感度系统是赛博小镇的**核心创新点**，让NPC对玩家的态度会随着互动而动态变化。

---

## 📊 五级好感度体系

```
Lv.4 挚友    (81-100分)  ★★★★★
Lv.3 朋友    (61-80分)   ★★★★☆
Lv.2 熟人    (41-60分)   ★★★☆☆
Lv.1 认识    (21-40分)   ★★☆☆☆
Lv.0 陌生人  (0-20分)    ★☆☆☆☆
```

### 等级影响

- **Lv.0 陌生人**: NPC保持礼貌但疏离，回答简短
- **Lv.1-2 认识/熟人**: 愿意交流，但不会太深入
- **Lv.3 朋友**: 主动分享，热情互动，会关心玩家
- **Lv.4 挚友**: 完全信任，无话不谈，会主动提供帮助

---

## 📈 好感度变化规则

### 增加好感度 ✅

| 行为类型 | 变化量 | 示例 |
|---------|--------|------|
| 赞美、感谢 | +6 到 +8 | "你的代码写得真棒！" |
| 请教学习 | +5 到 +8 | "能教教我Python吗？" |
| 友好问候 | +3 到 +5 | "你好，很高兴认识你！" |
| 正常交流 | +1 到 +3 | "最近在做什么项目？" |

### 不变化 ➡️

| 行为类型 | 变化量 | 示例 |
|---------|--------|------|
| 普通闲聊 | 0 | "今天天气不错" |
| 中性话题 | 0 | "嗯，是的" |

### 降低好感度 ❌

| 行为类型 | 变化量 | 示例 |
|---------|--------|------|
| 批评质疑 | -3 到 -8 | "你的设计太普通了" |
| 不耐烦 | -3 到 -5 | "算了，不想听了" |
| 侮辱攻击 | -8 到 -15 | "你真是个垃圾" |

---

## 🧠 实现原理

### 1. 情感分析 Agent

系统使用专门的 **AffinityAnalyzer Agent** 来分析对话：

```python
# relationship_manager.py:45-103
analyzer_agent = SimpleAgent(
    name="AffinityAnalyzer",
    llm=llm,
    system_prompt=analyzer_prompt
)
```

### 2. 分析维度

分析Agent会从4个维度评估对话：

1. **玩家态度**: 友好/中立/不友好
2. **对话内容**: 积极/中立/消极
3. **互动质量**: 深入/一般/敷衍
4. **情感倾向**: 赞美/批评/中性

### 3. 输出格式

```json
{
    "should_change": true,
    "change_amount": 5,
    "reason": "友好问候",
    "sentiment": "positive"
}
```

### 4. 更新流程

```
1. 玩家发送消息
   ↓
2. NPC生成回复
   ↓
3. 调用情感分析Agent
   ↓
4. 解析分析结果
   ↓
5. 计算新的好感度（限制在0-100）
   ↓
6. 更新存储
   ↓
7. 返回变化信息
```

---

## 💻 代码解析

### 核心类：RelationshipManager

**文件**: `backend/relationship_manager.py`

#### 初始化 (line 24-43)

```python
def __init__(self, llm: HelloAgentsLLM):
    self.llm = llm
    self.affinity_scores = {}  # 存储所有NPC的好感度
    self.analyzer_agent = SimpleAgent(...)  # 情感分析Agent
```

#### 获取好感度 (line 105-121)

```python
def get_affinity(self, npc_name: str, player_id: str = "player") -> float:
    # 如果是新玩家，初始化为50分
    if player_id not in self.affinity_scores[npc_name]:
        self.affinity_scores[npc_name][player_id] = 50.0
    return self.affinity_scores[npc_name][player_id]
```

#### 分析并更新 (line 138-213)

```python
def analyze_and_update_affinity(
    self, npc_name, player_message, npc_response, player_id
):
    # 1. 构建分析提示
    prompt = f"玩家: {player_message}\n{npc_name}: {npc_response}"
    
    # 2. 调用分析Agent
    response = self.analyzer_agent.run(prompt)
    
    # 3. 解析JSON结果
    analysis = self._parse_analysis(response)
    
    # 4. 更新好感度
    if analysis["should_change"]:
        current = self.get_affinity(npc_name, player_id)
        new = current + analysis["change_amount"]
        new = max(0.0, min(100.0, new))  # 限制范围
        self.set_affinity(npc_name, new, player_id)
```

---

## 🎮 游戏中测试

### 测试场景1: 友好对话（增加好感度）

**与张三对话**:
```
👤 "你好，很高兴认识你！"
🤖 "你好！我也很高兴认识你。"
💖 好感度: 50 → 55 (+5)
   等级: Lv.2 熟人
   原因: 友好问候
```

**继续对话**:
```
👤 "听说你是Python工程师，能教教我吗？"
🤖 "当然可以！我很乐意分享我的经验。"
💖 好感度: 55 → 63 (+8)
   等级: Lv.2 → Lv.3 朋友
   原因: 请教学习
```

### 测试场景2: 批评对话（降低好感度）

**与王五对话**:
```
👤 "你的设计太普通了"
🤖 "抱歉，我会努力改进的..."
💖 好感度: 50 → 43 (-7)
   等级: Lv.2 熟人
   原因: 批评工作
```

### 测试场景3: 中性对话（不变）

**与李四对话**:
```
👤 "今天天气不错"
🤖 "是啊，挺好的。"
💖 好感度: 50 → 50 (0)
   等级: Lv.2 熟人
   原因: 普通闲聊
```

---

## 💡 设计亮点

### 1. AI驱动的情感分析

- ✅ 不是简单的关键词匹配
- ✅ 能理解上下文和语气
- ✅ 更自然、更智能

### 2. 动态调整NPC行为

好感度会影响NPC的系统提示词：

```python
# agents.py 中的实现
affinity_level = relationship_manager.get_affinity_level(affinity)
if affinity_level >= 3:  # 朋友或挚友
    system_prompt += "你们是朋友，可以更加热情和真诚。"
elif affinity_level == 0:  # 陌生人
    system_prompt += "保持礼貌但疏离的态度。"
```

### 3. 持久化存储

- 好感度数据会保存到数据库
- 下次游戏时会记住之前的关系
- 提供连续的游戏体验

### 4. 渐进式关系发展

- 初始好感度50分（Lv.2 熟人）
- 需要多次正面互动才能成为朋友
- 模拟真实的人际关系发展

---

## 🎯 学习要点

### 理论层面

1. ✅ 理解五级好感度体系的设计
2. ✅ 掌握好感度变化规则
3. ✅ 理解情感分析的四个维度
4. ✅ 理解AI驱动 vs 规则驱动的区别

### 实现层面

1. ✅ RelationshipManager 类的结构
2. ✅ 情感分析Agent的创建和使用
3. ✅ 好感度的存储和更新机制
4. ✅ JSON解析和错误处理

### 应用层面

1. ✅ 如何在对话中提升好感度
2. ✅ 不同等级NPC的行为差异
3. ✅ 好感度系统对游戏体验的影响
4. ✅ 可扩展性（添加更多等级、更复杂的规则）

---

## 🚀 扩展思路

### 可能的改进方向

1. **更细粒度的等级**
   - 10级体系（每10分一个等级）
   - 每个等级有明确的标签和描述

2. **好感度影响对话内容**
   - 低好感度：NPC回答简短、形式化
   - 高好感度：NPC主动分享、提供帮助

3. **关系类型**
   - 不只是好感度数值
   - 增加关系标签：导师、同事、朋友、竞争对手等

4. **时间衰减**
   - 长时间不互动，好感度慢慢下降
   - 模拟真实关系的"疏远"

5. **事件触发**
   - 达到特定好感度等级时触发特殊事件
   - 例如：成为挚友后解锁特殊任务

---

## 📝 练习任务

### 基础任务

- [ ] 在游戏中与每个NPC对话，观察初始好感度
- [ ] 尝试说友好的话，观察好感度增加
- [ ] 尝试说批评的话，观察好感度下降
- [ ] 记录不同等级NPC的回复差异

### 进阶任务

- [ ] 将一个NPC的好感度提升到Lv.4（挚友）
- [ ] 分析不同类型对话的好感度变化量
- [ ] 阅读 relationship_manager.py 完整代码
- [ ] 理解情感分析Agent的提示词设计

### 挑战任务

- [ ] 修改好感度变化规则（调整变化量）
- [ ] 添加新的好感度等级（例如：Lv.5 灵魂伴侣）
- [ ] 实现好感度可视化（在UI中显示爱心数量）
- [ ] 添加好感度排行榜（显示与所有NPC的关系）

---

**创建时间**: 2025-12-28  
**状态**: 📚 学习中  
**下一步**: 测试记忆系统
