# agents.py - æ·±åº¦ä»£ç è§£æ

**æ–‡ä»¶ä½ç½®**: `backend/agents.py`  
**ä»£ç è¡Œæ•°**: 484è¡Œ  
**æ ¸å¿ƒèŒè´£**: NPC Agentç³»ç»Ÿï¼Œæ”¯æŒè®°å¿†å’Œå¥½æ„Ÿåº¦  
**å­¦ä¹ æ—¥æœŸ**: 2025-12-27

---

## ğŸ“š ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒæ•°æ®ç»“æ„](#æ ¸å¿ƒæ•°æ®ç»“æ„)
3. [å…³é”®ç±»è¯¦è§£](#å…³é”®ç±»è¯¦è§£)
4. [æ ¸å¿ƒæµç¨‹åˆ†æ](#æ ¸å¿ƒæµç¨‹åˆ†æ)
5. [è®¾è®¡äº®ç‚¹](#è®¾è®¡äº®ç‚¹)
6. [å­¦ä¹ è¦ç‚¹](#å­¦ä¹ è¦ç‚¹)

---

## æ•´ä½“æ¶æ„

### æ–‡ä»¶ç»“æ„
```python
agents.py (484è¡Œ)
â”‚
â”œâ”€â”€ å¯¼å…¥ä¾èµ– (1-18è¡Œ)
â”‚   â”œâ”€â”€ HelloAgentsæ¡†æ¶ç»„ä»¶
â”‚   â”œâ”€â”€ è®°å¿†ç³»ç»Ÿç»„ä»¶
â”‚   â”œâ”€â”€ å¥½æ„Ÿåº¦ç®¡ç†å™¨
â”‚   â””â”€â”€ æ—¥å¿—ç³»ç»Ÿ
â”‚
â”œâ”€â”€ å¸¸é‡é…ç½® (21-49è¡Œ)
â”‚   â””â”€â”€ NPC_ROLES - ä¸‰ä¸ªNPCçš„è§’è‰²è®¾å®š
â”‚
â”œâ”€â”€ å·¥å…·å‡½æ•° (51-84è¡Œ)
â”‚   â””â”€â”€ create_system_prompt() - ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
â”‚
â”œâ”€â”€ æ ¸å¿ƒç±» (86-473è¡Œ)
â”‚   â””â”€â”€ NPCAgentManager - NPCç®¡ç†å™¨
â”‚       â”œâ”€â”€ __init__() - åˆå§‹åŒ–
â”‚       â”œâ”€â”€ _create_agents() - åˆ›å»ºAgent
â”‚       â”œâ”€â”€ _create_memory_manager() - åˆ›å»ºè®°å¿†ç³»ç»Ÿ
â”‚       â”œâ”€â”€ chat() - å¯¹è¯æ ¸å¿ƒé€»è¾‘ â­â­â­
â”‚       â”œâ”€â”€ _build_memory_context() - æ„å»ºè®°å¿†ä¸Šä¸‹æ–‡
â”‚       â”œâ”€â”€ _save_conversation_to_memory() - ä¿å­˜å¯¹è¯
â”‚       â””â”€â”€ [å…¶ä»–è¾…åŠ©æ–¹æ³•]
â”‚
â””â”€â”€ å…¨å±€å•ä¾‹ (475-482è¡Œ)
    â””â”€â”€ get_npc_manager() - è·å–å…¨å±€å®ä¾‹
```

### ä¾èµ–å…³ç³»å›¾
```
NPCAgentManager
    â”‚
    â”œâ”€â†’ HelloAgentsLLM (LLMè°ƒç”¨)
    â”œâ”€â†’ SimpleAgent Ã— 3 (ä¸‰ä¸ªNPC Agent)
    â”œâ”€â†’ MemoryManager Ã— 3 (ä¸‰ä¸ªè®°å¿†ç³»ç»Ÿ)
    â””â”€â†’ RelationshipManager (å¥½æ„Ÿåº¦ç®¡ç†)
```

---

## æ ¸å¿ƒæ•°æ®ç»“æ„

### 1. NPC_ROLES é…ç½® (21-49è¡Œ)

```python
NPC_ROLES = {
    "å¼ ä¸‰": {
        "title": "Pythonå·¥ç¨‹å¸ˆ",        # èŒä½
        "location": "å·¥ä½åŒº",            # å½“å‰ä½ç½®
        "activity": "å†™ä»£ç ",            # å½“å‰æ´»åŠ¨
        "personality": "æŠ€æœ¯å®…...",      # æ€§æ ¼ç‰¹ç‚¹
        "expertise": "å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ...",  # ä¸“ä¸šé¢†åŸŸ
        "style": "ç®€æ´ä¸“ä¸š...",          # è¯´è¯é£æ ¼
        "hobbies": "çœ‹æŠ€æœ¯åšå®¢..."       # å…´è¶£çˆ±å¥½
    },
    # æå››ã€ç‹äº”...
}
```

**è®¾è®¡æ€æƒ³**:
- âœ… **æ•°æ®é©±åŠ¨** - é…ç½®ä¸ä»£ç åˆ†ç¦»
- âœ… **æ˜“æ‰©å±•** - æ·»åŠ æ–°NPCåªéœ€æ·»åŠ é…ç½®
- âœ… **ä¸°å¯Œç»†èŠ‚** - 8ä¸ªç»´åº¦å®šä¹‰è§’è‰²
- âœ… **å·®å¼‚åŒ–** - ä¸‰ä¸ªNPCæ€§æ ¼é²œæ˜

**å¦‚ä½•ä½¿ç”¨**:
```python
# éå†åˆ›å»ºæ‰€æœ‰NPC
for name, role in NPC_ROLES.items():
    agent = create_agent(name, role)
    
# è·å–NPCä¿¡æ¯
zhang_san = NPC_ROLES["å¼ ä¸‰"]
print(zhang_san["title"])  # "Pythonå·¥ç¨‹å¸ˆ"
```

---

### 2. MemoryConfig é…ç½® (147-154è¡Œ)

```python
memory_config = MemoryConfig(
    storage_path=memory_dir,              # å­˜å‚¨è·¯å¾„
    working_memory_capacity=10,           # çŸ­æœŸè®°å¿†å®¹é‡ï¼ˆ10æ¡ï¼‰
    working_memory_tokens=2000,           # çŸ­æœŸè®°å¿†tokené™åˆ¶
    episodic_memory_capacity=100,         # é•¿æœŸè®°å¿†å®¹é‡ï¼ˆ100æ¡ï¼‰
    enable_forgetting=True,               # å¯ç”¨é—å¿˜æœºåˆ¶
    forgetting_threshold=0.3              # é—å¿˜é˜ˆå€¼ï¼ˆé‡è¦æ€§<0.3ä¼šå¿˜è®°ï¼‰
)
```

**ä¸¤å±‚è®°å¿†ç»“æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¥ä½œè®°å¿† (Working Memory)        â”‚  çŸ­æœŸã€å¿«é€Ÿè®¿é—®
â”‚  - å®¹é‡: 10æ¡å¯¹è¯                 â”‚  æœ€è¿‘çš„äº¤äº’
â”‚  - Tokené™åˆ¶: 2000               â”‚  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æƒ…æ™¯è®°å¿† (Episodic Memory)       â”‚  é•¿æœŸã€å‘é‡æ£€ç´¢
â”‚  - å®¹é‡: 100æ¡å¯¹è¯                â”‚  æ‰€æœ‰å†å²å¯¹è¯
â”‚  - æ”¯æŒè¯­ä¹‰æ£€ç´¢                   â”‚  ç›¸ä¼¼åº¦æ’åº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—å¿˜æœºåˆ¶**:
- é‡è¦æ€§ < 0.3 çš„è®°å¿†ä¼šè¢«è‡ªåŠ¨æ¸…ç†
- æ¨¡æ‹Ÿäººç±»è®°å¿†çš„é—å¿˜æ›²çº¿
- ä¿ç•™é‡è¦äº‹ä»¶ï¼Œå¿˜è®°çç¢ç»†èŠ‚

---

## å…³é”®ç±»è¯¦è§£

### NPCAgentManager ç±»

#### 1. åˆå§‹åŒ–æµç¨‹ (__init__, 89-109è¡Œ)

```python
def __init__(self):
    print("ğŸ¤– æ­£åœ¨åˆå§‹åŒ–NPC Agentç³»ç»Ÿ...")
    
    # 1ï¸âƒ£ åˆå§‹åŒ–LLM
    self.llm = HelloAgentsLLM()
    
    # 2ï¸âƒ£ åˆå§‹åŒ–æ•°æ®ç»“æ„
    self.agents: Dict[str, SimpleAgent] = {}        # NPC Agentå­—å…¸
    self.memories: Dict[str, MemoryManager] = {}    # è®°å¿†ç®¡ç†å™¨å­—å…¸
    self.relationship_manager = None                 # å¥½æ„Ÿåº¦ç®¡ç†å™¨
    
    # 3ï¸âƒ£ åˆå§‹åŒ–å¥½æ„Ÿåº¦ç®¡ç†å™¨
    self.relationship_manager = RelationshipManager(self.llm)
    
    # 4ï¸âƒ£ åˆ›å»ºæ‰€æœ‰Agent
    self._create_agents()
```

**è®¾è®¡æ¨¡å¼**: å•ä¾‹æ¨¡å¼ + å·¥å‚æ¨¡å¼
- é€šè¿‡ `get_npc_manager()` è·å–å…¨å±€å”¯ä¸€å®ä¾‹
- é€šè¿‡ `_create_agents()` æ‰¹é‡åˆ›å»ºAgent

---

#### 2. åˆ›å»ºAgent (_create_agents, 111-138è¡Œ)

```python
def _create_agents(self):
    """ä¸ºæ¯ä¸ªNPCåˆ›å»ºAgentå’Œè®°å¿†ç³»ç»Ÿ"""
    for name, role in NPC_ROLES.items():
        # 1ï¸âƒ£ åˆ›å»ºç³»ç»Ÿæç¤ºè¯
        system_prompt = create_system_prompt(name, role)
        
        # 2ï¸âƒ£ åˆ›å»ºSimpleAgent
        agent = SimpleAgent(
            name=f"{name}-{role['title']}",
            llm=self.llm,
            system_prompt=system_prompt
        )
        self.agents[name] = agent
        
        # 3ï¸âƒ£ åˆ›å»ºè®°å¿†ç®¡ç†å™¨
        memory_manager = self._create_memory_manager(name)
        self.memories[name] = memory_manager
        
        print(f"âœ… {name}({role['title']}) Agentåˆ›å»ºæˆåŠŸ")
```

**å¾ªç¯åˆ›å»ºä¸‰ä¸ªNPC**:
```
for "å¼ ä¸‰", "æå››", "ç‹äº”":
    â”œâ”€â†’ ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
    â”œâ”€â†’ åˆ›å»ºAgent
    â””â”€â†’ åˆ›å»ºè®°å¿†ç³»ç»Ÿ
```

---

#### 3. å¯¹è¯æ ¸å¿ƒé€»è¾‘ (chat, 170-261è¡Œ) â­â­â­

è¿™æ˜¯æ•´ä¸ªæ–‡ä»¶æœ€é‡è¦çš„æ–¹æ³•ï¼å¤„ç†ç©å®¶ä¸NPCçš„å¯¹è¯ã€‚

```python
def chat(self, npc_name: str, message: str, player_id: str = "player") -> str:
    """å®Œæ•´çš„å¯¹è¯å¤„ç†æµç¨‹"""
```

**å®Œæ•´æµç¨‹ï¼ˆ8ä¸ªæ­¥éª¤ï¼‰**:

```
ç©å®¶æ¶ˆæ¯è¾“å…¥
    â†“
ã€æ­¥éª¤1ã€‘è®°å½•å¯¹è¯å¼€å§‹ (185è¡Œ)
    log_dialogue_start(npc_name, message)
    â†“
ã€æ­¥éª¤2ã€‘è·å–å½“å‰å¥½æ„Ÿåº¦ (188-199è¡Œ) â­
    affinity = relationship_manager.get_affinity(npc_name, player_id)
    affinity_level = get_affinity_level(affinity)
    affinity_modifier = get_affinity_modifier(affinity)
    
    æ„å»ºå¥½æ„Ÿåº¦ä¸Šä¸‹æ–‡:
    affinity_context = """
    ã€å½“å‰å…³ç³»ã€‘
    ä½ ä¸ç©å®¶çš„å…³ç³»: æœ‹å‹ (å¥½æ„Ÿåº¦: 65/100)
    ã€å¯¹è¯é£æ ¼ã€‘ä¸»åŠ¨åˆ†äº«è¯é¢˜,çƒ­æƒ…äº¤æµ,è¡¨ç°å…³å¿ƒ
    """
    â†“
ã€æ­¥éª¤3ã€‘æ£€ç´¢ç›¸å…³è®°å¿† (202-210è¡Œ) â­
    relevant_memories = memory_manager.retrieve_memories(
        query=message,              # ç”¨ç©å®¶æ¶ˆæ¯ä½œä¸ºæŸ¥è¯¢
        memory_types=["working", "episodic"],  # æ£€ç´¢çŸ­æœŸå’Œé•¿æœŸè®°å¿†
        limit=5,                    # æœ€å¤š5æ¡
        min_importance=0.3          # é‡è¦æ€§>=0.3
    )
    
    æ£€ç´¢ç»“æœç¤ºä¾‹:
    [
        "ç©å®¶è¯´: ä½ æœ€è¿‘åœ¨åšä»€ä¹ˆé¡¹ç›®?",
        "æˆ‘è¯´: åœ¨åšå¤šæ™ºèƒ½ä½“ç³»ç»Ÿ,ç”¨HelloAgentsæ¡†æ¶",
        "ç©å®¶è¯´: èƒ½è¯¦ç»†è®²è®²å—?",
        ...
    ]
    â†“
ã€æ­¥éª¤4ã€‘æ„å»ºå¢å¼ºæç¤ºè¯ (213-218è¡Œ) â­
    memory_context = _build_memory_context(relevant_memories)
    
    enhanced_message = f"""
    ã€å½“å‰å…³ç³»ã€‘
    ä½ ä¸ç©å®¶çš„å…³ç³»: æœ‹å‹ (å¥½æ„Ÿåº¦: 65/100)
    ã€å¯¹è¯é£æ ¼ã€‘ä¸»åŠ¨åˆ†äº«è¯é¢˜,çƒ­æƒ…äº¤æµ,è¡¨ç°å…³å¿ƒ
    
    ã€ä¹‹å‰çš„å¯¹è¯è®°å¿†ã€‘
    [14:30] ç©å®¶è¯´: ä½ æœ€è¿‘åœ¨åšä»€ä¹ˆé¡¹ç›®?
    [14:31] æˆ‘è¯´: åœ¨åšå¤šæ™ºèƒ½ä½“ç³»ç»Ÿ
    
    ã€å½“å‰å¯¹è¯ã€‘
    ç©å®¶: èƒ½å†è¯¦ç»†è®²è®²å—?
    """
    â†“
ã€æ­¥éª¤5ã€‘è°ƒç”¨Agentç”Ÿæˆå›å¤ (221-223è¡Œ)
    response = agent.run(enhanced_message)
    
    LLMæ ¹æ®:
    - ç³»ç»Ÿæç¤ºè¯ï¼ˆè§’è‰²è®¾å®šï¼‰
    - å¥½æ„Ÿåº¦ä¸Šä¸‹æ–‡
    - å†å²è®°å¿†
    - å½“å‰æ¶ˆæ¯
    ç”Ÿæˆå›å¤
    â†“
ã€æ­¥éª¤6ã€‘åˆ†æå¹¶æ›´æ–°å¥½æ„Ÿåº¦ (226-238è¡Œ) â­
    affinity_result = relationship_manager.analyze_and_update_affinity(
        npc_name=npc_name,
        player_message=message,
        npc_response=response,
        player_id=player_id
    )
    
    è¿”å›:
    {
        "changed": True,
        "old_affinity": 65.0,
        "new_affinity": 70.0,
        "change_amount": +5.0,
        "sentiment": "positive",
        "reason": "ç©å®¶è¡¨è¾¾äº†å‹å–„æ€åº¦"
    }
    â†“
ã€æ­¥éª¤7ã€‘ä¿å­˜å¯¹è¯åˆ°è®°å¿† (241-250è¡Œ) â­
    _save_conversation_to_memory(
        memory_manager=memory_manager,
        npc_name=npc_name,
        player_message=message,
        npc_response=response,
        player_id=player_id,
        affinity_info=affinity_result  # â­ åŒ…å«å¥½æ„Ÿåº¦ä¿¡æ¯
    )
    
    ä¿å­˜ä¸¤æ¡è®°å¿†:
    1. ç©å®¶æ¶ˆæ¯ (importance=0.5)
    2. NPCå›å¤ (importance=0.6)
    
    æ¯æ¡è®°å¿†åŒ…å«å…ƒæ•°æ®:
    - speaker, player_id, timestamp
    - affinity (å½“æ—¶çš„å¥½æ„Ÿåº¦)
    - affinity_change (å¥½æ„Ÿåº¦å˜åŒ–)
    - sentiment (æƒ…æ„Ÿå€¾å‘)
    â†“
ã€æ­¥éª¤8ã€‘è¿”å›å›å¤ (255è¡Œ)
    return response
```

**å…³é”®ä»£ç æ®µ**:

```python
# æ­¥éª¤2: è·å–å¥½æ„Ÿåº¦å¹¶æ„å»ºä¸Šä¸‹æ–‡
affinity = self.relationship_manager.get_affinity(npc_name, player_id)
affinity_level = self.relationship_manager.get_affinity_level(affinity)
affinity_modifier = self.relationship_manager.get_affinity_modifier(affinity)

affinity_context = f"""ã€å½“å‰å…³ç³»ã€‘
ä½ ä¸ç©å®¶çš„å…³ç³»: {affinity_level} (å¥½æ„Ÿåº¦: {affinity:.0f}/100)
ã€å¯¹è¯é£æ ¼ã€‘{affinity_modifier}
"""

# æ­¥éª¤3: æ£€ç´¢è®°å¿†
relevant_memories = memory_manager.retrieve_memories(
    query=message,
    memory_types=["working", "episodic"],
    limit=5,
    min_importance=0.3
)

# æ­¥éª¤4: æ„å»ºå¢å¼ºæ¶ˆæ¯
enhanced_message = affinity_context
if memory_context:
    enhanced_message += f"{memory_context}\n\n"
enhanced_message += f"ã€å½“å‰å¯¹è¯ã€‘\nç©å®¶: {message}"

# æ­¥éª¤5: ç”Ÿæˆå›å¤
response = agent.run(enhanced_message)

# æ­¥éª¤6: æ›´æ–°å¥½æ„Ÿåº¦
affinity_result = self.relationship_manager.analyze_and_update_affinity(
    npc_name=npc_name,
    player_message=message,
    npc_response=response,
    player_id=player_id
)

# æ­¥éª¤7: ä¿å­˜è®°å¿†
self._save_conversation_to_memory(...)
```

---

#### 4. ä¿å­˜å¯¹è¯åˆ°è®°å¿† (_save_conversation_to_memory, 278-334è¡Œ)

```python
def _save_conversation_to_memory(
    self,
    memory_manager: MemoryManager,
    npc_name: str,
    player_message: str,
    npc_response: str,
    player_id: str,
    affinity_info: Optional[Dict] = None
):
    """ä¿å­˜å¯¹è¯ï¼ŒåŒ…å«ä¸°å¯Œçš„å…ƒæ•°æ®"""
```

**ä¿å­˜ä¸¤æ¡è®°å¿†**:

```python
# 1ï¸âƒ£ ä¿å­˜ç©å®¶æ¶ˆæ¯
memory_manager.add_memory(
    content=f"ç©å®¶è¯´: {player_message}",
    memory_type="working",      # å…ˆå­˜å…¥çŸ­æœŸè®°å¿†
    importance=0.5,             # ä¸­ç­‰é‡è¦æ€§
    metadata={
        "speaker": "player",
        "player_id": player_id,
        "timestamp": current_time.isoformat(),
        "affinity": affinity,              # â­ å½“æ—¶çš„å¥½æ„Ÿåº¦
        "affinity_change": affinity_change, # â­ å¥½æ„Ÿåº¦å˜åŒ–
        "sentiment": sentiment,             # â­ æƒ…æ„Ÿå€¾å‘
        "context": {
            "interaction_type": "dialogue",
            "npc_name": npc_name
        }
    }
)

# 2ï¸âƒ£ ä¿å­˜NPCå›å¤
memory_manager.add_memory(
    content=f"æˆ‘è¯´: {npc_response}",
    memory_type="working",
    importance=0.6,             # ç¨é«˜é‡è¦æ€§ï¼ˆNPCçš„è¯æ›´é‡è¦ï¼‰
    metadata={...}
)
```

**å…ƒæ•°æ®çš„ä»·å€¼**:
- `affinity` - å¯ä»¥è¿½è¸ªå¥½æ„Ÿåº¦å˜åŒ–å†å²
- `affinity_change` - çŸ¥é“å“ªäº›å¯¹è¯å½±å“äº†å…³ç³»
- `sentiment` - ç†è§£å¯¹è¯çš„æƒ…æ„Ÿè‰²å½©
- `timestamp` - æ—¶é—´åºåˆ—åˆ†æ

**è®°å¿†ç±»å‹è½¬æ¢**:
```
æ–°å¯¹è¯ â†’ å·¥ä½œè®°å¿† (working)
        â†“ (å®¹é‡æ»¡äº†)
é‡è¦å¯¹è¯ â†’ æƒ…æ™¯è®°å¿† (episodic)
        â†“ (é‡è¦æ€§<0.3)
     è¢«é—å¿˜ (åˆ é™¤)
```

---

#### 5. æ„å»ºè®°å¿†ä¸Šä¸‹æ–‡ (_build_memory_context, 263-276è¡Œ)

```python
def _build_memory_context(self, memories: List[MemoryItem]) -> str:
    """å°†è®°å¿†åˆ—è¡¨æ ¼å¼åŒ–ä¸ºä¸Šä¸‹æ–‡å­—ç¬¦ä¸²"""
    if not memories:
        return ""
    
    context_parts = ["ã€ä¹‹å‰çš„å¯¹è¯è®°å¿†ã€‘"]
    for memory in memories:
        # æ ¼å¼åŒ–æ—¶é—´
        time_str = memory.timestamp.strftime("%H:%M")
        # æ·»åŠ è®°å¿†å†…å®¹
        context_parts.append(f"[{time_str}] {memory.content}")
    
    return "\n".join(context_parts)
```

**è¾“å…¥**:
```python
memories = [
    MemoryItem(content="ç©å®¶è¯´: ä½ å¥½", timestamp=datetime(2025,12,27,14,30)),
    MemoryItem(content="æˆ‘è¯´: ä½ å¥½!æˆ‘æ˜¯å¼ ä¸‰", timestamp=datetime(2025,12,27,14,31)),
    MemoryItem(content="ç©å®¶è¯´: ä½ åœ¨åšä»€ä¹ˆ?", timestamp=datetime(2025,12,27,14,32)),
]
```

**è¾“å‡º**:
```
ã€ä¹‹å‰çš„å¯¹è¯è®°å¿†ã€‘
[14:30] ç©å®¶è¯´: ä½ å¥½
[14:31] æˆ‘è¯´: ä½ å¥½!æˆ‘æ˜¯å¼ ä¸‰
[14:32] ç©å®¶è¯´: ä½ åœ¨åšä»€ä¹ˆ?
```

**è®¾è®¡æ€æƒ³**:
- âœ… ç®€æ´æ ¼å¼ - ä¸å ç”¨å¤ªå¤štoken
- âœ… æ—¶é—´æ ‡è®° - å¸®åŠ©NPCç†è§£æ—¶é—´é¡ºåº
- âœ… ç»“æ„åŒ– - ä¾¿äºLLMç†è§£

---

## æ ¸å¿ƒæµç¨‹åˆ†æ

### æµç¨‹1: ç³»ç»Ÿå¯åŠ¨

```python
# main.py
npc_manager = get_npc_manager()

# agents.py - get_npc_manager()
if _npc_manager is None:
    _npc_manager = NPCAgentManager()  # åˆ›å»ºå•ä¾‹
    â†“
# NPCAgentManager.__init__()
â”œâ”€â†’ åˆå§‹åŒ–LLM
â”œâ”€â†’ åˆ›å»ºRelationshipManager
â””â”€â†’ _create_agents()
    â”œâ”€â†’ ä¸ºæ¯ä¸ªNPCåˆ›å»ºAgent
    â””â”€â†’ ä¸ºæ¯ä¸ªNPCåˆ›å»ºMemoryManager
```

**å¯åŠ¨æ—¥å¿—**:
```
ğŸ¤– æ­£åœ¨åˆå§‹åŒ–NPC Agentç³»ç»Ÿ...
âœ… LLMåˆå§‹åŒ–æˆåŠŸ
  ğŸ’¾ å¼ ä¸‰çš„è®°å¿†ç³»ç»Ÿå·²åˆå§‹åŒ–
âœ… å¼ ä¸‰(Pythonå·¥ç¨‹å¸ˆ) Agentåˆ›å»ºæˆåŠŸ (è®°å¿†ç³»ç»Ÿå·²å¯ç”¨)
  ğŸ’¾ æå››çš„è®°å¿†ç³»ç»Ÿå·²åˆå§‹åŒ–
âœ… æå››(äº§å“ç»ç†) Agentåˆ›å»ºæˆåŠŸ (è®°å¿†ç³»ç»Ÿå·²å¯ç”¨)
  ğŸ’¾ ç‹äº”çš„è®°å¿†ç³»ç»Ÿå·²åˆå§‹åŒ–
âœ… ç‹äº”(UIè®¾è®¡å¸ˆ) Agentåˆ›å»ºæˆåŠŸ (è®°å¿†ç³»ç»Ÿå·²å¯ç”¨)
```

---

### æµç¨‹2: ç©å®¶å¯¹è¯

```python
# main.py APIè·¯ç”±
@app.post("/chat")
async def chat(request: ChatRequest):
    response = npc_manager.chat(
        npc_name=request.npc_name,
        message=request.message,
        player_id=request.player_id
    )
    return {"response": response}

# agents.py - chat()
â”œâ”€â†’ 1. è®°å½•å¯¹è¯å¼€å§‹
â”œâ”€â†’ 2. è·å–å¥½æ„Ÿåº¦ (relationship_manager)
â”œâ”€â†’ 3. æ£€ç´¢è®°å¿† (memory_manager)
â”œâ”€â†’ 4. æ„å»ºå¢å¼ºæç¤ºè¯
â”œâ”€â†’ 5. è°ƒç”¨Agentç”Ÿæˆå›å¤ (LLM)
â”œâ”€â†’ 6. åˆ†æå¹¶æ›´æ–°å¥½æ„Ÿåº¦ (relationship_manager)
â”œâ”€â†’ 7. ä¿å­˜å¯¹è¯åˆ°è®°å¿† (memory_manager)
â””â”€â†’ 8. è¿”å›å›å¤
```

**å®Œæ•´æ•°æ®æµ**:
```
ç©å®¶è¾“å…¥ "ä½ æœ€è¿‘åœ¨åšä»€ä¹ˆ?"
    â†“
[å¥½æ„Ÿåº¦ç³»ç»Ÿ] æŸ¥è¯¢: å¼ ä¸‰å¯¹playerçš„å¥½æ„Ÿåº¦ = 65 (æœ‹å‹)
    â†“
[è®°å¿†ç³»ç»Ÿ] æ£€ç´¢ç›¸å…³è®°å¿†:
    - "ç©å®¶è¯´: ä½ å¥½"
    - "æˆ‘è¯´: ä½ å¥½!æˆ‘æ˜¯å¼ ä¸‰"
    â†“
[æç¤ºè¯æ„å»º] ç»„åˆ:
    - ç³»ç»Ÿæç¤ºè¯ (è§’è‰²è®¾å®š)
    - å¥½æ„Ÿåº¦ä¸Šä¸‹æ–‡ (æœ‹å‹,ä¸»åŠ¨åˆ†äº«)
    - å†å²è®°å¿† (ä¹‹å‰è¯´è¿‡ä½ å¥½)
    - å½“å‰æ¶ˆæ¯ (ä½ æœ€è¿‘åœ¨åšä»€ä¹ˆ?)
    â†“
[LLMç”Ÿæˆ] "æœ€è¿‘åœ¨åšä¸€ä¸ªå¤šæ™ºèƒ½ä½“é¡¹ç›®,ç”¨HelloAgentsæ¡†æ¶,æŒºæœ‰æ„æ€çš„!"
    â†“
[æƒ…æ„Ÿåˆ†æ] sentiment="positive", change=+5
    â†“
[å¥½æ„Ÿåº¦æ›´æ–°] 65 â†’ 70
    â†“
[ä¿å­˜è®°å¿†] ä¿å­˜ç©å®¶æ¶ˆæ¯å’ŒNPCå›å¤ (å¸¦å¥½æ„Ÿåº¦å…ƒæ•°æ®)
    â†“
è¿”å›å›å¤ç»™ç©å®¶
```

---

## è®¾è®¡äº®ç‚¹

### 1. æ¨¡å—åŒ–è®¾è®¡ â­â­â­â­â­

```python
NPCAgentManager
    â”œâ”€â†’ HelloAgentsLLM (LLMæ¥å£)
    â”œâ”€â†’ SimpleAgent (AgentæŠ½è±¡)
    â”œâ”€â†’ MemoryManager (è®°å¿†ç³»ç»Ÿ)
    â””â”€â†’ RelationshipManager (å¥½æ„Ÿåº¦ç³»ç»Ÿ)
```

**ä¼˜åŠ¿**:
- âœ… ä½è€¦åˆ - æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€
- âœ… æ˜“æµ‹è¯• - å¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸ªæ¨¡å—
- âœ… æ˜“æ‰©å±• - å¯ä»¥æ›¿æ¢ä»»ä½•æ¨¡å—

---

### 2. æ•°æ®é©±åŠ¨é…ç½® â­â­â­â­â­

```python
# æ·»åŠ æ–°NPCåªéœ€æ·»åŠ é…ç½®
NPC_ROLES["èµµå…­"] = {
    "title": "è¿ç»´å·¥ç¨‹å¸ˆ",
    "personality": "ç¨³é‡å¯é ,æ³¨é‡ç»†èŠ‚",
    "expertise": "æœåŠ¡å™¨è¿ç»´ã€Dockerã€Kubernetes",
    "style": "æ¡ç†æ¸…æ™°,å–œæ¬¢ç”¨è¿ç»´æœ¯è¯­",
    "hobbies": "ç›‘æ§ç³»ç»Ÿã€ä¼˜åŒ–æ€§èƒ½"
}

# ä»£ç è‡ªåŠ¨å¤„ç†
for name, role in NPC_ROLES.items():
    create_agent(name, role)  # è‡ªåŠ¨åˆ›å»ºèµµå…­çš„Agent
```

**æ— éœ€ä¿®æ”¹ä»£ç é€»è¾‘**ï¼

---

### 3. ä¸Šä¸‹æ–‡å¢å¼ºæŠ€æœ¯ â­â­â­â­â­

**ä¼ ç»Ÿå¯¹è¯**:
```
ç©å®¶: èƒ½å†è¯¦ç»†è®²è®²å—?
NPC: è®²ä»€ä¹ˆ?  (æ²¡æœ‰ä¸Šä¸‹æ–‡)
```

**å¢å¼ºå¯¹è¯**:
```python
enhanced_message = f"""
ã€å½“å‰å…³ç³»ã€‘æœ‹å‹ (å¥½æ„Ÿåº¦: 65/100)
ã€å¯¹è¯é£æ ¼ã€‘ä¸»åŠ¨åˆ†äº«è¯é¢˜

ã€ä¹‹å‰çš„å¯¹è¯è®°å¿†ã€‘
[14:30] ç©å®¶è¯´: ä½ æœ€è¿‘åœ¨åšä»€ä¹ˆé¡¹ç›®?
[14:31] æˆ‘è¯´: åœ¨åšå¤šæ™ºèƒ½ä½“ç³»ç»Ÿ

ã€å½“å‰å¯¹è¯ã€‘
ç©å®¶: èƒ½å†è¯¦ç»†è®²è®²å—?
"""

â†“

NPC: "å½“ç„¶!è¿™ä¸ªå¤šæ™ºèƒ½ä½“ç³»ç»Ÿä½¿ç”¨HelloAgentsæ¡†æ¶..."
(æœ‰å®Œæ•´ä¸Šä¸‹æ–‡,ç†è§£"è®²ä»€ä¹ˆ")
```

**ä¸‰å±‚ä¸Šä¸‹æ–‡**:
1. å¥½æ„Ÿåº¦ä¸Šä¸‹æ–‡ - å½±å“è¯´è¯é£æ ¼
2. è®°å¿†ä¸Šä¸‹æ–‡ - æä¾›å†å²ä¿¡æ¯
3. å½“å‰å¯¹è¯ - æœ€æ–°æ¶ˆæ¯

---

### 4. å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ â­â­â­â­

```python
log_dialogue_start(npc_name, message)       # å¯¹è¯å¼€å§‹
log_affinity(npc_name, affinity, level)     # å½“å‰å¥½æ„Ÿåº¦
log_memory_retrieval(npc_name, count)       # è®°å¿†æ£€ç´¢
log_generating_response()                   # ç”Ÿæˆä¸­
log_npc_response(npc_name, response)        # NPCå›å¤
log_analyzing_affinity()                    # åˆ†ææƒ…æ„Ÿ
log_affinity_change(affinity_result)        # å¥½æ„Ÿåº¦å˜åŒ–
log_memory_saved(npc_name)                  # è®°å¿†ä¿å­˜
log_dialogue_end()                          # å¯¹è¯ç»“æŸ
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**:
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¬ å¯¹è¯å¼€å§‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ ç©å®¶ â†’ å¼ ä¸‰: "ä½ æœ€è¿‘åœ¨åšä»€ä¹ˆ?"

ğŸ“Š å½“å‰å¥½æ„Ÿåº¦
   å¼ ä¸‰: 65.0 (æœ‹å‹)

ğŸ’­ æ£€ç´¢åˆ° 3 æ¡ç›¸å…³è®°å¿†
   [14:30] ç©å®¶è¯´: ä½ å¥½
   [14:31] æˆ‘è¯´: ä½ å¥½!æˆ‘æ˜¯å¼ ä¸‰
   [14:32] ç©å®¶è¯´: ä½ æ˜¯åšä»€ä¹ˆçš„?

ğŸ¤– æ­£åœ¨ç”Ÿæˆå›å¤...

ğŸ’¬ å¼ ä¸‰ å›å¤: "æœ€è¿‘åœ¨åšå¤šæ™ºèƒ½ä½“é¡¹ç›®,ç”¨HelloAgentsæ¡†æ¶,æŒºæœ‰æ„æ€çš„!"

ğŸ” åˆ†æå¯¹è¯æƒ…æ„Ÿ...

ğŸ“ˆ å¥½æ„Ÿåº¦å˜åŒ–
   æƒ…æ„Ÿ: positive (å‹å–„)
   å˜åŒ–: 65.0 â†’ 70.0 (+5.0)
   åŸå› : ç©å®¶è¡¨è¾¾äº†å‹å–„æ€åº¦

ğŸ’¾ å¯¹è¯å·²ä¿å­˜åˆ°å¼ ä¸‰çš„è®°å¿†ä¸­

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… å¯¹è¯ç»“æŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**æ—¥å¿—çš„ä»·å€¼**:
- âœ… è°ƒè¯•æ–¹ä¾¿ - æ¸…æ¥šçœ‹åˆ°æ¯ä¸ªæ­¥éª¤
- âœ… æ€§èƒ½ç›‘æ§ - å‘ç°ç“¶é¢ˆ
- âœ… ç”¨æˆ·åé¦ˆ - ç†è§£ç³»ç»Ÿè¡Œä¸º

---

### 5. å…ƒæ•°æ®ä¸°å¯Œçš„è®°å¿† â­â­â­â­

```python
metadata = {
    "speaker": "player",
    "player_id": "player",
    "timestamp": "2025-12-27T14:30:00",
    "affinity": 65.0,              # â­ å½“æ—¶çš„å¥½æ„Ÿåº¦
    "affinity_change": +5.0,       # â­ å¥½æ„Ÿåº¦å˜åŒ–
    "sentiment": "positive",       # â­ æƒ…æ„Ÿå€¾å‘
    "context": {
        "interaction_type": "dialogue",
        "npc_name": "å¼ ä¸‰"
    }
}
```

**å¯ä»¥åšçš„åˆ†æ**:
1. å¥½æ„Ÿåº¦å˜åŒ–æ›²çº¿
2. å“ªäº›å¯¹è¯å½±å“æœ€å¤§
3. ç©å®¶çš„æƒ…æ„Ÿæ¨¡å¼
4. å¯¹è¯é¢‘ç‡ç»Ÿè®¡

---

### 6. å•ä¾‹æ¨¡å¼ä¿è¯å…¨å±€ä¸€è‡´ â­â­â­â­

```python
_npc_manager = None  # å…¨å±€å˜é‡

def get_npc_manager() -> NPCAgentManager:
    """è·å–å…¨å±€å”¯ä¸€å®ä¾‹"""
    global _npc_manager
    if _npc_manager is None:
        _npc_manager = NPCAgentManager()  # åªåˆ›å»ºä¸€æ¬¡
    return _npc_manager
```

**ä¼˜åŠ¿**:
- âœ… èŠ‚çœèµ„æº - LLMè¿æ¥åªå»ºç«‹ä¸€æ¬¡
- âœ… çŠ¶æ€ä¸€è‡´ - æ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ªç®¡ç†å™¨
- âœ… è®°å¿†è¿ç»­ - è®°å¿†ä¸ä¼šä¸¢å¤±

---

## å­¦ä¹ è¦ç‚¹

### â­â­â­â­â­ å¿…é¡»æŒæ¡

1. **chat()æ–¹æ³•çš„8æ­¥æµç¨‹**
   - ç†è§£æ¯ä¸€æ­¥çš„ä½œç”¨
   - ç†è§£æ•°æ®å¦‚ä½•æµè½¬
   - ç†è§£ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡

2. **ä¸Šä¸‹æ–‡å¢å¼ºæŠ€æœ¯**
   - å¥½æ„Ÿåº¦å¦‚ä½•å½±å“å¯¹è¯
   - è®°å¿†å¦‚ä½•æä¾›ä¸Šä¸‹æ–‡
   - æç¤ºè¯å¦‚ä½•ç»„åˆ

3. **è®°å¿†ç³»ç»Ÿé›†æˆ**
   - æ£€ç´¢è®°å¿† (retrieve_memories)
   - ä¿å­˜è®°å¿† (add_memory)
   - å…ƒæ•°æ®çš„ä½œç”¨

### â­â­â­â­ é‡ç‚¹ç†è§£

4. **æ•°æ®é©±åŠ¨é…ç½®**
   - NPC_ROLESçš„è®¾è®¡
   - å¦‚ä½•æ·»åŠ æ–°NPC
   - é…ç½®ä¸ä»£ç åˆ†ç¦»

5. **æ¨¡å—åŒ–è®¾è®¡**
   - å„æ¨¡å—çš„èŒè´£
   - æ¨¡å—é—´çš„äº¤äº’
   - ä¾èµ–æ³¨å…¥æ¨¡å¼

### â­â­â­ å»ºè®®äº†è§£

6. **å•ä¾‹æ¨¡å¼**
7. **æ—¥å¿—ç³»ç»Ÿ**
8. **é”™è¯¯å¤„ç†**

---

## ğŸ’¡ å®è·µå»ºè®®

### å®éªŒ1: æ·»åŠ ç¬¬4ä¸ªNPC

```python
NPC_ROLES["èµµå…­"] = {
    "title": "æµ‹è¯•å·¥ç¨‹å¸ˆ",
    "location": "æµ‹è¯•åŒº",
    "activity": "å†™æµ‹è¯•ç”¨ä¾‹",
    "personality": "ç»†å¿ƒè°¨æ…,è¿½æ±‚å®Œç¾",
    "expertise": "è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€Bugè¿½è¸ª",
    "style": "ä¸¥è°¨ä¸“ä¸š,å–œæ¬¢ç”¨æµ‹è¯•æœ¯è¯­",
    "hobbies": "ç¼–å†™æµ‹è¯•è„šæœ¬ã€ç ”ç©¶æµ‹è¯•æ¡†æ¶"
}
```

**é‡å¯æœåŠ¡ï¼Œè‡ªåŠ¨åˆ›å»ºèµµå…­çš„Agentï¼**

---

### å®éªŒ2: è°ƒæ•´è®°å¿†å®¹é‡

```python
memory_config = MemoryConfig(
    working_memory_capacity=20,  # ä»10æ”¹ä¸º20
    episodic_memory_capacity=200,  # ä»100æ”¹ä¸º200
    forgetting_threshold=0.2  # ä»0.3æ”¹ä¸º0.2 (æ›´å®¹æ˜“å¿˜è®°)
)
```

**æµ‹è¯•**: æ›´å¤šè®°å¿†æ˜¯å¦è®©å¯¹è¯æ›´è¿è´¯ï¼Ÿ

---

### å®éªŒ3: ä¿®æ”¹NPCæ€§æ ¼

```python
"å¼ ä¸‰": {
    "personality": "å¹½é»˜é£è¶£,å–œæ¬¢å¼€ç©ç¬‘",  # æ”¹å˜æ€§æ ¼
    "style": "è½»æ¾æ´»æ³¼,ç»å¸¸ç”¨è¡¨æƒ…ç¬¦å·",  # æ”¹å˜é£æ ¼
}
```

**æµ‹è¯•**: æ€§æ ¼å˜åŒ–å¦‚ä½•å½±å“å¯¹è¯é£æ ¼ï¼Ÿ

---

## ğŸ“Š ä»£ç è´¨é‡è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| å¯è¯»æ€§ | â­â­â­â­â­ | æ³¨é‡Šæ¸…æ™°,ç»“æ„æ¸…æ¥š |
| å¯ç»´æŠ¤æ€§ | â­â­â­â­â­ | æ¨¡å—åŒ–,æ˜“æ‰©å±• |
| å¥å£®æ€§ | â­â­â­â­ | æœ‰é”™è¯¯å¤„ç†,æ—¥å¿—å®Œå–„ |
| æ€§èƒ½ | â­â­â­â­ | å•ä¾‹æ¨¡å¼,è®°å¿†ç¼“å­˜ |
| åˆ›æ–°æ€§ | â­â­â­â­â­ | ä¸Šä¸‹æ–‡å¢å¼º,å…ƒæ•°æ®ä¸°å¯Œ |

**æ€»åˆ†**: 24/25 â­â­â­â­â­ (ä¼˜ç§€)

---

## ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆ agents.py å­¦ä¹ åï¼Œå»ºè®®ç»§ç»­å­¦ä¹ :

1. **relationship_manager.py** - ç†è§£å¥½æ„Ÿåº¦ç®—æ³•
2. **batch_generator.py** - ç†è§£æ‰¹é‡ä¼˜åŒ–åŸç†
3. **main.py** - ç†è§£APIè·¯ç”±è®¾è®¡
4. **api_client.gd** - ç†è§£å‰ç«¯å¦‚ä½•è°ƒç”¨API

---

**å­¦ä¹ å®Œæˆæ—¶é—´**: é¢„è®¡2-3å°æ—¶  
**å®è·µå»ºè®®**: è¾¹å­¦è¾¹åšå®éªŒï¼ŒåŠ æ·±ç†è§£  
**ä¸‹æ¬¡å¤ä¹ **: å¯åŠ¨æ¸¸æˆåå¯¹ç…§ä»£ç è§‚å¯Ÿè¿è¡Œ
