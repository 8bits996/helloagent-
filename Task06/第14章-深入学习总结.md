# ç¬¬14ç« æ·±å…¥å­¦ä¹ æ€»ç»“ - DeepResearch Agent

**å­¦ä¹ æ—¥æœŸ**: 2025-12-27  
**å­¦ä¹ è€…**: Franke Chen  
**çŠ¶æ€**: âœ… æ·±å…¥åˆ†æå®Œæˆ

---

## ğŸ“š å­¦ä¹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯å¯¹ç¬¬14ç«  DeepResearch Agent çš„æ·±å…¥åˆ†æï¼ŒåŸºäºå¯¹å®˜æ–¹ä»£ç çš„è¯¦ç»†ç ”ç©¶å’Œå®è·µã€‚

### æ ¸å¿ƒä»·å€¼
DeepResearch Agent å°†**1-2å°æ—¶çš„ç ”ç©¶å·¥ä½œå‹ç¼©åˆ°5-10åˆ†é’Ÿ**ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–çš„æ–¹å¼å®Œæˆï¼š
- ğŸ¯ **æ™ºèƒ½è§„åˆ’**: è‡ªåŠ¨å°†ç ”ç©¶ä¸»é¢˜åˆ†è§£ä¸º3-5ä¸ªå­ä»»åŠ¡
- ğŸ” **å¹¶è¡Œæœç´¢**: å¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå¤§å¹…æå‡æ•ˆç‡
- ğŸ“ **æ™ºèƒ½æ€»ç»“**: LLM è‡ªåŠ¨æå–å’Œæ•´åˆå…³é”®ä¿¡æ¯
- ğŸ“Š **ç»“æ„åŒ–è¾“å‡º**: ç”Ÿæˆå¸¦æ¥æºå¼•ç”¨çš„ç»“æ„åŒ–æŠ¥å‘Š

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ·±åº¦è§£æ

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DeepResearchAgent                        â”‚
â”‚                    (æ ¸å¿ƒåè°ƒå™¨ - agent.py)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ TODO Agent  â”‚  â”‚Summary Agent â”‚  â”‚ Report Agent â”‚       â”‚
â”‚  â”‚  (è§„åˆ’ä¸“å®¶) â”‚  â”‚  (æ€»ç»“ä¸“å®¶)  â”‚  â”‚  (æŠ¥å‘Šä¸“å®¶)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                 â”‚                   â”‚              â”‚
â”‚         â–¼                 â–¼                   â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Planner   â”‚  â”‚ Summarizer   â”‚  â”‚  Reporter    â”‚       â”‚
â”‚  â”‚   Service   â”‚  â”‚   Service    â”‚  â”‚   Service    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                 â”‚                   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                   â”‚
          â–¼                 â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            æœç´¢å±‚ (search.py)                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  DuckDuckGo  â”‚  Tavily  â”‚  Perplexity       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                   â”‚
          â–¼                 â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              å¤–éƒ¨æœåŠ¡                         â”‚
    â”‚  â€¢ æœç´¢å¼•æ“                                   â”‚
    â”‚  â€¢ LLM API (Qwen2.5-7B)                     â”‚
    â”‚  â€¢ å‘é‡æ•°æ®åº“ (å¯é€‰)                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¨¡å¼ï¼šTODO é©±åŠ¨çš„ç ”ç©¶èŒƒå¼

### ä¸‰é˜¶æ®µå·¥ä½œæµ

```python
# ç¬¬ä¸€é˜¶æ®µï¼šè§„åˆ’ (Planning)
ç ”ç©¶ä¸»é¢˜ â†’ PlanningService â†’ [Task1, Task2, Task3, Task4, Task5]

# ç¬¬äºŒé˜¶æ®µï¼šæ‰§è¡Œ (Execution) - å¹¶è¡Œ
Task1 â†’ æœç´¢ â†’ æ€»ç»“ â†’ Summary1
Task2 â†’ æœç´¢ â†’ æ€»ç»“ â†’ Summary2  # åŒæ—¶è¿›è¡Œ
Task3 â†’ æœç´¢ â†’ æ€»ç»“ â†’ Summary3  # åŒæ—¶è¿›è¡Œ
Task4 â†’ æœç´¢ â†’ æ€»ç»“ â†’ Summary4  # åŒæ—¶è¿›è¡Œ
Task5 â†’ æœç´¢ â†’ æ€»ç»“ â†’ Summary5  # åŒæ—¶è¿›è¡Œ

# ç¬¬ä¸‰é˜¶æ®µï¼šæŠ¥å‘Š (Reporting)
[Summary1, Summary2, ..., Summary5] â†’ ReportingService â†’ æœ€ç»ˆç ”ç©¶æŠ¥å‘Š
```

### ä¸ºä»€ä¹ˆä½¿ç”¨ TODO é©±åŠ¨ï¼Ÿ

**ä¼ ç»Ÿæ–¹æ³•çš„é—®é¢˜**:
```python
# ä¸€æ¬¡æ€§æœç´¢
query = "äººå·¥æ™ºèƒ½çš„å‘å±•"
results = search(query)  # æœç´¢ç»“æœå¯èƒ½è¿‡äºå®½æ³›æˆ–ç‰‡é¢
report = summarize(results)  # æ€»ç»“è´¨é‡å—é™äºå•æ¬¡æœç´¢
```

**TODO é©±åŠ¨çš„ä¼˜åŠ¿**:
```python
# åˆ†è§£ä¸ºå¤šä¸ªèšç„¦çš„å­ä»»åŠ¡
tasks = [
    "äººå·¥æ™ºèƒ½çš„å†å²å‘å±•",
    "å½“å‰ä¸»æµAIæŠ€æœ¯",
    "AIåœ¨å„è¡Œä¸šçš„åº”ç”¨",
    "AIé¢ä¸´çš„æŒ‘æˆ˜",
    "AIçš„æœªæ¥è¶‹åŠ¿"
]

# æ¯ä¸ªä»»åŠ¡éƒ½èƒ½å¾—åˆ°ç²¾å‡†çš„æœç´¢å’Œæ·±å…¥çš„åˆ†æ
for task in tasks:
    results = search(task)  # æ›´èšç„¦
    summary = summarize(results)  # æ›´æ·±å…¥
    
# æœ€ç»ˆæ•´åˆæ‰€æœ‰è§†è§’
final_report = integrate(all_summaries)  # æ›´å…¨é¢
```

**æ ¸å¿ƒä¼˜åŠ¿**:
1. âœ… **æ›´å…¨é¢**: å¤šä¸ªè§†è§’ï¼Œé¿å…ä¿¡æ¯ç›²åŒº
2. âœ… **æ›´æ·±å…¥**: æ¯ä¸ªå­ä»»åŠ¡éƒ½èƒ½æ·±å…¥åˆ†æ
3. âœ… **æ›´é«˜æ•ˆ**: å¹¶è¡Œæ‰§è¡Œï¼Œæ—¶é—´å¤§å¹…ç¼©çŸ­
4. âœ… **æ›´å¯æ§**: å¯ä»¥ç›‘æ§æ¯ä¸ªä»»åŠ¡çš„è¿›åº¦

---

## ğŸ’» æ ¸å¿ƒä»£ç è§£æ

### 1. DeepResearchAgent ç±» (agent.py:32-552)

**èŒè´£**: æ•´ä¸ªç ”ç©¶æµç¨‹çš„åè°ƒå™¨

#### åˆå§‹åŒ–è¿‡ç¨‹
```python
class DeepResearchAgent:
    def __init__(self, config: Configuration | None = None):
        # 1. åŠ è½½é…ç½®
        self.config = config or Configuration.from_env()
        
        # 2. åˆå§‹åŒ– LLM (æ”¯æŒå¤šç§ provider)
        self.llm = self._init_llm()  # agent.py:79-107
        
        # 3. åˆ›å»ºå·¥å…·æ³¨å†Œè¡¨ (å¯é€‰)
        self.note_tool = NoteTool(...)  # ç¬”è®°å·¥å…·
        self.tools_registry = ToolRegistry()
        
        # 4. åˆ›å»ºä¸‰ä¸ªä¸“å®¶ Agent
        self.todo_agent = self._create_tool_aware_agent(
            name="ç ”ç©¶è§„åˆ’ä¸“å®¶",
            system_prompt=todo_planner_system_prompt
        )
        
        self.report_agent = self._create_tool_aware_agent(
            name="æŠ¥å‘Šæ’°å†™ä¸“å®¶",
            system_prompt=report_writer_instructions
        )
        
        # æ€»ç»“ä¸“å®¶ä½¿ç”¨å·¥å‚æ¨¡å¼ï¼ˆå¹¶è¡Œæ—¶éœ€è¦å¤šä¸ªå®ä¾‹ï¼‰
        self._summarizer_factory = lambda: self._create_tool_aware_agent(
            name="ä»»åŠ¡æ€»ç»“ä¸“å®¶",
            system_prompt=task_summarizer_instructions
        )
        
        # 5. åˆ›å»ºæœåŠ¡å±‚
        self.planner = PlanningService(self.todo_agent, self.config)
        self.summarizer = SummarizationService(self._summarizer_factory, self.config)
        self.reporting = ReportingService(self.report_agent, self.config)
```

**è®¾è®¡äº®ç‚¹**:
- âœ¨ **ä¾èµ–æ³¨å…¥**: LLMã€å·¥å…·æ³¨å†Œè¡¨éƒ½æ˜¯å¤–éƒ¨æ³¨å…¥ï¼Œä¾¿äºæµ‹è¯•
- âœ¨ **å·¥å‚æ¨¡å¼**: æ€»ç»“ä¸“å®¶ä½¿ç”¨å·¥å‚åˆ›å»ºï¼Œæ”¯æŒå¹¶è¡Œ
- âœ¨ **å•ä¸€èŒè´£**: æ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½

#### æ ¸å¿ƒæ–¹æ³• 1: run() - åŒæ­¥æ‰§è¡Œ

```python
def run(self, topic: str) -> SummaryStateOutput:
    """
    åŒæ­¥æ‰§è¡Œç ”ç©¶æµç¨‹
    agent.py:125-148
    """
    # 1. åˆå§‹åŒ–çŠ¶æ€
    state = SummaryState(research_topic=topic)
    
    # 2. è§„åˆ’é˜¶æ®µï¼šç”Ÿæˆ TODO åˆ—è¡¨
    state.todo_items = self.planner.plan_todo_list(state)
    
    # 3. æ‰§è¡Œé˜¶æ®µï¼šé¡ºåºæ‰§è¡Œæ¯ä¸ªä»»åŠ¡
    for task in state.todo_items:
        self._execute_task(state, task, emit_stream=False)
    
    # 4. æŠ¥å‘Šé˜¶æ®µï¼šç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
    report = self.reporting.generate_report(state)
    state.structured_report = report
    
    return SummaryStateOutput(
        running_summary=report,
        report_markdown=report,
        todo_items=state.todo_items
    )
```

**ç‰¹ç‚¹**: ç®€å•ç›´æ¥ï¼Œé€‚åˆè„šæœ¬è°ƒç”¨

#### æ ¸å¿ƒæ–¹æ³• 2: run_stream() - æµå¼æ‰§è¡Œ â­â­â­

```python
def run_stream(self, topic: str) -> Iterator[dict[str, Any]]:
    """
    æµå¼æ‰§è¡Œç ”ç©¶æµç¨‹ï¼Œå®æ—¶æ¨é€è¿›åº¦
    agent.py:150-284
    
    è¿™æ˜¯å‰ç«¯ä½¿ç”¨çš„æ ¸å¿ƒæ–¹æ³•ï¼
    """
    state = SummaryState(research_topic=topic)
    
    # å‘é€åˆå§‹çŠ¶æ€
    yield {"type": "status", "message": "åˆå§‹åŒ–ç ”ç©¶æµç¨‹"}
    
    # 1. è§„åˆ’é˜¶æ®µ
    state.todo_items = self.planner.plan_todo_list(state)
    
    # å‘é€ TODO åˆ—è¡¨
    yield {
        "type": "todo_list",
        "tasks": [self._serialize_task(t) for t in state.todo_items],
        "step": 0
    }
    
    # 2. å¹¶è¡Œæ‰§è¡Œé˜¶æ®µ â­ æ ¸å¿ƒåˆ›æ–°
    event_queue: Queue[dict[str, Any]] = Queue()
    threads: list[Thread] = []
    
    def worker(task: TodoItem, step: int):
        """æ¯ä¸ªä»»åŠ¡åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œ"""
        # å‘é€ä»»åŠ¡å¼€å§‹äº‹ä»¶
        enqueue({
            "type": "task_status",
            "task_id": task.id,
            "status": "in_progress",
            "title": task.title
        })
        
        # æ‰§è¡Œä»»åŠ¡ï¼ˆæœç´¢ + æ€»ç»“ï¼‰
        for event in self._execute_task(state, task, emit_stream=True, step=step):
            enqueue(event)
        
        # å‘é€ä»»åŠ¡å®Œæˆæ ‡è®°
        enqueue({"type": "__task_done__", "task_id": task.id})
    
    # ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºçº¿ç¨‹
    for task in state.todo_items:
        thread = Thread(target=worker, args=(task, step), daemon=True)
        threads.append(thread)
        thread.start()  # ğŸš€ å¹¶è¡Œå¯åŠ¨
    
    # 3. äº‹ä»¶åˆ†å‘å¾ªç¯
    active_workers = len(state.todo_items)
    finished_workers = 0
    
    while finished_workers < active_workers:
        event = event_queue.get()  # é˜»å¡ç­‰å¾…äº‹ä»¶
        
        if event.get("type") == "__task_done__":
            finished_workers += 1
            continue
        
        yield event  # å®æ—¶æ¨é€ç»™å‰ç«¯
    
    # 4. æŠ¥å‘Šé˜¶æ®µ
    report = self.reporting.generate_report(state)
    yield {
        "type": "final_report",
        "report": report,
        "note_id": state.report_note_id
    }
    
    yield {"type": "done"}
```

**è®¾è®¡äº®ç‚¹**:
- ğŸŒŸ **å¹¶è¡Œæ‰§è¡Œ**: å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œï¼Œå¤§å¹…æå‡é€Ÿåº¦
- ğŸŒŸ **å®æ—¶æ¨é€**: é€šè¿‡ SSE å®æ—¶æ¨é€è¿›åº¦ç»™å‰ç«¯
- ğŸŒŸ **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ Queue è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡
- ğŸŒŸ **äº‹ä»¶é©±åŠ¨**: ç»Ÿä¸€çš„äº‹ä»¶æ ¼å¼ï¼Œå‰ç«¯æ˜“äºå¤„ç†

#### æ ¸å¿ƒæ–¹æ³• 3: _execute_task() - å•ä»»åŠ¡æ‰§è¡Œ

```python
def _execute_task(
    self, 
    state: SummaryState, 
    task: TodoItem,
    emit_stream: bool,
    step: int | None = None
) -> Iterator[dict[str, Any]]:
    """
    æ‰§è¡Œå•ä¸ªç ”ç©¶ä»»åŠ¡
    agent.py:289-413
    
    æµç¨‹ï¼šæœç´¢ â†’ æå–æ¥æº â†’ æ€»ç»“
    """
    task.status = "in_progress"
    
    # 1. æœç´¢é˜¶æ®µ
    search_result, notices, answer_text, backend = dispatch_search(
        task.query,
        self.config,
        state.research_loop_count
    )
    
    if not search_result or not search_result.get("results"):
        task.status = "skipped"
        yield {"type": "task_status", "status": "skipped"}
        return
    
    # 2. æå–æ¥æºå’Œä¸Šä¸‹æ–‡
    sources_summary, context = prepare_research_context(
        search_result,
        answer_text,
        self.config
    )
    
    task.sources_summary = sources_summary
    
    # æ·»åŠ åˆ°å…¨å±€çŠ¶æ€
    state.web_research_results.append(context)
    state.sources_gathered.append(sources_summary)
    
    # å‘é€æ¥æºä¿¡æ¯
    yield {
        "type": "sources",
        "task_id": task.id,
        "latest_sources": sources_summary,
        "raw_context": context,
        "backend": backend
    }
    
    # 3. æ€»ç»“é˜¶æ®µ (æµå¼)
    if emit_stream:
        summary_stream, summary_getter = self.summarizer.stream_task_summary(
            state, task, context
        )
        
        for chunk in summary_stream:
            yield {
                "type": "task_summary_chunk",
                "task_id": task.id,
                "content": chunk  # å®æ—¶æ¨é€æ€»ç»“å†…å®¹
            }
        
        summary_text = summary_getter()  # è·å–å®Œæ•´æ€»ç»“
    else:
        summary_text = self.summarizer.summarize_task(state, task, context)
    
    task.summary = summary_text.strip()
    task.status = "completed"
    
    # å‘é€ä»»åŠ¡å®Œæˆ
    yield {
        "type": "task_status",
        "task_id": task.id,
        "status": "completed",
        "summary": task.summary
    }
```

**å…³é”®ç‚¹**:
- âœ… æœç´¢å¤±è´¥æ—¶ä¼šè·³è¿‡ä»»åŠ¡
- âœ… æ¥æºä¿¡æ¯ä¼šä¿å­˜åˆ°å…¨å±€çŠ¶æ€
- âœ… æ”¯æŒæµå¼æ€»ç»“ï¼ˆè¾¹ç”Ÿæˆè¾¹æ¨é€ï¼‰

---

### 2. PlanningService ç±» (planner.py:24-67)

**èŒè´£**: å°†ç ”ç©¶ä¸»é¢˜åˆ†è§£ä¸ºå¯æ‰§è¡Œçš„å­ä»»åŠ¡

```python
class PlanningService:
    def plan_todo_list(self, state: SummaryState) -> List[TodoItem]:
        """
        ä½¿ç”¨è§„åˆ’ Agent ç”Ÿæˆ TODO åˆ—è¡¨
        planner.py:31-67
        """
        # 1. æ„å»º prompt
        prompt = todo_planner_instructions.format(
            current_date=get_current_date(),
            research_topic=state.research_topic
        )
        
        # 2. è°ƒç”¨ LLM
        response = self._agent.run(prompt)
        self._agent.clear_history()  # æ¸…ç©ºå†å²ï¼ˆè§„åˆ’æ˜¯æ— çŠ¶æ€çš„ï¼‰
        
        # 3. è§£æ LLM è¿”å›çš„ JSON
        tasks_payload = self._extract_tasks(response)
        
        # 4. æ„å»º TodoItem å¯¹è±¡
        todo_items: List[TodoItem] = []
        for idx, item in enumerate(tasks_payload, start=1):
            task = TodoItem(
                id=idx,
                title=item.get("title"),
                intent=item.get("intent"),
                query=item.get("query")  # ç”¨äºæœç´¢çš„æŸ¥è¯¢è¯
            )
            todo_items.append(task)
        
        return todo_items
```

**Prompt è®¾è®¡è¦ç‚¹**:
```
ä½ æ˜¯ç ”ç©¶è§„åˆ’ä¸“å®¶ï¼Œéœ€è¦å°†ä¸»é¢˜åˆ†è§£ä¸º3-5ä¸ªå­ä»»åŠ¡ã€‚

æ¯ä¸ªä»»åŠ¡éœ€åŒ…å«ï¼š
- title: ä»»åŠ¡æ ‡é¢˜
- intent: ä»»åŠ¡ç›®çš„
- query: æœç´¢æŸ¥è¯¢è¯ï¼ˆå…³é”®ï¼ï¼‰

è¾“å‡ºæ ¼å¼ï¼šJSON
{
  "tasks": [
    {"title": "...", "intent": "...", "query": "..."},
    ...
  ]
}
```

**è®¾è®¡å·§æ€**:
- â­ **query å­—æ®µ**: ä¸“é—¨ä¼˜åŒ–ç”¨äºæœç´¢ï¼Œè€Œéç›´æ¥ä½¿ç”¨ title
- â­ **fallbackæœºåˆ¶**: å¦‚æœè§„åˆ’å¤±è´¥ï¼Œåˆ›å»ºé»˜è®¤ä»»åŠ¡

---

### 3. SummarizationService ç±» (summarizer.py:17-46)

**èŒè´£**: ä»æœç´¢ç»“æœä¸­æå–å…³é”®ä¿¡æ¯

```python
class SummarizationService:
    def summarize_task(self, state: SummaryState, task: TodoItem, context: str) -> str:
        """
        åŒæ­¥æ€»ç»“
        summarizer.py:28-45
        """
        prompt = self._build_prompt(state, task, context)
        
        # åˆ›å»ºæ–°çš„ agent å®ä¾‹ï¼ˆå¹¶è¡Œæ—¶æ¯ä¸ªä»»åŠ¡ä¸€ä¸ªï¼‰
        agent = self._agent_factory()
        try:
            response = agent.run(prompt)
        finally:
            agent.clear_history()
        
        # æ¸…ç†è¾“å‡º
        summary_text = response.strip()
        if self._config.strip_thinking_tokens:
            summary_text = strip_thinking_tokens(summary_text)
        
        return summary_text or "æš‚æ— å¯ç”¨ä¿¡æ¯"
    
    def stream_task_summary(self, ...) -> Tuple[Iterator[str], Callable[[], str]]:
        """
        æµå¼æ€»ç»“ï¼ˆè¾¹ç”Ÿæˆè¾¹æ¨é€ï¼‰
        summarizer.py:47-80
        
        è¿”å›: (æµå¼ç”Ÿæˆå™¨, è·å–å®Œæ•´å†…å®¹çš„å‡½æ•°)
        """
        # å®ç°å¤æ‚ï¼Œæ”¯æŒï¼š
        # 1. å®æ—¶æ¨é€ç”Ÿæˆçš„æ–‡æœ¬
        # 2. è¿‡æ»¤ <think></think> æ ‡ç­¾
        # 3. æ”¶é›†å®Œæ•´å†…å®¹ç”¨äºåç»­å¤„ç†
```

**Prompt ç»“æ„**:
```
ç ”ç©¶ä¸»é¢˜: {state.research_topic}
å½“å‰ä»»åŠ¡: {task.title}
ä»»åŠ¡ç›®çš„: {task.intent}

æœç´¢ç»“æœ:
{context}

è¯·æå–å…³é”®ä¿¡æ¯ï¼Œå†™æˆç®€æ´çš„æ€»ç»“ã€‚
è¦æ±‚ï¼š
- èšç„¦ä»»åŠ¡ç›®çš„
- åŒ…å«å…³é”®æ•°æ®å’Œäº‹å®
- åˆ—å‡ºé‡è¦æ¥æº
```

---

### 4. æœç´¢å±‚ (search.py)

**èŒè´£**: ç»Ÿä¸€ç®¡ç†å¤šä¸ªæœç´¢å¼•æ“

```python
def dispatch_search(
    query: str,
    config: Configuration,
    loop_count: int
) -> Tuple[dict, list[str], str, str]:
    """
    æ ¹æ®é…ç½®é€‰æ‹©æœç´¢å¼•æ“
    search.py ä¸­
    """
    search_api = config.search_api.lower()
    
    if search_api == "duckduckgo":
        return duckduckgo_search(query, config)
    elif search_api == "tavily":
        return tavily_search(query, config)
    elif search_api == "perplexity":
        return perplexity_search(query, config)
    else:
        raise ValueError(f"Unknown search API: {search_api}")
```

**æ”¯æŒçš„æœç´¢å¼•æ“**:
1. **DuckDuckGo** (å…è´¹)
   - ä¼˜ç‚¹: å®Œå…¨å…è´¹ï¼Œæ— éœ€ API key
   - ç¼ºç‚¹: ç»“æœè´¨é‡ä¸€èˆ¬ï¼Œå¯èƒ½è¢«é™æµ

2. **Tavily** (æ¨è)
   - ä¼˜ç‚¹: AI ä¼˜åŒ–çš„æœç´¢ï¼Œç»“æœè´¨é‡é«˜
   - ç¼ºç‚¹: å…è´¹ç‰ˆæœ‰è°ƒç”¨æ¬¡æ•°é™åˆ¶

3. **Perplexity** (é«˜çº§)
   - ä¼˜ç‚¹: æœ€æ™ºèƒ½çš„æœç´¢ï¼Œç›´æ¥è¿”å›ç­”æ¡ˆ
   - ç¼ºç‚¹: éœ€è¦ä»˜è´¹ API

---

## ğŸ“ æ ¸å¿ƒæ¦‚å¿µæ€»ç»“

### 1. ä¸‰ Agent é¡ºåºåä½œæ¨¡å¼

```
TODO Planner Agent (è§„åˆ’ä¸“å®¶)
    â†“ è¾“å‡º: [Task1, Task2, Task3, ...]
    
Task Summarizer Agent (æ€»ç»“ä¸“å®¶) Ã— N  # å¹¶è¡Œ
    â†“ è¾“å‡º: [Summary1, Summary2, Summary3, ...]
    
Report Writer Agent (æŠ¥å‘Šä¸“å®¶)
    â†“ è¾“å‡º: æœ€ç»ˆç ”ç©¶æŠ¥å‘Š
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¸‰ä¸ª Agentï¼Ÿ**
- ğŸ¯ **ä¸“ä¸šåŒ–**: æ¯ä¸ª Agent ä¸“æ³¨äºä¸€ä¸ªä»»åŠ¡ï¼Œæ•ˆæœæ›´å¥½
- ğŸ¯ **å¯æ§æ€§**: æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥å•ç‹¬ä¼˜åŒ–å’Œè°ƒè¯•
- ğŸ¯ **å¯æ‰©å±•**: å¯ä»¥è½»æ¾æ›¿æ¢æˆ–å¢å¼ºæŸä¸ª Agent

### 2. å¹¶è¡Œæ‰§è¡Œæ¶æ„

```python
# ä¼ ç»Ÿé¡ºåºæ‰§è¡Œ (è€—æ—¶ = N * å•ä»»åŠ¡æ—¶é—´)
Task1 â†’ Task2 â†’ Task3 â†’ Task4 â†’ Task5  # æ€»è€—æ—¶ = 50ç§’

# å¹¶è¡Œæ‰§è¡Œ (è€—æ—¶ = max(å„ä»»åŠ¡æ—¶é—´))
Task1 â†˜
Task2 â†’ â†˜
Task3 â†’  â†’ åˆå¹¶ â†’ æŠ¥å‘Š  # æ€»è€—æ—¶ = 15ç§’
Task4 â†’ â†—
Task5 â†—
```

**å®ç°å…³é”®**:
- âœ… çº¿ç¨‹æ± : æ¯ä¸ªä»»åŠ¡åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œ
- âœ… Queue: çº¿ç¨‹å®‰å…¨çš„äº‹ä»¶é˜Ÿåˆ—
- âœ… çŠ¶æ€ç®¡ç†: ä½¿ç”¨é”ä¿æŠ¤å…±äº«çŠ¶æ€

### 3. æµå¼å“åº”è®¾è®¡

**ä¸ºä»€ä¹ˆéœ€è¦æµå¼å“åº”ï¼Ÿ**
```
åŒæ­¥æ–¹å¼ (ç”¨æˆ·ä½“éªŒå·®):
[ç­‰å¾…5åˆ†é’Ÿ] â†’ ä¸€æ¬¡æ€§è¿”å›å®Œæ•´æŠ¥å‘Š

æµå¼æ–¹å¼ (ç”¨æˆ·ä½“éªŒå¥½):
[0ç§’] â†’ æ˜¾ç¤º TODO åˆ—è¡¨
[10ç§’] â†’ Task1 æœç´¢ç»“æœ
[15ç§’] â†’ Task1 æ€»ç»“ï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰
[20ç§’] â†’ Task2 æœç´¢ç»“æœ
...
[5åˆ†é’Ÿ] â†’ æœ€ç»ˆæŠ¥å‘Š
```

**æŠ€æœ¯å®ç°**: SSE (Server-Sent Events)
```python
# FastAPI ç«¯
async def research_stream(topic: str):
    async def event_stream():
        for event in agent.run_stream(topic):
            yield f"data: {json.dumps(event)}\n\n"
    
    return StreamingResponse(
        event_stream(),
        media_type="text/event-stream"
    )

# å‰ç«¯ JavaScript
const eventSource = new EventSource('/research/stream');
eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    // æ ¹æ® data.type æ›´æ–° UI
};
```

---

## ğŸ’¡ æ ¸å¿ƒå­¦ä¹ è¦ç‚¹

### è®¾è®¡æ¨¡å¼åº”ç”¨

1. **å·¥å‚æ¨¡å¼** (Factory Pattern)
   ```python
   # ç”¨äºåˆ›å»ºæ€»ç»“ Agent (å¹¶è¡Œæ—¶éœ€è¦å¤šä¸ªå®ä¾‹)
   self._summarizer_factory: Callable[[], ToolAwareSimpleAgent] = \
       lambda: self._create_tool_aware_agent(...)
   ```

2. **ä¾èµ–æ³¨å…¥** (Dependency Injection)
   ```python
   # å¤–éƒ¨ä¼ å…¥ LLMã€é…ç½®ç­‰ï¼Œä¾¿äºæµ‹è¯•å’Œæ‰©å±•
   def __init__(self, config: Configuration | None = None):
       self.config = config or Configuration.from_env()
       self.llm = self._init_llm()
   ```

3. **è§‚å¯Ÿè€…æ¨¡å¼** (Observer Pattern)
   ```python
   # å·¥å…·è°ƒç”¨äº‹ä»¶è¿½è¸ª
   tool_call_listener=self._tool_tracker.record
   ```

4. **ç­–ç•¥æ¨¡å¼** (Strategy Pattern)
   ```python
   # ä¸åŒçš„æœç´¢å¼•æ“ç­–ç•¥
   if search_api == "duckduckgo":
       return duckduckgo_search(...)
   elif search_api == "tavily":
       return tavily_search(...)
   ```

### å…³é”®æŠ€æœ¯ç‚¹

1. **çº¿ç¨‹å®‰å…¨**
   ```python
   # ä½¿ç”¨é”ä¿æŠ¤å…±äº«çŠ¶æ€
   with self._state_lock:
       state.web_research_results.append(context)
       state.research_loop_count += 1
   ```

2. **æµå¼ç”Ÿæˆ**
   ```python
   # ä½¿ç”¨ yield å®ç°æµå¼å“åº”
   def run_stream(self, topic: str) -> Iterator[dict[str, Any]]:
       yield {"type": "status", "message": "å¼€å§‹"}
       # ...
       yield {"type": "done"}
   ```

3. **é”™è¯¯å¤„ç†**
   ```python
   # ä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
   try:
       for event in self._execute_task(...):
           enqueue(event)
   except Exception as exc:
       logger.exception("Task execution failed")
       enqueue({"type": "task_status", "status": "failed"})
   ```

### æ€§èƒ½ä¼˜åŒ–

1. **å¹¶è¡Œæ‰§è¡Œ**: 5ä¸ªä»»åŠ¡ä»50ç§’é™åˆ°15ç§’ï¼ˆæå‡70%ï¼‰
2. **æµå¼å“åº”**: ç”¨æˆ·æ— éœ€ç­‰å¾…ï¼Œå®æ—¶çœ‹åˆ°è¿›åº¦
3. **æ™ºèƒ½æœç´¢**: ä½¿ç”¨ä¼˜åŒ–çš„æŸ¥è¯¢è¯æé«˜æœç´¢å‡†ç¡®åº¦
4. **ç»“æœç¼“å­˜**: NoteTool å¯ä»¥ç¼“å­˜ä¸­é—´ç»“æœ

---

## ğŸš€ å®è·µå»ºè®®

### 1. å¦‚ä½•ä¼˜åŒ–ç ”ç©¶è´¨é‡

**é…ç½®ä¼˜åŒ–**:
```ini
# ä½¿ç”¨æ›´å¥½çš„æœç´¢å¼•æ“
SEARCH_API=tavily

# è·å–å®Œæ•´é¡µé¢å†…å®¹
FETCH_FULL_PAGE=True

# å¢åŠ ç ”ç©¶å¾ªç¯æ¬¡æ•°
MAX_WEB_RESEARCH_LOOPS=3
```

**Prompt ä¼˜åŒ–**:
- åœ¨è§„åˆ’é˜¶æ®µç»™å‡ºæ›´å…·ä½“çš„æŒ‡å¯¼
- åœ¨æ€»ç»“é˜¶æ®µå¼ºè°ƒå…³é”®ä¿¡æ¯æå–
- åœ¨æŠ¥å‘Šé˜¶æ®µè¦æ±‚ç»“æ„åŒ–è¾“å‡º

### 2. å¦‚ä½•æå‡é€Ÿåº¦

```ini
# ä½¿ç”¨æ›´å¿«çš„æœç´¢å¼•æ“
SEARCH_API=duckduckgo

# åªè·å–æ‘˜è¦
FETCH_FULL_PAGE=False

# å‡å°‘å¾ªç¯æ¬¡æ•°
MAX_WEB_RESEARCH_LOOPS=2

# ä½¿ç”¨æ›´å°çš„æ¨¡å‹
LLM_MODEL_ID=Qwen/Qwen2.5-3B-Instruct
```

### 3. å¦‚ä½•é™ä½æˆæœ¬

**é€‰æ‹©ç­–ç•¥**:
- æœç´¢: DuckDuckGo (å…è´¹) > Tavily (æœ‰é™åˆ¶) > Perplexity (ä»˜è´¹)
- LLM: Qwen2.5-1.5B (ä¾¿å®œ) > Qwen2.5-7B (ä¸­ç­‰) > GPT-4 (æ˜‚è´µ)

**ä¼˜åŒ–æŠ€å·§**:
```python
# ç¼“å­˜é‡å¤æŸ¥è¯¢
# å‡å°‘ä¸å¿…è¦çš„ LLM è°ƒç”¨
# ä½¿ç”¨æ›´å°çš„ä¸Šä¸‹æ–‡çª—å£
```

---

## ğŸ“Š ä¸å‰é¢ç« èŠ‚çš„è”ç³»

### Task01: ç»å…¸èŒƒå¼
- âœ… DeepResearch ä½¿ç”¨äº† **ReAct å˜ä½“**
- âœ… è§„åˆ’-æ‰§è¡Œ-æ€»ç»“ ä½“ç°äº† **Plan-and-Solve**
- âœ… è¿­ä»£ä¼˜åŒ–ä½“ç°äº† **Reflection**

### Task02: Agent æ¡†æ¶
- âœ… ä½¿ç”¨ `ToolAwareSimpleAgent` ä½œä¸ºåŸºç¡€
- âœ… å·¥å…·æ³¨å†Œè¡¨ `ToolRegistry` ç»Ÿä¸€ç®¡ç†å·¥å…·
- âœ… æœåŠ¡å±‚å°è£…ä½“ç°äº†æ¡†æ¶åŒ–æ€ç»´

### Task03: è®°å¿†ä¸æ£€ç´¢
- âœ… NoteTool æä¾›æŒä¹…åŒ–è®°å¿†
- âœ… æœç´¢ç»“æœç›¸å½“äºå¤–éƒ¨çŸ¥è¯†æ£€ç´¢
- âœ… ä¸Šä¸‹æ–‡ç®¡ç†å¾ˆé‡è¦

### Task04: ä¸Šä¸‹æ–‡å·¥ç¨‹
- âœ… æœç´¢ç»“æœéœ€è¦å‹ç¼©å’Œç­›é€‰
- âœ… æ¯ä¸ªä»»åŠ¡çš„ä¸Šä¸‹æ–‡ç‹¬ç«‹ç®¡ç†
- âœ… æœ€ç»ˆæŠ¥å‘Šéœ€è¦æ•´åˆæ‰€æœ‰ä¸Šä¸‹æ–‡

### Task05: MCP åè®®
- âœ… NoteTool éµå¾ª MCP å·¥å…·è§„èŒƒ
- âœ… å¯ä»¥æ‰©å±•æ›´å¤š MCP å·¥å…·
- âœ… å·¥å…·è°ƒç”¨äº‹ä»¶è¿½è¸ª

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ç†è®ºå·²æŒæ¡**: æ·±å…¥ç†è§£äº†ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡
2. â³ **å®è·µæµ‹è¯•**: ä½¿ç”¨ç³»ç»Ÿè¿›è¡Œå®é™…ç ”ç©¶ä»»åŠ¡
3. âšª **ä»£ç å®è·µ**: å°è¯•ä¿®æ”¹å’Œæ‰©å±•åŠŸèƒ½
4. âšª **ç¬¬15ç« **: ç»§ç»­å­¦ä¹ èµ›åšå°é•‡

---

**åˆ›å»ºæ—¶é—´**: 2025-12-27  
**å­¦ä¹ æ·±åº¦**: â­â­â­â­â­ (æ·±å…¥åˆ†æ)  
**ç†è§£ç¨‹åº¦**: âœ… å®Œå…¨ç†è§£
