# relationship_manager.py - æ·±åº¦ä»£ç è§£æ

**æ–‡ä»¶ä½ç½®**: `backend/relationship_manager.py`  
**ä»£ç è¡Œæ•°**: 325è¡Œ  
**æ ¸å¿ƒèŒè´£**: NPCå¥½æ„Ÿåº¦ç®¡ç†ç³»ç»Ÿ  
**å­¦ä¹ æ—¥æœŸ**: 2025-12-27

---

## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [äº”çº§å¥½æ„Ÿåº¦ä½“ç³»](#äº”çº§å¥½æ„Ÿåº¦ä½“ç³»)
3. [æ ¸å¿ƒç±»è¯¦è§£](#æ ¸å¿ƒç±»è¯¦è§£)
4. [æƒ…æ„Ÿåˆ†ææœºåˆ¶](#æƒ…æ„Ÿåˆ†ææœºåˆ¶)
5. [è®¾è®¡äº®ç‚¹](#è®¾è®¡äº®ç‚¹)
6. [å®è·µæ¡ˆä¾‹](#å®è·µæ¡ˆä¾‹)

---

## ç³»ç»Ÿæ¦‚è¿°

### è®¾è®¡ç›®æ ‡

åˆ›å»ºä¸€ä¸ª**æ™ºèƒ½å¥½æ„Ÿåº¦ç³»ç»Ÿ**ï¼Œè®©NPCèƒ½å¤Ÿï¼š
- âœ… æ ¹æ®ç©å®¶è¨€è¡ŒåŠ¨æ€è°ƒæ•´å¥½æ„Ÿåº¦
- âœ… ä½¿ç”¨LLMè‡ªåŠ¨åˆ†æå¯¹è¯æƒ…æ„Ÿ
- âœ… æ ¹æ®å¥½æ„Ÿåº¦ç­‰çº§æ”¹å˜è¯´è¯é£æ ¼
- âœ… æä¾›å¹³æ»‘çš„å…³ç³»æ¼”è¿›ä½“éªŒ

### æ ¸å¿ƒåŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RelationshipManagerï¼ˆå¥½æ„Ÿåº¦ç®¡ç†å™¨ï¼‰  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å­˜å‚¨å¥½æ„Ÿåº¦ (0-100åˆ†)              â”‚
â”‚ 2. åˆ†æå¯¹è¯æƒ…æ„Ÿ (LLMé©±åŠ¨)            â”‚
â”‚ 3. è‡ªåŠ¨æ›´æ–°å¥½æ„Ÿåº¦ (+/-15ä»¥å†…)         â”‚
â”‚ 4. æä¾›ç­‰çº§æ ‡ç­¾ (é™Œç”Ÿâ†’æŒšå‹)          â”‚
â”‚ 5. ç”Ÿæˆé£æ ¼ä¿®é¥°è¯ (å½±å“å¯¹è¯)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”çº§å¥½æ„Ÿåº¦ä½“ç³»

### ç­‰çº§å®šä¹‰ (get_affinity_level, 266-284è¡Œ)

```python
def get_affinity_level(self, affinity: float) -> str:
    if affinity >= 80:
        return "æŒšå‹"      # 80-100åˆ†
    elif affinity >= 60:
        return "äº²å¯†"      # 60-79åˆ†
    elif affinity >= 40:
        return "å‹å¥½"      # 40-59åˆ†
    elif affinity >= 20:
        return "ç†Ÿæ‚‰"      # 20-39åˆ†
    else:
        return "é™Œç”Ÿ"      # 0-19åˆ†
```

### åˆ†æ•°åŒºé—´å›¾

```
0â”€â”€â”€â”€â”€â”€â”€â”€â”€20â”€â”€â”€â”€â”€â”€â”€â”€â”€40â”€â”€â”€â”€â”€â”€â”€â”€â”€60â”€â”€â”€â”€â”€â”€â”€â”€â”€80â”€â”€â”€â”€â”€â”€â”€â”€â”€100
â”‚         â”‚          â”‚          â”‚          â”‚           â”‚
é™Œç”Ÿ      ç†Ÿæ‚‰       å‹å¥½       äº²å¯†       æŒšå‹        å®Œç¾
                          â†‘
                       åˆå§‹å€¼=50
```

### ç­‰çº§è¯¦è§£

#### ğŸ¥¶ ç­‰çº§0: é™Œç”Ÿ (0-19åˆ†)

**ç‰¹å¾**:
- å†·æ·¡ç–ç¦»ï¼Œä¸å¤ªæ„¿æ„å¤šè¯´
- å›ç­”ç®€çŸ­ï¼Œä¿æŒè·ç¦»
- ä¸ä¼šä¸»åŠ¨åˆ†äº«ä¿¡æ¯

**å¯¹è¯ç¤ºä¾‹**:
```
ç©å®¶: "ä½ å¥½ï¼Œèƒ½èŠèŠå—?"
NPC (é™Œç”Ÿ): "å—¯ã€‚" (ç®€çŸ­å›å¤)

ç©å®¶: "ä½ åœ¨åšä»€ä¹ˆ?"
NPC (é™Œç”Ÿ): "å·¥ä½œã€‚" (æ•·è¡)
```

**å¦‚ä½•æå‡**:
- å‹å¥½é—®å€™ (+1~+3)
- è¯·æ•™é—®é¢˜ (+3~+6)
- èµç¾å·¥ä½œ (+5~+8)

---

#### ğŸ˜ ç­‰çº§1: ç†Ÿæ‚‰ (20-39åˆ†)

**ç‰¹å¾**:
- ç¤¼è²Œä½†ç•¥æ˜¾ç”Ÿç–
- å›ç­”ç®€æ´ï¼Œä¿æŒä¸“ä¸š
- ä¸å¤ªæ·±å…¥äº¤æµ

**å¯¹è¯ç¤ºä¾‹**:
```
ç©å®¶: "ä½ å¥½ï¼Œæœ€è¿‘åœ¨åšä»€ä¹ˆ?"
NPC (ç†Ÿæ‚‰): "ä½ å¥½ï¼Œæœ€è¿‘åœ¨åšä¸€ä¸ªé¡¹ç›®ã€‚" (ç¤¼è²Œä½†ç®€çŸ­)

ç©å®¶: "èƒ½è¯´è¯´å…·ä½“æ˜¯ä»€ä¹ˆå—?"
NPC (ç†Ÿæ‚‰): "æ˜¯ä¸ªå¤šæ™ºèƒ½ä½“ç³»ç»Ÿã€‚" (åŸºæœ¬å›ç­”)
```

**é£æ ¼ä¿®é¥°è¯** (302è¡Œ):
```python
"ç¤¼è²Œä½†ç•¥æ˜¾ç”Ÿç–,å›ç­”ç®€æ´"
```

---

#### ğŸ˜Š ç­‰çº§2: å‹å¥½ (40-59åˆ†) - åˆå§‹ç­‰çº§

**ç‰¹å¾**:
- ç¤¼è²Œå‹å–„ï¼Œæ­£å¸¸äº¤æµ
- ä¿æŒä¸“ä¸šï¼Œé€‚åº¦åˆ†äº«
- æ„¿æ„å›ç­”é—®é¢˜

**å¯¹è¯ç¤ºä¾‹**:
```
ç©å®¶: "ä½ å¥½ï¼Œæœ€è¿‘åœ¨åšä»€ä¹ˆ?"
NPC (å‹å¥½): "ä½ å¥½ï¼æœ€è¿‘åœ¨åšä¸€ä¸ªå¤šæ™ºèƒ½ä½“ç³»ç»Ÿé¡¹ç›®ï¼Œç”¨HelloAgentsæ¡†æ¶ï¼ŒæŒºæœ‰æ„æ€çš„ã€‚"

ç©å®¶: "èƒ½è¯¦ç»†è®²è®²å—?"
NPC (å‹å¥½): "å½“ç„¶ï¼Œè¿™ä¸ªæ¡†æ¶ä¸»è¦ç”¨äº..."
```

**é£æ ¼ä¿®é¥°è¯** (300è¡Œ):
```python
"ç¤¼è²Œå‹å–„,æ­£å¸¸äº¤æµ,ä¿æŒä¸“ä¸š"
```

**åˆå§‹å€¼**: æ‰€æœ‰NPCåˆå§‹å¥½æ„Ÿåº¦ = 50ï¼ˆå‹å¥½ç­‰çº§ï¼‰

---

#### ğŸ’– ç­‰çº§3: äº²å¯† (60-79åˆ†)

**ç‰¹å¾**:
- å‹å¥½çƒ­æƒ…ï¼Œæ„¿æ„å¤šèŠ
- ä¸»åŠ¨å…³å¿ƒå¯¹æ–¹
- ä¼šåˆ†äº«æ›´å¤šç»†èŠ‚

**å¯¹è¯ç¤ºä¾‹**:
```
ç©å®¶: "ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·?"
NPC (äº²å¯†): "å˜¿ï¼æœ€è¿‘æŒºå¥½çš„ï¼åˆšå®Œæˆä¸€ä¸ªæŒ‘æˆ˜æ€§çš„åŠŸèƒ½ï¼Œæœ‰ç‚¹ç´¯ä½†å¾ˆæœ‰æˆå°±æ„Ÿã€‚ä½ å‘¢ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ"

ç©å®¶: "æˆ‘ä¹Ÿåœ¨å­¦ä¹ ç¼–ç¨‹"
NPC (äº²å¯†): "å¤ªå¥½äº†ï¼æœ‰ä»€ä¹ˆä¸æ‡‚çš„éšæ—¶é—®æˆ‘ï¼Œæˆ‘å¾ˆä¹æ„å¸®å¿™ï¼"
```

**é£æ ¼ä¿®é¥°è¯** (298è¡Œ):
```python
"å‹å¥½çƒ­æƒ…,æ„¿æ„å¤šèŠ,ä¼šä¸»åŠ¨å…³å¿ƒå¯¹æ–¹"
```

---

#### ğŸŒŸ ç­‰çº§4: æŒšå‹ (80-100åˆ†)

**ç‰¹å¾**:
- éå¸¸çƒ­æƒ…å‹å¥½
- åƒè€æœ‹å‹ä¸€æ ·äº²åˆ‡
- æ„¿æ„åˆ†äº«ç§äººè¯é¢˜

**å¯¹è¯ç¤ºä¾‹**:
```
ç©å®¶: "å˜¿ï¼Œæœ€è¿‘æ€ä¹ˆæ ·?"
NPC (æŒšå‹): "å“å‘€ï¼Œå¤ªå¥½äº†è§åˆ°ä½ ï¼æœ€è¿‘å‹åŠ›æŒºå¤§çš„ï¼Œä¸è¿‡æœ‰ä½ åœ¨çœŸå¥½ã€‚å¯¹äº†ï¼Œä¸Šæ¬¡è¯´çš„é‚£ä¸ªé—®é¢˜æˆ‘æƒ³åˆ°è§£å†³æ–¹æ¡ˆäº†ï¼"

ç©å®¶: "çœŸçš„å—ï¼Ÿå¤ªå¥½äº†ï¼"
NPC (æŒšå‹): "å—¯ï¼æˆ‘ç ”ç©¶äº†ä¸€æ•´æ™šï¼Œç»ˆäºæå®šäº†ã€‚å…¶å®æˆ‘æœ‰æ—¶å€™ä¹Ÿä¼šæ€€ç–‘è‡ªå·±ï¼Œä½†æƒ³åˆ°ä½ çš„é¼“åŠ±å°±æœ‰åŠ¨åŠ›äº†ã€‚"
```

**é£æ ¼ä¿®é¥°è¯** (296è¡Œ):
```python
"éå¸¸çƒ­æƒ…å‹å¥½,åƒè€æœ‹å‹ä¸€æ ·äº²åˆ‡,æ„¿æ„åˆ†äº«ç§äººè¯é¢˜"
```

---

## æ ¸å¿ƒç±»è¯¦è§£

### RelationshipManager ç±»

#### 1. åˆå§‹åŒ– (__init__, 24-43è¡Œ)

```python
def __init__(self, llm: HelloAgentsLLM):
    self.llm = llm
    
    # â­ å­˜å‚¨ç»“æ„: {npc_name: {player_id: affinity_score}}
    self.affinity_scores: Dict[str, Dict[str, float]] = {}
    
    # â­ åˆ›å»ºæƒ…æ„Ÿåˆ†æAgent
    self.analyzer_agent = SimpleAgent(
        name="AffinityAnalyzer",
        llm=llm,
        system_prompt=self._create_analyzer_prompt()
    )
```

**æ•°æ®ç»“æ„ç¤ºä¾‹**:
```python
affinity_scores = {
    "å¼ ä¸‰": {
        "player": 65.0,      # é»˜è®¤ç©å®¶
        "player2": 45.0      # ç¬¬äºŒä¸ªç©å®¶
    },
    "æå››": {
        "player": 50.0
    },
    "ç‹äº”": {
        "player": 70.0
    }
}
```

**æ”¯æŒå¤šç©å®¶**:
- æ¯ä¸ªNPCå¯ä»¥å¯¹ä¸åŒç©å®¶æœ‰ä¸åŒå¥½æ„Ÿåº¦
- ç©å®¶IDé»˜è®¤ä¸º "player"
- å¯æ‰©å±•ä¸ºåœ¨çº¿å¤šäººæ¸¸æˆ

---

#### 2. æƒ…æ„Ÿåˆ†ææç¤ºè¯ (_create_analyzer_prompt, 45-103è¡Œ)

è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼å®šä¹‰äº†å¦‚ä½•åˆ†æå¯¹è¯ã€‚

```python
def _create_analyzer_prompt(self) -> str:
    return """ä½ æ˜¯ä¸€ä¸ªæƒ…æ„Ÿåˆ†æä¸“å®¶...
    
    ã€åˆ†æç»´åº¦ã€‘
    1. **ç©å®¶æ€åº¦**: å‹å¥½/ä¸­ç«‹/ä¸å‹å¥½
    2. **å¯¹è¯å†…å®¹**: ç§¯æ/ä¸­ç«‹/æ¶ˆæ
    3. **äº’åŠ¨è´¨é‡**: æ·±å…¥/ä¸€èˆ¬/æ•·è¡
    4. **æƒ…æ„Ÿå€¾å‘**: èµç¾/æ‰¹è¯„/ä¸­æ€§
    
    ã€å¥½æ„Ÿåº¦å˜åŒ–è§„åˆ™ã€‘
    - èµç¾ã€æ„Ÿè°¢ã€è¯·æ•™: +3 åˆ° +8
    - å‹å¥½é—®å€™ã€æ­£å¸¸äº¤æµ: +1 åˆ° +3
    - æ™®é€šé—²èŠã€ä¸­æ€§è¯é¢˜: 0
    - æ‰¹è¯„ã€è´¨ç–‘ã€ä¸è€çƒ¦: -3 åˆ° -8
    - ä¾®è¾±ã€æ”»å‡»ã€æ¶æ„: -8 åˆ° -15
    
    ã€è¾“å‡ºæ ¼å¼ã€‘
    {
        "should_change": true/false,
        "change_amount": -15åˆ°+10ä¹‹é—´çš„æ•´æ•°,
        "reason": "ç®€çŸ­è¯´æ˜åŸå› (10å­—ä»¥å†…)",
        "sentiment": "positive/neutral/negative"
    }
    """
```

**å››ä¸ªåˆ†æç»´åº¦**:

```
å¯¹è¯åˆ†æ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç©å®¶æ€åº¦      â”‚ â†’ å‹å¥½ / ä¸­ç«‹ / ä¸å‹å¥½
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. å¯¹è¯å†…å®¹      â”‚ â†’ ç§¯æ / ä¸­ç«‹ / æ¶ˆæ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. äº’åŠ¨è´¨é‡      â”‚ â†’ æ·±å…¥ / ä¸€èˆ¬ / æ•·è¡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. æƒ…æ„Ÿå€¾å‘      â”‚ â†’ èµç¾ / æ‰¹è¯„ / ä¸­æ€§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç»¼åˆåˆ¤æ–­å¥½æ„Ÿåº¦å˜åŒ–é‡
```

**å˜åŒ–è§„åˆ™è®¾è®¡**:

| è¡Œä¸ºç±»å‹ | å˜åŒ–èŒƒå›´ | ç¤ºä¾‹ |
|---------|---------|------|
| èµç¾/æ„Ÿè°¢/è¯·æ•™ | +3 ~ +8 | "ä½ çš„ä»£ç å†™å¾—çœŸæ£’!" |
| å‹å¥½é—®å€™ | +1 ~ +3 | "ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ !" |
| æ™®é€šé—²èŠ | 0 | "ä»Šå¤©å¤©æ°”ä¸é”™" |
| æ‰¹è¯„/è´¨ç–‘ | -3 ~ -8 | "ä½ è¿™ä¸ªè®¾è®¡ä¸è¡Œ" |
| ä¾®è¾±/æ”»å‡» | -8 ~ -15 | "ä½ å¤ªç¬¨äº†" |

**ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªèŒƒå›´ï¼Ÿ**
- âœ… **æ¸è¿›å¼** - é¿å…å¥½æ„Ÿåº¦çªå˜
- âœ… **å¹³è¡¡æ€§** - è´Ÿé¢å½±å“ç¨å¤§ï¼ˆæ›´çœŸå®ï¼‰
- âœ… **å¯æ¢å¤** - å•æ¬¡å¤±è¯¯ä¸ä¼šæ¯æ‰å…³ç³»
- âœ… **æœ‰ä¸Šé™** - é˜²æ­¢åˆ·å¥½æ„Ÿåº¦

---

#### 3. è·å–å¥½æ„Ÿåº¦ (get_affinity, 105-121è¡Œ)

```python
def get_affinity(self, npc_name: str, player_id: str = "player") -> float:
    """è·å–å¥½æ„Ÿåº¦ï¼Œä¸å­˜åœ¨åˆ™åˆå§‹åŒ–ä¸º50"""
    if npc_name not in self.affinity_scores:
        self.affinity_scores[npc_name] = {}
    
    if player_id not in self.affinity_scores[npc_name]:
        self.affinity_scores[npc_name][player_id] = 50.0  # â­ åˆå§‹å€¼50
    
    return self.affinity_scores[npc_name][player_id]
```

**æ‡’åŠ è½½è®¾è®¡**:
- ä¸é¢„å…ˆåˆå§‹åŒ–æ‰€æœ‰NPC
- ç¬¬ä¸€æ¬¡è®¿é—®æ—¶è‡ªåŠ¨åˆ›å»º
- åˆå§‹å¥½æ„Ÿåº¦ = 50ï¼ˆå‹å¥½ç­‰çº§ï¼‰

**ä¸ºä»€ä¹ˆåˆå§‹å€¼æ˜¯50ï¼Ÿ**
- âœ… ä½äº"å‹å¥½"ç­‰çº§ï¼ˆ40-59ï¼‰
- âœ… ç»™ç©å®¶æå‡å’Œé™ä½çš„ç©ºé—´
- âœ… ç¬¦åˆ"åˆæ¬¡è§é¢ï¼Œç¤¼è²Œå‹å–„"çš„è®¾å®š

---

#### 4. åˆ†æå¹¶æ›´æ–°å¥½æ„Ÿåº¦ (analyze_and_update_affinity, 138-213è¡Œ) â­â­â­

**è¿™æ˜¯æœ€é‡è¦çš„æ–¹æ³•ï¼**å®Œæ•´çš„æƒ…æ„Ÿåˆ†æå’Œå¥½æ„Ÿåº¦æ›´æ–°æµç¨‹ã€‚

```python
def analyze_and_update_affinity(
    self,
    npc_name: str,
    player_message: str,
    npc_response: str,
    player_id: str = "player"
) -> Dict:
    """åˆ†æå¯¹è¯å¹¶æ›´æ–°å¥½æ„Ÿåº¦"""
```

**å®Œæ•´æµç¨‹ï¼ˆ6æ­¥ï¼‰**:

```
æ­¥éª¤1: æ„å»ºåˆ†ææç¤º (157-163è¡Œ)
    â†“
prompt = """è¯·åˆ†æä»¥ä¸‹å¯¹è¯:

ç©å®¶: {player_message}
{npc_name}: {npc_response}

è¯·åˆ¤æ–­æ˜¯å¦åº”è¯¥æ”¹å˜å¥½æ„Ÿåº¦,å¹¶ç»™å‡ºå˜åŒ–é‡ã€‚
"""
    â†“
æ­¥éª¤2: è°ƒç”¨æƒ…æ„Ÿåˆ†æAgent (167è¡Œ)
    â†“
response = self.analyzer_agent.run(prompt)
    â†“
LLMåˆ†æå¯¹è¯ï¼Œç”ŸæˆJSON:
{
    "should_change": true,
    "change_amount": 5,
    "reason": "å‹å¥½é—®å€™",
    "sentiment": "positive"
}
    â†“
æ­¥éª¤3: è§£æJSONå“åº” (170è¡Œ)
    â†“
analysis = self._parse_analysis(response)
    â†“
æ­¥éª¤4: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–° (172è¡Œ)
    â†“
if analysis["should_change"]:
    â”œâ”€â†’ è·å–å½“å‰å¥½æ„Ÿåº¦
    â”œâ”€â†’ è®¡ç®—æ–°å¥½æ„Ÿåº¦
    â”œâ”€â†’ é™åˆ¶åœ¨0-100èŒƒå›´
    â”œâ”€â†’ ä¿å­˜æ–°å¥½æ„Ÿåº¦
    â””â”€â†’ è®¡ç®—ç­‰çº§å˜åŒ–
    â†“
æ­¥éª¤5: è¿”å›è¯¦ç»†ç»“æœ (186-202è¡Œ)
    â†“
è¿”å›:
{
    "changed": True,
    "old_affinity": 50.0,
    "new_affinity": 55.0,
    "change_amount": 5,
    "reason": "å‹å¥½é—®å€™",
    "sentiment": "positive",
    "old_level": "å‹å¥½",
    "new_level": "å‹å¥½"
}
```

**å…³é”®ä»£ç æ®µ**:

```python
# æ­¥éª¤4: æ›´æ–°å¥½æ„Ÿåº¦
if analysis["should_change"]:
    # è·å–å½“å‰å¥½æ„Ÿåº¦
    current_affinity = self.get_affinity(npc_name, player_id)
    
    # è®¡ç®—æ–°å¥½æ„Ÿåº¦
    new_affinity = current_affinity + analysis["change_amount"]
    
    # â­ é™åˆ¶åœ¨0-100èŒƒå›´å†…
    new_affinity = max(0.0, min(100.0, new_affinity))
    
    # ä¿å­˜
    self.set_affinity(npc_name, new_affinity, player_id)
    
    # è®¡ç®—ç­‰çº§å˜åŒ–
    old_level = self.get_affinity_level(current_affinity)
    new_level = self.get_affinity_level(new_affinity)
    
    return {
        "changed": True,
        "old_affinity": current_affinity,
        "new_affinity": new_affinity,
        "change_amount": analysis["change_amount"],
        "reason": analysis["reason"],
        "sentiment": analysis["sentiment"],
        "old_level": old_level,
        "new_level": new_level
    }
```

---

#### 5. JSONè§£æ (_parse_analysis, 215-264è¡Œ)

å¤„ç†LLMå¯èƒ½è¿”å›çš„å„ç§æ ¼å¼ã€‚

```python
def _parse_analysis(self, response: str) -> Dict:
    """è§£æåˆ†æç»“æœï¼Œæ”¯æŒå¤šç§æ ¼å¼"""
```

**ä¸‰å±‚è§£æç­–ç•¥**:

```
ç­–ç•¥1: ç›´æ¥è§£æJSON (226è¡Œ)
    â†“
try:
    analysis = json.loads(response)
    return analysis
except:
    â†“ (å¤±è´¥)

ç­–ç•¥2: æå–JSONéƒ¨åˆ† (230-240è¡Œ)
    â†“
æŸ¥æ‰¾ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª }
æå–ä¸­é—´çš„JSONå­—ç¬¦ä¸²
    â†“
try:
    json_str = response[start:end]
    analysis = json.loads(json_str)
    return analysis
except:
    â†“ (å¤±è´¥)

ç­–ç•¥3: æ­£åˆ™è¡¨è¾¾å¼æå– (243-255è¡Œ)
    â†“
ä½¿ç”¨æ­£åˆ™åŒ¹é…å…³é”®å­—æ®µ:
- "should_change": true/false
- "change_amount": -?\d+
- "reason": "..."
- "sentiment": "..."
    â†“
æ„å»ºå­—å…¸è¿”å›
    â†“ (å¦‚æœè¿˜å¤±è´¥)

è¿”å›é»˜è®¤å€¼ (259-263è¡Œ)
    â†“
{
    "should_change": False,
    "change_amount": 0,
    "reason": "è§£æå¤±è´¥",
    "sentiment": "neutral"
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚è§£æï¼Ÿ**
- LLMå¯èƒ½è¿”å›ä¸è§„èŒƒçš„JSON
- å¯èƒ½åŒ…å«è§£é‡Šæ€§æ–‡å­—
- ç¡®ä¿ç³»ç»Ÿå¥å£®æ€§

**ç¤ºä¾‹è¾“å…¥**:

```python
# æƒ…å†µ1: æ ‡å‡†JSONï¼ˆæœ€ç†æƒ³ï¼‰
response = '{"should_change": true, "change_amount": 5, "reason": "å‹å¥½é—®å€™", "sentiment": "positive"}'
â†’ ç­–ç•¥1æˆåŠŸ

# æƒ…å†µ2: åŒ…å«é¢å¤–æ–‡å­—
response = 'åˆ†æç»“æœå¦‚ä¸‹: {"should_change": true, "change_amount": 5, "reason": "å‹å¥½é—®å€™", "sentiment": "positive"}'
â†’ ç­–ç•¥2æˆåŠŸï¼ˆæå–{}ä¹‹é—´çš„å†…å®¹ï¼‰

# æƒ…å†µ3: æ ¼å¼ä¸è§„èŒƒ
response = 'should_changeæ˜¯trueï¼Œchange_amountæ˜¯5ï¼Œreasonæ˜¯"å‹å¥½é—®å€™"'
â†’ ç­–ç•¥3æˆåŠŸï¼ˆæ­£åˆ™æå–ï¼‰

# æƒ…å†µ4: å®Œå…¨è§£æå¤±è´¥
response = 'æˆ‘è§‰å¾—åº”è¯¥åŠ 5åˆ†'
â†’ è¿”å›é»˜è®¤å€¼
```

---

## æƒ…æ„Ÿåˆ†ææœºåˆ¶

### LLMé©±åŠ¨çš„æƒ…æ„Ÿåˆ†æ

```
å¯¹è¯è¾“å…¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æƒ…æ„Ÿåˆ†æAgent (analyzer_agent)   â”‚
â”‚   ä½¿ç”¨LLMæ™ºèƒ½åˆ†æ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥:                             â”‚
â”‚   - ç©å®¶æ¶ˆæ¯                       â”‚
â”‚   - NPCå›å¤                        â”‚
â”‚                                   â”‚
â”‚ åˆ†æ:                             â”‚
â”‚   - ç©å®¶æ€åº¦ (å‹å¥½/ä¸­ç«‹/ä¸å‹å¥½)     â”‚
â”‚   - å¯¹è¯å†…å®¹ (ç§¯æ/ä¸­ç«‹/æ¶ˆæ)       â”‚
â”‚   - äº’åŠ¨è´¨é‡ (æ·±å…¥/ä¸€èˆ¬/æ•·è¡)       â”‚
â”‚   - æƒ…æ„Ÿå€¾å‘ (èµç¾/æ‰¹è¯„/ä¸­æ€§)       â”‚
â”‚                                   â”‚
â”‚ è¾“å‡º:                             â”‚
â”‚   {                               â”‚
â”‚     "should_change": bool,        â”‚
â”‚     "change_amount": int,         â”‚
â”‚     "reason": str,                â”‚
â”‚     "sentiment": str              â”‚
â”‚   }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ›´æ–°å¥½æ„Ÿåº¦
```

### åˆ†æç¤ºä¾‹

#### ç¤ºä¾‹1: èµç¾å·¥ä½œ (+8)

**è¾“å…¥**:
```
ç©å®¶: "ä½ çš„ä»£ç å†™å¾—çœŸæ£’!"
å¼ ä¸‰: "è°¢è°¢!æˆ‘æœ€è¿‘åœ¨ç ”ç©¶æ–°æŠ€æœ¯ã€‚"
```

**åˆ†æè¿‡ç¨‹**:
```
1. ç©å®¶æ€åº¦: å‹å¥½ï¼ˆèµç¾ï¼‰
2. å¯¹è¯å†…å®¹: ç§¯æï¼ˆå¤¸å¥–ï¼‰
3. äº’åŠ¨è´¨é‡: æ·±å…¥ï¼ˆè®¤å¯ä¸“ä¸šèƒ½åŠ›ï¼‰
4. æƒ…æ„Ÿå€¾å‘: èµç¾
```

**è¾“å‡º**:
```json
{
    "should_change": true,
    "change_amount": 8,
    "reason": "èµç¾å·¥ä½œ",
    "sentiment": "positive"
}
```

**å¥½æ„Ÿåº¦å˜åŒ–**:
```
50 â†’ 58 (+8)
ç­‰çº§: å‹å¥½ â†’ äº²å¯†
```

---

#### ç¤ºä¾‹2: å‹å¥½é—®å€™ (+5)

**è¾“å…¥**:
```
ç©å®¶: "ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ !"
æå››: "ä½ å¥½!æˆ‘ä¹Ÿå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"
```

**åˆ†æè¿‡ç¨‹**:
```
1. ç©å®¶æ€åº¦: å‹å¥½
2. å¯¹è¯å†…å®¹: ç§¯æ
3. äº’åŠ¨è´¨é‡: ä¸€èˆ¬ï¼ˆåˆæ¬¡è§é¢ï¼‰
4. æƒ…æ„Ÿå€¾å‘: ä¸­æ€§ï¼ˆç¤¼è²Œï¼‰
```

**è¾“å‡º**:
```json
{
    "should_change": true,
    "change_amount": 5,
    "reason": "å‹å¥½é—®å€™",
    "sentiment": "positive"
}
```

---

#### ç¤ºä¾‹3: æ™®é€šé—²èŠ (0)

**è¾“å…¥**:
```
ç©å®¶: "ä»Šå¤©å¤©æ°”ä¸é”™"
ç‹äº”: "æ˜¯å•Šï¼ŒæŒºå¥½çš„ã€‚"
```

**åˆ†æè¿‡ç¨‹**:
```
1. ç©å®¶æ€åº¦: ä¸­ç«‹
2. å¯¹è¯å†…å®¹: ä¸­ç«‹
3. äº’åŠ¨è´¨é‡: æ•·è¡ï¼ˆå¤©æ°”è¯é¢˜ï¼‰
4. æƒ…æ„Ÿå€¾å‘: ä¸­æ€§
```

**è¾“å‡º**:
```json
{
    "should_change": false,
    "change_amount": 0,
    "reason": "æ™®é€šé—²èŠ",
    "sentiment": "neutral"
}
```

---

#### ç¤ºä¾‹4: æ‰¹è¯„å·¥ä½œ (-8)

**è¾“å…¥**:
```
ç©å®¶: "ä½ è¿™ä¸ªè®¾è®¡å¤ªä¸‘äº†!"
ç‹äº”: "æŠ±æ­‰ï¼Œæˆ‘ä¼šæ”¹è¿›çš„..."
```

**åˆ†æè¿‡ç¨‹**:
```
1. ç©å®¶æ€åº¦: ä¸å‹å¥½ï¼ˆæ‰¹è¯„ï¼‰
2. å¯¹è¯å†…å®¹: æ¶ˆæï¼ˆè´Ÿé¢è¯„ä»·ï¼‰
3. äº’åŠ¨è´¨é‡: æ·±å…¥ï¼ˆæ¶‰åŠæ ¸å¿ƒå·¥ä½œï¼‰
4. æƒ…æ„Ÿå€¾å‘: æ‰¹è¯„
```

**è¾“å‡º**:
```json
{
    "should_change": true,
    "change_amount": -8,
    "reason": "æ‰¹è¯„å·¥ä½œ",
    "sentiment": "negative"
}
```

**å¥½æ„Ÿåº¦å˜åŒ–**:
```
50 â†’ 42 (-8)
ç­‰çº§: å‹å¥½ â†’ å‹å¥½ï¼ˆä»åœ¨åŒä¸€ç­‰çº§ï¼‰
```

---

## è®¾è®¡äº®ç‚¹

### 1. LLMé©±åŠ¨çš„æ™ºèƒ½åˆ†æ â­â­â­â­â­

**ä¼ ç»Ÿæ–¹å¼**ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰:
```python
if "æ£’" in message or "å¥½" in message:
    change = +5
elif "çƒ‚" in message or "å·®" in message:
    change = -5
```

**é—®é¢˜**:
- âŒ æ— æ³•ç†è§£ä¸Šä¸‹æ–‡
- âŒ å®¹æ˜“è¯¯åˆ¤ï¼ˆ"ä¸å¥½"è¢«åˆ¤ä¸ºæ­£é¢ï¼‰
- âŒ ç»´æŠ¤å›°éš¾ï¼ˆéœ€è¦ç»´æŠ¤å¤§é‡å…³é”®è¯ï¼‰

**LLMæ–¹å¼**ï¼ˆæœ¬ç³»ç»Ÿï¼‰:
```python
analysis = analyzer_agent.run(prompt)
```

**ä¼˜åŠ¿**:
- âœ… ç†è§£ä¸Šä¸‹æ–‡å’Œè¯­ä¹‰
- âœ… å‡†ç¡®åˆ¤æ–­çœŸå®æƒ…æ„Ÿ
- âœ… æ— éœ€ç»´æŠ¤è§„åˆ™åº“
- âœ… è‡ªç„¶è¯­è¨€è§£é‡ŠåŸå› 

---

### 2. å¤šç»´åº¦åˆ†æ â­â­â­â­â­

ä¸æ˜¯ç®€å•çš„"æ­£é¢/è´Ÿé¢"äºŒåˆ†æ³•ï¼Œè€Œæ˜¯å››ä¸ªç»´åº¦ç»¼åˆåˆ†æ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç©å®¶æ€åº¦    â”‚ â†’ ä¸»è§‚è¯„ä»·ï¼ˆå‹å¥½/ä¸­ç«‹/ä¸å‹å¥½ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹è¯å†…å®¹    â”‚ â†’ å®¢è§‚å†…å®¹ï¼ˆç§¯æ/ä¸­ç«‹/æ¶ˆæï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº’åŠ¨è´¨é‡    â”‚ â†’ äº¤æµæ·±åº¦ï¼ˆæ·±å…¥/ä¸€èˆ¬/æ•·è¡ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æƒ…æ„Ÿå€¾å‘    â”‚ â†’ å…·ä½“è¡Œä¸ºï¼ˆèµç¾/æ‰¹è¯„/ä¸­æ€§ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    ç»¼åˆåˆ¤æ–­å˜åŒ–é‡
```

**ç¤ºä¾‹**:
```
å¯¹è¯: "ä½ å¥½" + "ä½ å¥½ï¼"
â†’ æ€åº¦å‹å¥½(+) + å†…å®¹ä¸­ç«‹(0) + è´¨é‡ä¸€èˆ¬(0) + å€¾å‘ä¸­æ€§(0)
â†’ ç»¼åˆ: +2

å¯¹è¯: "ä½ çš„ä»£ç çœŸæ£’" + "è°¢è°¢ï¼"
â†’ æ€åº¦å‹å¥½(+) + å†…å®¹ç§¯æ(++) + è´¨é‡æ·±å…¥(+) + å€¾å‘èµç¾(++)
â†’ ç»¼åˆ: +8
```

---

### 3. å¹³æ»‘çš„ç­‰çº§è¿‡æ¸¡ â­â­â­â­

```
ç­‰çº§è®¾è®¡:
0â”€â”€â”€â”€20â”€â”€â”€â”€40â”€â”€â”€â”€50(åˆå§‹)â”€â”€â”€â”€60â”€â”€â”€â”€80â”€â”€â”€â”€100
é™Œç”Ÿ   ç†Ÿæ‚‰   å‹å¥½           äº²å¯†    æŒšå‹
```

**ç‰¹ç‚¹**:
- âœ… **éçº¿æ€§åˆ†å¸ƒ** - å‹å¥½åŒºé—´æœ€å¤§ï¼ˆç¬¦åˆç°å®ï¼‰
- âœ… **åˆå§‹å€¼å±…ä¸­** - 50åˆ†ï¼ˆç»™ä¸Šå‡å’Œä¸‹é™ç©ºé—´ï¼‰
- âœ… **ç­‰çº§è·¨åº¦å¹³è¡¡** - æ¯çº§20åˆ†ï¼ˆå®¹æ˜“æ„ŸçŸ¥å˜åŒ–ï¼‰

**å‡çº§éš¾åº¦**:
```
ç†Ÿæ‚‰ â†’ å‹å¥½: éœ€è¦ +10~+20 (å®¹æ˜“)
å‹å¥½ â†’ äº²å¯†: éœ€è¦ +10~+20 (å®¹æ˜“)
äº²å¯† â†’ æŒšå‹: éœ€è¦ +20~+40 (è¾ƒéš¾)
```

**ä¸ºä»€ä¹ˆæŒšå‹æœ€éš¾ï¼Ÿ**
- æ¨¡æ‹Ÿç°å®ï¼šæˆä¸ºæŒšå‹éœ€è¦é•¿æœŸäº’åŠ¨
- æ¸¸æˆæ€§ï¼šç»™ç©å®¶é•¿æœŸç›®æ ‡
- ç¨€ç¼ºæ€§ï¼šè®©æŒšå‹å…³ç³»æ›´æœ‰ä»·å€¼

---

### 4. ä¸‰å±‚å®¹é”™è§£æ â­â­â­â­

```python
ç­–ç•¥1: json.loads()          â†’ æ ‡å‡†JSON
ç­–ç•¥2: æå–{}ä¹‹é—´çš„å†…å®¹      â†’ åŒ…å«é¢å¤–æ–‡å­—
ç­–ç•¥3: æ­£åˆ™è¡¨è¾¾å¼æå–        â†’ æ ¼å¼ä¸è§„èŒƒ
é»˜è®¤å€¼: è¿”å›ä¸­æ€§ç»“æœ         â†’ å®Œå…¨å¤±è´¥
```

**å¥å£®æ€§ä¿è¯**:
- âœ… LLMè¾“å‡ºä¸è§„èŒƒä¹Ÿèƒ½å¤„ç†
- âœ… ç³»ç»Ÿä¸ä¼šå´©æºƒ
- âœ… å¤±è´¥æ—¶ä¿å®ˆå¤„ç†ï¼ˆä¸å˜åŒ–ï¼‰

---

### 5. åŒå‘åé¦ˆæœºåˆ¶ â­â­â­â­â­

```
å¥½æ„Ÿåº¦ â†’ å½±å“å¯¹è¯é£æ ¼ â†’ å½±å“ç©å®¶ä½“éªŒ â†’ å½±å“å¥½æ„Ÿåº¦
   â†‘                                        â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 é—­ç¯åé¦ˆ
```

**æ­£å‘å¾ªç¯**:
```
ç©å®¶å‹å¥½ â†’ å¥½æ„Ÿåº¦â†‘ â†’ NPCæ›´çƒ­æƒ… â†’ ç©å®¶æ›´å–œæ¬¢ â†’ æ›´å¤šå‹å¥½äº’åŠ¨
```

**è´Ÿå‘å¾ªç¯**:
```
ç©å®¶å†’çŠ¯ â†’ å¥½æ„Ÿåº¦â†“ â†’ NPCå†·æ·¡ â†’ ç©å®¶ä½“éªŒå·® â†’ å¯èƒ½æ”¹å–„æˆ–æ”¾å¼ƒ
```

---

## å®è·µæ¡ˆä¾‹

### æ¡ˆä¾‹1: ä»é™Œç”Ÿåˆ°æŒšå‹çš„å®Œæ•´æ—…ç¨‹

**åˆå§‹çŠ¶æ€**: å¥½æ„Ÿåº¦ = 50ï¼ˆå‹å¥½ï¼‰

**ç¬¬1æ¬¡å¯¹è¯**: å‹å¥½é—®å€™
```
ç©å®¶: "ä½ å¥½ï¼Œæˆ‘æ˜¯æ–°æ¥çš„ï¼Œè¯·å¤šæŒ‡æ•™!"
å¼ ä¸‰: "ä½ å¥½!æˆ‘æ˜¯å¼ ä¸‰ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"
â†’ åˆ†æ: å‹å¥½é—®å€™ (+5)
â†’ å¥½æ„Ÿåº¦: 50 â†’ 55
```

**ç¬¬2æ¬¡å¯¹è¯**: è¯·æ•™é—®é¢˜
```
ç©å®¶: "èƒ½æ•™æˆ‘Pythonå—?"
å¼ ä¸‰: "å½“ç„¶å¯ä»¥!æˆ‘å¾ˆä¹æ„åˆ†äº«ç»éªŒã€‚"
â†’ åˆ†æ: è¯·æ•™å­¦ä¹  (+6)
â†’ å¥½æ„Ÿåº¦: 55 â†’ 61 (ç­‰çº§æå‡: å‹å¥½ â†’ äº²å¯†)
```

**ç¬¬3æ¬¡å¯¹è¯**: èµç¾å·¥ä½œ
```
ç©å®¶: "ä½ çš„ä»£ç å†™å¾—çœŸæ£’ï¼Œé€»è¾‘å¾ˆæ¸…æ™°!"
å¼ ä¸‰: "è°¢è°¢!æˆ‘å¾ˆæ³¨é‡ä»£ç å¯è¯»æ€§ã€‚"
â†’ åˆ†æ: èµç¾å·¥ä½œ (+8)
â†’ å¥½æ„Ÿåº¦: 61 â†’ 69 (ä¿æŒäº²å¯†)
```

**ç¬¬4æ¬¡å¯¹è¯**: æ·±å…¥äº¤æµ
```
ç©å®¶: "æˆ‘ä¹Ÿé‡åˆ°è¿‡ç±»ä¼¼çš„bugï¼Œå½“æ—¶ç‰¹åˆ«ç„¦è™‘"
å¼ ä¸‰: "æ˜¯å•Šï¼Œæˆ‘æ‡‚é‚£ç§æ„Ÿè§‰ã€‚æˆ‘ä»¬ä¸€èµ·ç ”ç©¶å§!"
â†’ åˆ†æ: æ·±å…¥äº¤æµ (+7)
â†’ å¥½æ„Ÿåº¦: 69 â†’ 76
```

**ç¬¬5æ¬¡å¯¹è¯**: çœŸè¯šæ„Ÿè°¢
```
ç©å®¶: "å¤ªæ„Ÿè°¢ä½ äº†ï¼Œä½ æ•™ä¼šäº†æˆ‘å¾ˆå¤š!"
å¼ ä¸‰: "ä¸å®¢æ°”!èƒ½å¸®åˆ°ä½ æˆ‘ä¹Ÿå¾ˆå¼€å¿ƒã€‚"
â†’ åˆ†æ: çœŸè¯šæ„Ÿè°¢ (+8)
â†’ å¥½æ„Ÿåº¦: 76 â†’ 84 (ç­‰çº§æå‡: äº²å¯† â†’ æŒšå‹)
```

**æœ€ç»ˆçŠ¶æ€**: å¥½æ„Ÿåº¦ = 84ï¼ˆæŒšå‹ï¼‰

**æ•°æ®ç»Ÿè®¡**:
- å¯¹è¯æ¬¡æ•°: 5æ¬¡
- æ€»å˜åŒ–: +34åˆ†
- ç­‰çº§è·¨è¶Š: å‹å¥½ â†’ äº²å¯† â†’ æŒšå‹
- å¹³å‡æ¯æ¬¡: +6.8åˆ†

---

### æ¡ˆä¾‹2: å¥½æ„Ÿåº¦ä¸‹é™ä¸æ¢å¤

**åˆå§‹çŠ¶æ€**: å¥½æ„Ÿåº¦ = 50ï¼ˆå‹å¥½ï¼‰

**ç¬¬1æ¬¡å¯¹è¯**: æ‰¹è¯„å·¥ä½œ
```
ç©å®¶: "ä½ è¿™ä»£ç å†™å¾—ä»€ä¹ˆç©æ„å„¿"
å¼ ä¸‰: "...æˆ‘ä¼šæ”¹è¿›çš„ã€‚"
â†’ åˆ†æ: æ‰¹è¯„å·¥ä½œ (-8)
â†’ å¥½æ„Ÿåº¦: 50 â†’ 42 (ä¿æŒå‹å¥½)
```

**ç¬¬2æ¬¡å¯¹è¯**: ç»§ç»­æ‰¹è¯„
```
ç©å®¶: "ä½ ä»¬äº§å“ç»ç†éƒ½ä¸é è°±"
æå››: "...æŠ±æ­‰ï¼Œæˆ‘ä¼šæ³¨æ„çš„ã€‚"
â†’ åˆ†æ: æ‰¹è¯„èŒä¸š (-10)
â†’ å¥½æ„Ÿåº¦: 50 â†’ 40 (ä¿æŒå‹å¥½ï¼Œä½†æ¥è¿‘è¾¹ç¼˜)
```

**ç¬¬3æ¬¡å¯¹è¯**: çœŸè¯šé“æ­‰
```
ç©å®¶: "å¯¹ä¸èµ·ï¼Œæˆ‘åˆšæ‰è¯´è¯å¤ªå†²äº†"
å¼ ä¸‰: "æ²¡å…³ç³»ï¼Œæˆ‘ç†è§£ã€‚"
â†’ åˆ†æ: çœŸè¯šé“æ­‰ (+5)
â†’ å¥½æ„Ÿåº¦: 42 â†’ 47
```

**ç¬¬4æ¬¡å¯¹è¯**: æ­£é¢äº’åŠ¨
```
ç©å®¶: "å…¶å®ä½ çš„ä»£ç è¿˜æ˜¯å¾ˆæœ‰æƒ³æ³•çš„"
å¼ ä¸‰: "è°¢è°¢ç†è§£!æˆ‘ä¼šç»§ç»­åŠªåŠ›ã€‚"
â†’ åˆ†æ: æ­£é¢è¯„ä»· (+6)
â†’ å¥½æ„Ÿåº¦: 47 â†’ 53 (æ¢å¤åˆ°åˆå§‹æ°´å¹³)
```

**å¯ç¤º**:
- âœ… è´Ÿé¢å½±å“å¯ä»¥é€šè¿‡æ­£é¢äº’åŠ¨æ¢å¤
- âœ… ç³»ç»Ÿå…è®¸ç©å®¶çŠ¯é”™å¹¶æ”¹æ­£
- âœ… çœŸè¯šé“æ­‰æ˜¯æœ‰æ•ˆçš„ä¿®å¤ç­–ç•¥

---

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### â­â­â­â­â­ å¿…é¡»æŒæ¡

1. **äº”çº§å¥½æ„Ÿåº¦ä½“ç³»**
   - æ¯ä¸ªç­‰çº§çš„åˆ†æ•°èŒƒå›´
   - å¯¹åº”çš„å¯¹è¯é£æ ¼
   - åˆå§‹å€¼è®¾è®¡ï¼ˆ50åˆ†ï¼‰

2. **analyze_and_update_affinity()æ–¹æ³•**
   - å®Œæ•´çš„6æ­¥æµç¨‹
   - LLMå¦‚ä½•åˆ†ææƒ…æ„Ÿ
   - å¥½æ„Ÿåº¦å¦‚ä½•æ›´æ–°

3. **é£æ ¼ä¿®é¥°è¯æœºåˆ¶**
   - get_affinity_modifier()
   - å¦‚ä½•å½±å“NPCå¯¹è¯
   - åœ¨agents.pyä¸­çš„åº”ç”¨

### â­â­â­â­ é‡ç‚¹ç†è§£

4. **æƒ…æ„Ÿåˆ†ææç¤ºè¯**
   - å››ä¸ªåˆ†æç»´åº¦
   - å˜åŒ–è§„åˆ™è®¾è®¡
   - ä¸ºä»€ä¹ˆç”¨è¿™äº›èŒƒå›´

5. **ä¸‰å±‚JSONè§£æ**
   - ä¸ºä»€ä¹ˆéœ€è¦å¤šå±‚å®¹é”™
   - æ­£åˆ™è¡¨è¾¾å¼çš„ä½œç”¨
   - å¥å£®æ€§è®¾è®¡

### â­â­â­ å»ºè®®äº†è§£

6. **å¤šç©å®¶æ”¯æŒ**
7. **åˆå§‹å€¼è®¾è®¡**
8. **ç­‰çº§è·¨åº¦è®¾è®¡**

---

## ğŸ¯ å®è·µç»ƒä¹ 

### ç»ƒä¹ 1: è°ƒæ•´å¥½æ„Ÿåº¦å˜åŒ–èŒƒå›´

```python
# åŸå§‹è§„åˆ™
"èµç¾ã€æ„Ÿè°¢ã€è¯·æ•™: +3 åˆ° +8"

# ä¿®æ”¹ä¸ºæ›´å®¹æ˜“æå‡
"èµç¾ã€æ„Ÿè°¢ã€è¯·æ•™: +5 åˆ° +12"
```

**æµ‹è¯•**: å¥½æ„Ÿåº¦æå‡é€Ÿåº¦å˜åŒ–

---

### ç»ƒä¹ 2: å¢åŠ ç¬¬6ä¸ªç­‰çº§

```python
def get_affinity_level(self, affinity: float) -> str:
    if affinity >= 90:
        return "çµé­‚ä¼´ä¾£"  # æ–°å¢
    elif affinity >= 75:
        return "æŒšå‹"
    elif affinity >= 55:
        return "äº²å¯†"
    # ...
```

---

### ç»ƒä¹ 3: æ·»åŠ å¥½æ„Ÿåº¦è¡°å‡æœºåˆ¶

```python
def apply_time_decay(self, days_inactive: int):
    """é•¿æ—¶é—´ä¸äº’åŠ¨ï¼Œå¥½æ„Ÿåº¦ç¼“æ…¢ä¸‹é™"""
    decay = days_inactive * 0.5  # æ¯å¤©-0.5
    for npc_name in self.affinity_scores:
        for player_id in self.affinity_scores[npc_name]:
            current = self.get_affinity(npc_name, player_id)
            new_affinity = max(30, current - decay)  # æœ€ä½é™åˆ°30
            self.set_affinity(npc_name, new_affinity, player_id)
```

---

## ğŸ“Š ä»£ç è´¨é‡è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| åˆ›æ–°æ€§ | â­â­â­â­â­ | LLMé©±åŠ¨çš„æƒ…æ„Ÿåˆ†æ |
| å¥å£®æ€§ | â­â­â­â­â­ | ä¸‰å±‚å®¹é”™è§£æ |
| å¯æ‰©å±•æ€§ | â­â­â­â­ | æ”¯æŒå¤šç©å®¶ï¼Œæ˜“è°ƒæ•´å‚æ•° |
| ç”¨æˆ·ä½“éªŒ | â­â­â­â­â­ | å¹³æ»‘è¿‡æ¸¡ï¼Œç¬¦åˆç›´è§‰ |
| æ€§èƒ½ | â­â­â­â­ | LLMè°ƒç”¨é€‚åº¦ |

**æ€»åˆ†**: 24/25 â­â­â­â­â­ (ä¼˜ç§€)

---

## ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆå¥½æ„Ÿåº¦ç³»ç»Ÿå­¦ä¹ åï¼Œå»ºè®®:

1. **batch_generator.py** - æ‰¹é‡ä¼˜åŒ–åŸç†
2. **å›é¡¾agents.py** - ç†è§£å¥½æ„Ÿåº¦å¦‚ä½•å½±å“å¯¹è¯
3. **å¯åŠ¨æ¸¸æˆæµ‹è¯•** - å®é™…ä½“éªŒå¥½æ„Ÿåº¦å˜åŒ–

---

**å­¦ä¹ å®Œæˆæ—¶é—´**: é¢„è®¡1-2å°æ—¶  
**å®è·µå»ºè®®**: å¯åŠ¨æ¸¸æˆåå°è¯•ä¸åŒå¯¹è¯æ–¹å¼  
**é‡ç‚¹**: ç†è§£LLMå¦‚ä½•åˆ†ææƒ…æ„Ÿï¼Œå¥½æ„Ÿåº¦å¦‚ä½•å½±å“å¯¹è¯
